<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcane EXAMS Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: 'rgb(var(--color-primary) / <alpha-value>)',
                        secondary: 'rgb(var(--color-secondary) / <alpha-value>)',
                        accent: 'rgb(var(--color-accent) / <alpha-value>)',
                        surface: 'rgb(var(--color-surface) / <alpha-value>)',
                        text: 'rgb(var(--color-text) / <alpha-value>)',
                        'text-muted': 'rgb(var(--color-text-muted) / <alpha-value>)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'pulse-glow': 'pulseGlow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'success-pop': 'successPop 0.5s ease-out both',
                        'select-pop': 'selectPop 0.3s ease-out forwards',
                        'typing': 'typing 1s steps(20, end)',
                        'loading-wave': 'loadingWave 1s ease-in-out infinite',
                        'bounce-soft': 'bounceSoft 0.5s ease-in-out',
                        'confetti-fall': 'confettiFall 5s linear forwards',
                        'badge-pop': 'badgePop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'progress-grow': 'progressGrow 1s ease-out forwards',
                        'history-entry': 'historyEntry 0.5s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } },
                        pop: { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        fadeInUp: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)', opacity: 1 },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-2px)', opacity: 1 },
                            '20%, 40%, 60%, 80%': { transform: 'translateX(2px)', opacity: 1 }
                        },
                        successPop: {
                            '0%': { transform: 'scale(1)', opacity: 1 },
                            '50%': { transform: 'scale(1.05)', opacity: 1 },
                            '100%': { transform: 'scale(1)', opacity: 1 }
                        },
                        selectPop: {
                            '0%': { transform: 'scale(1)', opacity: 1 },
                            '100%': { transform: 'scale(1.02)', opacity: 1 }
                        },
                        pulseGlow: { '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(var(--color-primary), 0.5)' }, '50%': { opacity: .8, boxShadow: '0 0 10px rgba(var(--color-primary), 0.2)' } },
                        typing: { 'from': { width: '0' }, 'to': { width: '100%' } },
                        loadingWave: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        },
                        confettiFall: {
                            '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: 1 },
                            '100%': { transform: 'translateY(100vh) rotate(360deg)', opacity: 0 }
                        },
                        badgePop: {
                            '0%': { transform: 'scale(0) rotate(-180deg)', opacity: 0 },
                            '70%': { transform: 'scale(1.1) rotate(10deg)', opacity: 1 },
                            '100%': { transform: 'scale(1) rotate(0deg)', opacity: 1 }
                        },
                        progressGrow: {
                            '0%': { width: '0%' },
                            '100%': { width: 'var(--target-width, 100%)' }
                        },
                        historyEntry: {
                            '0%': { transform: 'translateX(-20px)', opacity: 0 },
                            '100%': { transform: 'translateX(0)', opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --color-primary: 99 102 241; --color-secondary: 16 185 129; --color-accent: 236 72 153;
            --color-surface: 30 41 59; --color-text: 248 250 252; --color-text-muted: 148 163 184;
            --bg-grad-start: #0f172a; --bg-grad-end: #1e293b;
        }
        .light-mode {
            --color-primary: 79 70 229; --color-secondary: 5 150 105; --color-accent: 219 39 119;
            --color-surface: 255 255 255; --color-text: 15 23 42; --color-text-muted: 100 116 139;
            --bg-grad-start: #f8fafc; --bg-grad-end: #e2e8f0;
        }
        /* Themes */
        .theme-ocean { --color-primary: 14 165 233; --color-secondary: 45 212 191; --color-accent: 59 130 246; }
        .theme-sunset { --color-primary: 249 115 22; --color-secondary: 236 72 153; --color-accent: 239 68 68; }
        .theme-forest { --color-primary: 34 197 94; --color-secondary: 163 230 53; --color-accent: 20 184 166; }
        .theme-midnight { --color-primary: 139 92 246; --color-secondary: 236 72 153; --color-accent: 59 130 246; }
        .theme-aurora { --color-primary: 34 197 94; --color-secondary: 245 158 11; --color-accent: 239 68 68; }
        .theme-cotton-candy { --color-primary: 236 72 153; --color-secondary: 59 130 246; --color-accent: 245 158 11; }
        .theme-neon { --color-primary: 34 197 94; --color-secondary: 245 158 11; --color-accent: 236 72 153; }
        
        /* Custom Theme Support */
        .theme-custom {
            --color-primary: 99 102 241;
            --color-secondary: 16 185 129;
            --color-accent: 236 72 153;
        }

        body {
            background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
            color: rgb(var(--color-text));
            font-family: 'Inter', sans-serif;
            transition: background 0.5s ease, color 0.3s ease;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }
        
        /* Animated Background Mesh */
        .mesh-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(at 0% 0%, rgba(var(--color-primary), 0.15) 0px, transparent 50%),
                        radial-gradient(at 100% 0%, rgba(var(--color-accent), 0.15) 0px, transparent 50%),
                        radial-gradient(at 100% 100%, rgba(var(--color-secondary), 0.15) 0px, transparent 50%),
                        radial-gradient(at 0% 100%, rgba(var(--color-primary), 0.15) 0px, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Glassmorphism utility */
        .glass {
            background: rgba(var(--color-surface) / 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .light-mode .glass {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .glass-hover:hover {
            background: rgba(var(--color-surface) / 0.8);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Hardware acceleration */
        .hw-accel { transform: translate3d(0, 0, 0); backface-visibility: hidden; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(var(--color-text), 0.2); border-radius: 10px; }
        
        /* Range slider */
        input[type="range"] {
            -webkit-appearance: none; background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: rgb(var(--color-primary)); margin-top: -7px; box-shadow: 0 0 10px rgba(var(--color-primary), 0.5);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(var(--color-text), 0.1); border-radius: 2px;
        }
    </style>
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div class="mesh-bg"></div>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Clock, Moon, Sun, Upload, FileText, CheckCircle, Flag, ChevronLeft, ChevronRight, 
            LayoutGrid, Eye, Play, RotateCcw, Zap, LogOut, Check, Timer, HelpCircle, Trophy, 
            Sidebar, FileSpreadsheet, Home, XCircle, Users, Wifi, Copy, User, Settings, Shuffle, 
            ArrowDownToLine, Plus, Trash2, Edit2, Save, X, Sparkles, Volume2, VolumeX, BarChart3, 
            Target, Calendar, AlertTriangle, Download, Brain, Award, TrendingUp, BookOpen,
            Shield, Filter, Search, Grid, List, Star, Crown, Target as TargetIcon,
            FileDown, Printer, Share2, Bell, BellOff, Bookmark, RefreshCw,
            Mic, MicOff, Camera, CameraOff, Lock, Unlock, Zap as ZapIcon,
            BarChart, PieChart, LineChart, Cloud, WifiOff, Globe, Database,
            Cpu, FileCode, Video, MessageSquare, Users as UsersIcon,
            ClipboardCheck, Calculator, Lightbulb, Coffee, Rocket,
            ChevronDown, ChevronUp, Maximize2, Minimize2, MoreVertical,
            Palette, Droplets, PaintBucket, Brush, Sparkles as SparklesIcon,
            Gift, Medal, Target as TargetIcon2, Zap as ZapIcon2, Flame,
            TrendingUp as TrendingUpIcon, Award as AwardIcon, Crown as CrownIcon,
            History, Save as SaveIcon, FolderOpen, TrendingDown, BarChart2,
            Award as AwardIcon2, CalendarDays, Filter as FilterIcon,
            SortAsc, SortDesc, Clock as ClockIcon, Percent, Archive,
            HardDrive, ExternalLink, ChevronRight as ChevronRightIcon,
            Key, BarChart3 as BarChart3Icon
        } from 'lucide-react';

        // === UTILS ===
        
        const cn = (...classes) => classes.filter(Boolean).join(' ');
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // === Fixed Essay Evaluator ===
        class EssayEvaluator {
            constructor() {
                this.stopWords = new Set([
                    'a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for',
                    'of', 'with', 'by', 'is', 'was', 'are', 'were', 'be', 'been', 'being',
                    'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'shall',
                    'should', 'can', 'could', 'may', 'might', 'must', 'not', 'no', 'yes',
                    'it', 'its', 'it\'s', 'that', 'this', 'these', 'those', 'as', 'so',
                    'if', 'then', 'else', 'when', 'where', 'why', 'how', 'what', 'which',
                    'who', 'whom', 'whose', 'there', 'here', 'up', 'down', 'out', 'off',
                    'over', 'under', 'again', 'further', 'once', 'more', 'most', 'such',
                    'own', 'same', 'too', 'very', 'just', 'also', 'now', 'then', 'well',
                    'only', 'very', 'even', 'back', 'any', 'each', 'both', 'between',
                    'through', 'during', 'before', 'after', 'above', 'below', 'from'
                ]);
            }
            
            normalize(text) {
                if (!text || typeof text !== 'string') return '';
                return text
                    .toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            tokenize(text) {
                const normalized = this.normalize(text);
                if (!normalized) return [];
                return normalized.split(' ');
            }
            
            getKeyTerms(text) {
                const tokens = this.tokenize(text);
                return new Set(
                    tokens.filter(token => 
                        token.length > 2 && 
                        !this.stopWords.has(token) &&
                        !/^\d+$/.test(token)
                    ).map(token => {
                        // Simple stemming
                        let stemmed = token;
                        if (stemmed.endsWith('ing')) stemmed = stemmed.slice(0, -3);
                        else if (stemmed.endsWith('ed')) stemmed = stemmed.slice(0, -2);
                        else if (stemmed.endsWith('s') && !stemmed.endsWith('ss')) stemmed = stemmed.slice(0, -1);
                        else if (stemmed.endsWith('es')) stemmed = stemmed.slice(0, -2);
                        else if (stemmed.endsWith('ies')) stemmed = stemmed.slice(0, -3) + 'y';
                        else if (stemmed.endsWith('ly')) stemmed = stemmed.slice(0, -2);
                        else if (stemmed.endsWith('ment')) stemmed = stemmed.slice(0, -4);
                        return stemmed;
                    }).filter(term => term.length > 2)
                );
            }
            
            calculateSimilarity(text1, text2) {
                if (!text1 || !text2) return 0;
                
                const terms1 = this.getKeyTerms(text1);
                const terms2 = this.getKeyTerms(text2);
                
                if (terms1.size === 0 || terms2.size === 0) return 0;
                
                // Calculate Jaccard similarity
                const intersection = new Set([...terms1].filter(term => terms2.has(term)));
                const union = new Set([...terms1, ...terms2]);
                
                return intersection.size / union.size;
            }
            
            // Main function to evaluate essay answers
            evaluateEssayAnswer(studentAnswer, correctAnswer) {
                if (!studentAnswer || !correctAnswer) return false;
                
                // Check for minimum length
                if (studentAnswer.trim().length < 20) return false;
                
                // Calculate similarity score
                const similarity = this.calculateSimilarity(studentAnswer, correctAnswer);
                
                // Check key terms coverage
                const studentTerms = this.getKeyTerms(studentAnswer);
                const correctTerms = this.getKeyTerms(correctAnswer);
                
                if (studentTerms.size === 0 || correctTerms.size === 0) return false;
                
                const intersection = new Set([...studentTerms].filter(term => correctTerms.has(term)));
                const coverage = intersection.size / correctTerms.size;
                
                // Consider answer correct if it has reasonable similarity or coverage
                // Lower thresholds for more lenient grading
                return similarity > 0.2 || coverage > 0.3;
            }
            
            // Get detailed essay score (0-100)
            getEssayScore(studentAnswer, correctAnswer) {
                if (!studentAnswer || !correctAnswer) return 0;
                
                const similarity = this.calculateSimilarity(studentAnswer, correctAnswer);
                
                // Check key terms coverage
                const studentTerms = this.getKeyTerms(studentAnswer);
                const correctTerms = this.getKeyTerms(correctAnswer);
                
                if (studentTerms.size === 0 || correctTerms.size === 0) return 0;
                
                const intersection = new Set([...studentTerms].filter(term => correctTerms.has(term)));
                const coverage = intersection.size / Math.max(correctTerms.size, 1);
                
                // Combine similarity and coverage for base score
                let baseScore = (similarity * 0.4 + coverage * 0.6) * 100;
                
                // Length bonus (encourage thorough answers)
                const lengthScore = Math.min(studentAnswer.length / 150, 25); // Max 25% bonus
                
                // Structure bonus (check for paragraphs)
                const hasParagraphs = (studentAnswer.match(/\n\n/g) || []).length >= 1;
                const structureBonus = hasParagraphs ? 5 : 0;
                
                const totalScore = Math.min(baseScore + lengthScore + structureBonus, 100);
                
                return Math.round(totalScore);
            }
            
            // Get detailed feedback for essay
            getEssayFeedback(studentAnswer, correctAnswer) {
                const score = this.getEssayScore(studentAnswer, correctAnswer);
                
                let grade = '';
                let feedback = '';
                
                if (score >= 90) {
                    grade = 'Excellent';
                    feedback = 'Outstanding answer! Covers all key concepts with excellent explanation and structure.';
                } else if (score >= 80) {
                    grade = 'Very Good';
                    feedback = 'Strong answer. Covers most key points with good detail and organization.';
                } else if (score >= 70) {
                    grade = 'Good';
                    feedback = 'Good effort. Covers main concepts but could use more depth or examples.';
                } else if (score >= 60) {
                    grade = 'Satisfactory';
                    feedback = 'Addresses the question but misses some important points or lacks detail.';
                } else if (score >= 50) {
                    grade = 'Needs Improvement';
                    feedback = 'Partially correct but missing major concepts or sufficient explanation.';
                } else {
                    grade = 'Poor';
                    feedback = 'Does not adequately address the question. Please review the topic thoroughly.';
                }
                
                // Identify key terms from correct answer
                const correctTerms = Array.from(this.getKeyTerms(correctAnswer));
                const studentTerms = Array.from(this.getKeyTerms(studentAnswer));
                const missingTerms = correctTerms.filter(term => !studentTerms.includes(term));
                
                return {
                    score,
                    grade,
                    feedback,
                    studentKeyTerms: studentTerms.slice(0, 10), // Top 10 terms from student
                    missingKeyTerms: missingTerms.slice(0, 5), // Top 5 missing terms
                    length: studentAnswer.length,
                    hasParagraphs: (studentAnswer.match(/\n\n/g) || []).length >= 1
                };
            }
            
            // Simple pass/fail check for MCQ compatibility
            isCorrect(studentAnswer, correctAnswer, isEssay = false) {
                if (!studentAnswer || !correctAnswer) return false;
                
                if (isEssay) {
                    return this.evaluateEssayAnswer(studentAnswer, correctAnswer);
                } else {
                    // For MCQ, use exact or prefix matching
                    return studentAnswer === correctAnswer || 
                           studentAnswer.startsWith(correctAnswer) ||
                           correctAnswer.startsWith(studentAnswer);
                }
            }
        }

        // Create global instance
        const essayEvaluator = new EssayEvaluator();

        // === Sound Manager ===
        class SoundManager {
            constructor() {
                this.ctx = null;
                this.enabled = true;
                if (typeof window !== 'undefined') {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (AudioCtx) this.ctx = new AudioCtx();
                }
            }
            playTone(freq, type, duration, vol = 0.1) {
                if (!this.enabled || !this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                } catch (e) {}
            }
            click() { this.playTone(600, 'sine', 0.1, 0.05); }
            success() { this.playTone(500, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(800, 'sine', 0.2, 0.1), 100); }
            error() { this.playTone(300, 'sawtooth', 0.15, 0.08); setTimeout(() => this.playTone(200, 'sawtooth', 0.15, 0.08), 100); }
            start() { this.playTone(400, 'triangle', 0.1); setTimeout(() => this.playTone(600, 'triangle', 0.4), 100); }
        }
        const sfx = new SoundManager();

        // === Fire Confetti ===
        const fireConfetti = () => {
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            for(let i=0; i<150; i++) {
                const el = document.createElement('div');
                el.style.position = 'fixed';
                el.style.left = '50%';
                el.style.top = '50%';
                el.style.width = '8px';
                el.style.height = '8px';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`;
                el.style.zIndex = '9999';
                el.style.pointerEvents = 'none';
                document.body.appendChild(el);
                const angle = Math.random() * Math.PI * 2;
                const velocity = 8 + Math.random() * 12;
                const tx = Math.cos(angle) * velocity * 25;
                const ty = Math.sin(angle) * velocity * 25;
                el.animate([
                    { transform: `translate(-50%, -50%) scale(1)`, opacity: 1 }, 
                    { transform: `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0)`, opacity: 0 }
                ], { 
                    duration: 1200 + Math.random() * 800, 
                    easing: 'cubic-bezier(0.25, 1, 0.5, 1)' 
                }).onfinish = () => el.remove();
            }
        };

        // === NEW: Copy AI Template Function ===
        const copyAITemplate = () => {
            const template = `Generate exam questions with this CSV format:
ID;Question;Options(separated by |);Answer;Image;Explanation;Category;Difficulty
Example:
1;What is the capital of France?;London|Berlin|Paris|Madrid;Paris;;Paris is the capital and most populous city of France.;Geography;Easy
2;Explain quantum physics;ESSAY;Quantum physics is...;;Quantum physics explains nature at atomic and subatomic levels.;Physics;Hard

Please generate diverse questions on various topics with different difficulty levels.`;
            
            navigator.clipboard.writeText(template)
                .then(() => {
                    alert("AI prompt copied to clipboard! You can now paste it into ChatGPT or similar AI tools.");
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    alert("Failed to copy to clipboard. Please copy manually.");
                });
        };

        // === NEW: PDF Export Function ===
        const exportToPDF = (title, data) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246);
            doc.text(title, 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            let yPos = 50;
            data.forEach((item, index) => {
                if (yPos > 280) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.setTextColor(30, 41, 59);
                doc.text(`${index + 1}. ${item.question}`, 20, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.setTextColor(100, 116, 139);
                doc.text(`Your Answer: ${item.yourAnswer}`, 20, yPos);
                yPos += 7;
                doc.text(`Correct Answer: ${item.correctAnswer}`, 20, yPos);
                yPos += 7;
                doc.text(`Status: ${item.correct ? '✓ Correct' : '✗ Incorrect'}`, 20, yPos);
                yPos += 15;
            });
            
            doc.save(`${title.replace(/\s+/g, '_')}_${Date.now()}.pdf`);
        };

        // === NEW: AI Question Generator (Real OpenAI API) ===
        const generateAIQuestions = async (topic, difficulty, count, apiKey = null) => {
            if (!apiKey) {
                // Mock fallback if no API key
                const mockQuestions = [
                    {
                        id: `ai_${Date.now()}_1`,
                        text: `AI Generated: Explain the concept of ${topic} in your own words.`,
                        options: [],
                        correctAnswer: `A comprehensive explanation of ${topic} including key principles and applications.`,
                        explanation: `This question tests understanding of ${topic}. A good answer should cover key concepts, principles, and practical applications.`,
                        isEssay: true,
                        category: topic,
                        difficulty: difficulty
                    },
                    {
                        id: `ai_${Date.now()}_2`,
                        text: `AI Generated: Which of these is most closely related to ${topic}?`,
                        options: [
                            `A) Fundamental principle of ${topic}`,
                            `B) Advanced application of ${topic}`,
                            `C) Historical development of ${topic}`,
                            `D) Related but distinct concept`
                        ],
                        correctAnswer: `A) Fundamental principle of ${topic}`,
                        explanation: `The fundamental principle is most directly related as it forms the core understanding of ${topic}. Other options are related but not the closest connection.`,
                        isEssay: false,
                        category: topic,
                        difficulty: difficulty
                    }
                ];
                
                await sleep(1500);
                return mockQuestions.slice(0, count);
            }

            // Real OpenAI API call
            try {
                const prompt = `Generate ${count} ${difficulty.toLowerCase()} difficulty exam questions about ${topic} in this exact CSV format:
ID;Question;Options(separated by |);Answer;Image;Explanation;Category;Difficulty
Rules:
1. Include a mix of multiple-choice and essay questions
2. Make explanations educational and clear
3. Use appropriate categories
4. Format options with letters (A) (B) (C) (D)
5. For essay questions, write "ESSAY" in options column`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const aiText = data.choices[0].message.content;
                
                // Parse the CSV response
                const lines = aiText.split('\n').filter(line => line.trim() && !line.toLowerCase().includes('id;question'));
                
                const questions = lines.slice(0, count).map((line, index) => {
                    const cols = line.split(';').map(c => c.trim());
                    if (cols.length < 2) return null;
                    
                    const id = cols[0] || `ai_${Date.now()}_${index}`;
                    const text = cols[1];
                    const optionsRaw = cols[2] || '';
                    const correctAnswer = cols[3] || '';
                    const imageUrl = cols[4] || undefined;
                    const explanation = cols[5] || '';
                    const category = cols[6] || topic;
                    const difficultyLevel = cols[7] || difficulty;
                    
                    let options = [];
                    let isEssay = false;
                    
                    if (optionsRaw.toUpperCase() === 'ESSAY' || !optionsRaw) {
                        isEssay = true;
                    } else {
                        options = optionsRaw.includes('|') 
                            ? optionsRaw.split('|').map(o => o.trim())
                            : optionsRaw.split(',').map(o => o.trim());
                    }
                    
                    return {
                        id,
                        text,
                        options,
                        correctAnswer,
                        imageUrl,
                        explanation,
                        isEssay,
                        category,
                        difficulty: difficultyLevel
                    };
                }).filter(q => q !== null);

                return questions;
            } catch (error) {
                console.error('OpenAI API Error:', error);
                throw error;
            }
        };

        // === NEW: Exam History Storage System ===
        class ExamHistoryManager {
            constructor() {
                this.key = 'exam_history';
                this.maxEntries = 100; // Limit history size
                this.history = this.loadHistory();
            }
            
            loadHistory() {
                try {
                    const stored = localStorage.getItem(this.key);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        // Ensure we have the right structure
                        if (Array.isArray(parsed)) {
                            return parsed;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load exam history:', error);
                }
                return [];
            }
            
            saveHistory() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.history));
                } catch (error) {
                    console.error('Failed to save exam history:', error);
                }
            }
            
            addExam(examData) {
                const examRecord = {
                    id: `exam_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: new Date().toISOString(),
                    title: examData.title || `Exam ${new Date().toLocaleDateString()}`,
                    questions: examData.questions || [],
                    userAnswers: examData.userAnswers || {},
                    settings: examData.settings || {},
                    score: examData.score || 0,
                    totalQuestions: examData.totalQuestions || 0,
                    timeSpent: examData.timeSpent || 0,
                    categories: examData.categories || [],
                    difficultyBreakdown: examData.difficultyBreakdown || {},
                    accuracy: examData.accuracy || 0
                };
                
                // Add to beginning (most recent first)
                this.history.unshift(examRecord);
                
                // Limit history size
                if (this.history.length > this.maxEntries) {
                    this.history = this.history.slice(0, this.maxEntries);
                }
                
                this.saveHistory();
                return examRecord;
            }
            
            getExamById(id) {
                return this.history.find(exam => exam.id === id);
            }
            
            getFilteredHistory(filters = {}) {
                let filtered = [...this.history];
                
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    filtered = filtered.filter(exam => 
                        exam.title.toLowerCase().includes(searchTerm) ||
                        exam.categories.some(cat => cat.toLowerCase().includes(searchTerm))
                    );
                }
                
                if (filters.startDate) {
                    filtered = filtered.filter(exam => new Date(exam.timestamp) >= new Date(filters.startDate));
                }
                
                if (filters.endDate) {
                    const endDate = new Date(filters.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(exam => new Date(exam.timestamp) <= endDate);
                }
                
                if (filters.minScore !== undefined) {
                    filtered = filtered.filter(exam => exam.accuracy >= filters.minScore);
                }
                
                if (filters.category) {
                    filtered = filtered.filter(exam => 
                        exam.categories.some(cat => cat.toLowerCase() === filters.category.toLowerCase())
                    );
                }
                
                // Sort
                if (filters.sortBy === 'date') {
                    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else if (filters.sortBy === 'score') {
                    filtered.sort((a, b) => b.accuracy - a.accuracy);
                } else if (filters.sortBy === 'time') {
                    filtered.sort((a, b) => a.timeSpent - b.timeSpent);
                }
                
                return filtered;
            }
            
            deleteExam(id) {
                const index = this.history.findIndex(exam => exam.id === id);
                if (index !== -1) {
                    this.history.splice(index, 1);
                    this.saveHistory();
                    return true;
                }
                return false;
            }
            
            clearAllHistory() {
                this.history = [];
                this.saveHistory();
            }
            
            getStats() {
                if (this.history.length === 0) {
                    return {
                        totalExams: 0,
                        averageScore: 0,
                        totalTimeSpent: 0,
                        totalQuestionsAnswered: 0,
                        bestScore: 0,
                        recentTrend: 'none'
                    };
                }
                
                const totalScore = this.history.reduce((sum, exam) => sum + exam.accuracy, 0);
                const totalTime = this.history.reduce((sum, exam) => sum + exam.timeSpent, 0);
                const totalQuestions = this.history.reduce((sum, exam) => sum + exam.totalQuestions, 0);
                
                // Calculate recent trend (last 5 exams vs previous 5)
                let recentTrend = 'stable';
                if (this.history.length >= 10) {
                    const recent = this.history.slice(0, 5);
                    const previous = this.history.slice(5, 10);
                    const recentAvg = recent.reduce((sum, exam) => sum + exam.accuracy, 0) / recent.length;
                    const previousAvg = previous.reduce((sum, exam) => sum + exam.accuracy, 0) / previous.length;
                    
                    if (recentAvg > previousAvg + 5) recentTrend = 'improving';
                    else if (recentAvg < previousAvg - 5) recentTrend = 'declining';
                }
                
                return {
                    totalExams: this.history.length,
                    averageScore: Math.round(totalScore / this.history.length),
                    totalTimeSpent: totalTime,
                    totalQuestionsAnswered: totalQuestions,
                    bestScore: Math.max(...this.history.map(exam => exam.accuracy)),
                    recentTrend
                };
            }
            
            getCategoryStats() {
                const categoryStats = {};
                
                this.history.forEach(exam => {
                    exam.categories.forEach(category => {
                        if (!categoryStats[category]) {
                            categoryStats[category] = {
                                count: 0,
                                totalScore: 0,
                                totalQuestions: 0
                            };
                        }
                        categoryStats[category].count++;
                        categoryStats[category].totalScore += exam.accuracy;
                        categoryStats[category].totalQuestions += exam.totalQuestions;
                    });
                });
                
                return Object.entries(categoryStats).map(([category, stats]) => ({
                    category,
                    examCount: stats.count,
                    averageScore: Math.round(stats.totalScore / stats.count),
                    totalQuestions: stats.totalQuestions
                })).sort((a, b) => b.examCount - a.examCount);
            }
        }

        // === NEW: Performance Analytics (Fixed for essays) ===
        const calculateAnalytics = (questions, answers) => {
            const analytics = {
                byCategory: {},
                byDifficulty: {},
                timePerQuestion: {},
                accuracy: 0,
                weakAreas: [],
                strongAreas: [],
                totalQuestions: questions.length,
                answeredQuestions: 0,
                unansweredQuestions: 0,
                averageTimePerQuestion: 0,
                scoreDistribution: {
                    excellent: 0, // 90-100%
                    good: 0,      // 70-89%
                    average: 0,   // 50-69%
                    poor: 0       // 0-49%
                },
                totalScore: 0,
                correctCount: 0
            };
            
            let correctCount = 0;
            let totalTimeSpent = 0;
            let answeredCount = 0;
            let totalScore = 0;
            
            questions.forEach((q, idx) => {
                const userAns = answers[idx];
                const isAnswered = userAns !== undefined && userAns !== '';
                
                // Calculate correctness based on question type
                let isCorrect = false;
                let questionScore = 0;
                
                if (isAnswered) {
                    answeredCount++;
                    
                    if (q.isEssay) {
                        // Use essay evaluator for essays
                        isCorrect = essayEvaluator.evaluateEssayAnswer(userAns, q.correctAnswer);
                        questionScore = essayEvaluator.getEssayScore(userAns, q.correctAnswer);
                        if (questionScore >= 60) {
                            correctCount++;
                        }
                        totalScore += questionScore;
                    } else {
                        // Use exact match for MCQ
                        isCorrect = essayEvaluator.isCorrect(userAns, q.correctAnswer, false);
                        if (isCorrect) {
                            correctCount++;
                            questionScore = 100;
                            totalScore += 100;
                        }
                    }
                    
                    // Track time per question (simulated - in real app, track actual time)
                    const timeSpent = Math.random() * 120 + 30; // Simulated 30-150 seconds
                    totalTimeSpent += timeSpent;
                    analytics.timePerQuestion[idx] = Math.round(timeSpent);
                }
                
                // Category analysis
                if (q.category) {
                    if (!analytics.byCategory[q.category]) {
                        analytics.byCategory[q.category] = { 
                            total: 0, 
                            correct: 0, 
                            incorrect: 0,
                            unanswered: 0,
                            averageTime: 0,
                            times: [],
                            totalScore: 0
                        };
                    }
                    analytics.byCategory[q.category].total++;
                    if (isAnswered) {
                        if (isCorrect || (q.isEssay && questionScore >= 60)) {
                            analytics.byCategory[q.category].correct++;
                            analytics.byCategory[q.category].totalScore += questionScore;
                        } else {
                            analytics.byCategory[q.category].incorrect++;
                        }
                    } else {
                        analytics.byCategory[q.category].unanswered++;
                    }
                }
                
                // Difficulty analysis
                if (q.difficulty) {
                    if (!analytics.byDifficulty[q.difficulty]) {
                        analytics.byDifficulty[q.difficulty] = { 
                            total: 0, 
                            correct: 0,
                            incorrect: 0,
                            unanswered: 0,
                            totalScore: 0
                        };
                    }
                    analytics.byDifficulty[q.difficulty].total++;
                    if (isAnswered) {
                        if (isCorrect || (q.isEssay && questionScore >= 60)) {
                            analytics.byDifficulty[q.difficulty].correct++;
                            analytics.byDifficulty[q.difficulty].totalScore += questionScore;
                        } else {
                            analytics.byDifficulty[q.difficulty].incorrect++;
                        }
                    } else {
                        analytics.byDifficulty[q.difficulty].unanswered++;
                    }
                }
            });
            
            analytics.answeredQuestions = answeredCount;
            analytics.unansweredQuestions = questions.length - answeredCount;
            analytics.correctCount = correctCount;
            analytics.totalScore = totalScore;
            analytics.accuracy = Math.round((correctCount / Math.max(answeredCount, 1)) * 100);
            analytics.averageTimePerQuestion = Math.round(totalTimeSpent / Math.max(answeredCount, 1));
            
            // Calculate score distribution
            const categories = Object.keys(analytics.byCategory);
            categories.forEach(category => {
                const data = analytics.byCategory[category];
                if (data.total > 0) {
                    const accuracy = Math.round((data.correct / data.total) * 100);
                    if (accuracy >= 90) analytics.scoreDistribution.excellent++;
                    else if (accuracy >= 70) analytics.scoreDistribution.good++;
                    else if (accuracy >= 50) analytics.scoreDistribution.average++;
                    else analytics.scoreDistribution.poor++;
                }
            });
            
            // Identify weak/strong areas
            Object.entries(analytics.byCategory).forEach(([category, data]) => {
                const accuracy = Math.round((data.correct / data.total) * 100);
                const avgScore = Math.round(data.totalScore / data.correct) || 0;
                
                if (accuracy < 60 || avgScore < 60) analytics.weakAreas.push({
                    category,
                    accuracy,
                    avgScore,
                    total: data.total,
                    correct: data.correct
                });
                if (accuracy > 85 && avgScore > 80) analytics.strongAreas.push({
                    category,
                    accuracy,
                    avgScore,
                    total: data.total,
                    correct: data.correct
                });
            });
            
            // Sort by accuracy
            analytics.weakAreas.sort((a, b) => a.accuracy - b.accuracy);
            analytics.strongAreas.sort((a, b) => b.accuracy - a.accuracy);
            
            return analytics;
        };

        // === NEW: Study Scheduler (Spaced Repetition) ===
        class StudyScheduler {
            constructor() {
                this.schedule = JSON.parse(localStorage.getItem('study_schedule') || '{}');
            }
            
            scheduleReview(questionId, difficulty) {
                const intervals = {
                    'easy': [1, 3, 7, 21], // days
                    'medium': [1, 2, 5, 14],
                    'hard': [1, 1, 3, 7, 21]
                };
                
                const today = new Date();
                const reviewDates = intervals[difficulty || 'medium'].map(days => {
                    const date = new Date(today);
                    date.setDate(date.getDate() + days);
                    return date.toISOString().split('T')[0];
                });
                
                this.schedule[questionId] = {
                    nextReview: reviewDates[0],
                    allReviews: reviewDates,
                    currentInterval: 0,
                    lastReviewed: today.toISOString()
                };
                
                this.save();
            }
            
            getDueReviews() {
                const today = new Date().toISOString().split('T')[0];
                return Object.entries(this.schedule)
                    .filter(([_, data]) => data.nextReview <= today)
                    .map(([id, _]) => id);
            }
            
            save() {
                localStorage.setItem('study_schedule', JSON.stringify(this.schedule));
            }
        }

        // === NEW: Question Bank Manager ===
        class QuestionBankManager {
            constructor() {
                this.key = 'question_bank';
                this.bank = this.loadBank();
            }
            
            loadBank() {
                try {
                    const stored = localStorage.getItem(this.key);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Failed to load question bank:', error);
                    return [];
                }
            }
            
            saveBank() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.bank));
                } catch (error) {
                    console.error('Failed to save question bank:', error);
                }
            }
            
            addQuestion(question) {
                // Check for duplicates
                const exists = this.bank.some(q => 
                    q.text === question.text && 
                    q.category === question.category
                );
                
                if (!exists) {
                    question.id = `bank_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    question.addedAt = new Date().toISOString();
                    this.bank.push(question);
                    this.saveBank();
                    return true;
                }
                return false;
            }
            
            addQuestions(questions) {
                let addedCount = 0;
                questions.forEach(q => {
                    if (this.addQuestion(q)) {
                        addedCount++;
                    }
                });
                return addedCount;
            }
            
            getQuestions(filters = {}) {
                let filtered = [...this.bank];
                
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    filtered = filtered.filter(q => 
                        q.text.toLowerCase().includes(searchTerm) ||
                        q.category?.toLowerCase().includes(searchTerm) ||
                        q.explanation?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filters.category) {
                    filtered = filtered.filter(q => q.category === filters.category);
                }
                
                if (filters.difficulty) {
                    filtered = filtered.filter(q => q.difficulty === filters.difficulty);
                }
                
                if (filters.type === 'essay') {
                    filtered = filtered.filter(q => q.isEssay);
                } else if (filters.type === 'mcq') {
                    filtered = filtered.filter(q => !q.isEssay);
                }
                
                // Sort
                if (filters.sortBy === 'date') {
                    filtered.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
                } else if (filters.sortBy === 'category') {
                    filtered.sort((a, b) => (a.category || '').localeCompare(b.category || ''));
                } else if (filters.sortBy === 'difficulty') {
                    const difficultyOrder = { 'Easy': 1, 'Medium': 2, 'Hard': 3 };
                    filtered.sort((a, b) => (difficultyOrder[a.difficulty] || 4) - (difficultyOrder[b.difficulty] || 4));
                }
                
                return filtered;
            }
            
            getCategories() {
                const categories = new Set();
                this.bank.forEach(q => {
                    if (q.category) categories.add(q.category);
                });
                return Array.from(categories).sort();
            }
            
            deleteQuestion(id) {
                const index = this.bank.findIndex(q => q.id === id);
                if (index !== -1) {
                    this.bank.splice(index, 1);
                    this.saveBank();
                    return true;
                }
                return false;
            }
            
            clearBank() {
                this.bank = [];
                this.saveBank();
            }
            
            getStats() {
                return {
                    totalQuestions: this.bank.length,
                    categories: this.getCategories().length,
                    mcqCount: this.bank.filter(q => !q.isEssay).length,
                    essayCount: this.bank.filter(q => q.isEssay).length,
                    byDifficulty: {
                        Easy: this.bank.filter(q => q.difficulty === 'Easy').length,
                        Medium: this.bank.filter(q => q.difficulty === 'Medium').length,
                        Hard: this.bank.filter(q => q.difficulty === 'Hard').length
                    }
                };
            }
        }

        const SAMPLE_CSV = `1;What is 2+2?;A) 2|B) 3|C) 4|D) 5;C) 4;;The sum of 2 and 2 is 4. This is basic arithmetic.;Math;Easy
2;Capital of France?;A) London|B) Berlin|C) Paris|D) Madrid;C) Paris;;Paris is the capital and most populous city of France.;Geography;Easy
3;Explain gravity;ESSAY;Gravity is a force that attracts objects with mass toward each other. It's responsible for keeping planets in orbit and objects on Earth's surface.;;Gravity is a fundamental force that attracts two bodies toward each other.;Physics;Hard
4;Earth is round?;A) True|B) False;A) True;;Scientific evidence confirms Earth is an oblate spheroid.;Science;Easy
5;Largest planet?;A) Earth|B) Mars|C) Jupiter;C) Jupiter;;Jupiter is the largest planet in our solar system.;Astronomy;Medium
6;Chemical symbol for Gold?;A) Au|B) Ag|C) Fe;A) Au;;Au comes from Latin 'aurum' meaning gold.;Chemistry;Medium`;

        const parseCSV = (text) => {
            const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
            const questions = [];
            let startIndex = 0;
            if (lines.length > 0) {
                const firstLineLower = lines[0].toLowerCase();
                if (firstLineLower.startsWith('id') || firstLineLower.startsWith('question')) startIndex = 1;
            }
            for (let i = startIndex; i < lines.length; i++) {
                const cols = lines[i].split(';').map(c => c.trim());
                if (cols.length < 2) continue;
                const id = cols[0];
                const text = cols[1];
                const optionsRaw = cols[2] || '';
                const correctAnswer = cols[3] || '';
                const imageUrl = cols[4] || undefined;
                const explanation = cols[5] || ''; // NEW: Explanation column
                const category = cols[6] || 'General';
                const difficulty = cols[7] || 'Medium';
                let options = [];
                let isEssay = false;
                if (optionsRaw.toUpperCase() === 'ESSAY' || !optionsRaw) {
                    isEssay = true;
                } else {
                    options = optionsRaw.includes('|') ? optionsRaw.split('|').map(o => o.trim()) : optionsRaw.split(',').map(o => o.trim());
                }
                questions.push({ 
                    id, 
                    text, 
                    options, 
                    correctAnswer, 
                    imageUrl, 
                    explanation, // NEW: Store explanation
                    isEssay, 
                    category, 
                    difficulty 
                });
            }
            return questions;
        };

        const parseExcel = async (file) => {
            return new Promise((resolve, reject) => {
                if (typeof XLSX === 'undefined') { reject(new Error("XLSX library not loaded")); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        const questions = [];
                        let startIndex = (jsonData.length > 0 && String(jsonData[0][0]).toLowerCase().includes('id')) ? 1 : 0;
                        for (let i = startIndex; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length < 2) continue;
                            const id = String(row[0] || i);
                            const text = String(row[1] || '');
                            const optionsRaw = String(row[2] || '');
                            const correctAnswer = String(row[3] || '');
                            const imageUrl = row[4] ? String(row[4]) : undefined;
                            const explanation = row[5] ? String(row[5]) : ''; // NEW: Explanation column
                            const category = row[6] ? String(row[6]) : 'General';
                            const difficulty = row[7] ? String(row[7]) : 'Medium';
                            let options = [];
                            let isEssay = false;
                            if (optionsRaw.toUpperCase() === 'ESSAY' || !optionsRaw) {
                                isEssay = true;
                            } else {
                                options = optionsRaw.includes('|') ? optionsRaw.split('|').map(o => o.trim()) : optionsRaw.split(',').map(o => o.trim());
                            }
                            if (text) questions.push({ 
                                id, 
                                text, 
                                options, 
                                correctAnswer, 
                                imageUrl, 
                                explanation, 
                                isEssay, 
                                category, 
                                difficulty 
                            });
                        }
                        resolve(questions);
                    } catch (err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        };

        // === NEW: Voice-to-Text Manager ===
        class VoiceToTextManager {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.transcript = '';
                this.onTranscript = null;
                this.onError = null;
                this.onEnd = null;
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                        
                        this.transcript = finalTranscript || interimTranscript;
                        
                        if (this.onTranscript) {
                            this.onTranscript(this.transcript, interimTranscript);
                        }
                    };
                    
                    this.recognition.onerror = (event) => {
                        this.isListening = false;
                        if (this.onError) {
                            this.onError(event.error);
                        }
                    };
                    
                    this.recognition.onend = () => {
                        this.isListening = false;
                        if (this.onEnd) {
                            this.onEnd();
                        }
                    };
                }
            }
            
            start() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                        this.isListening = true;
                        return true;
                    } catch (error) {
                        console.error('Speech recognition error:', error);
                        return false;
                    }
                }
                return false;
            }
            
            stop() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                }
            }
            
            toggle() {
                if (this.isListening) {
                    this.stop();
                } else {
                    this.start();
                }
            }
            
            setLanguage(lang) {
                if (this.recognition) {
                    this.recognition.lang = lang;
                }
            }
            
            isAvailable() {
                return !!this.recognition;
            }
        }

        // Initialize managers
        const examHistoryManager = new ExamHistoryManager();
        const questionBankManager = new QuestionBankManager();
        const voiceToTextManager = new VoiceToTextManager();

        // === NEW: Gamification System ===
        class GamificationManager {
            constructor() {
                this.key = 'gamification_data';
                this.data = this.loadData();
                this.achievements = [
        // ================= TIER 1: BEGINNER (Easy - 15 badges) =================
        { id: 'first_login', name: 'Welcome Aboard', description: 'Log in for the first time', icon: '👋', points: 10, tier: 1 },
        { id: 'first_exam', name: 'First Steps', description: 'Complete your first exam', icon: '👣', points: 20, tier: 1 },
        { id: 'answer_10_questions', name: 'Curious Learner', description: 'Answer 10 questions total', icon: '❓', points: 15, tier: 1 },
        { id: 'use_dark_mode', name: 'Night Vision', description: 'Enable dark mode', icon: '🌙', points: 10, tier: 1 },
        { id: 'use_light_mode', name: 'Day Walker', description: 'Enable light mode', icon: '☀️', points: 10, tier: 1 },
        { id: 'first_mcq', name: 'Multiple Choice Pro', description: 'Answer first MCQ correctly', icon: '🔘', points: 15, tier: 1 },
        { id: 'first_essay', name: 'Essay Writer', description: 'Complete first essay question', icon: '✍️', points: 15, tier: 1 },
        { id: 'upload_first', name: 'File Master', description: 'Upload your first CSV file', icon: '📤', points: 20, tier: 1 },
        { id: 'paste_first', name: 'Copy-Paste Expert', description: 'Paste questions for the first time', icon: '📋', points: 15, tier: 1 },
        { id: 'create_first', name: 'Creator', description: 'Create first custom question', icon: '🛠️', points: 25, tier: 1 },
        { id: 'save_first', name: 'Collector', description: 'Save first question to bank', icon: '💾', points: 20, tier: 1 },
        { id: 'flag_first', name: 'Marker', description: 'Flag your first question', icon: '🚩', points: 10, tier: 1 },
        { id: 'use_timer', name: 'Time Keeper', description: 'Complete exam with timer on', icon: '⏱️', points: 15, tier: 1 },
        { id: 'first_category', name: 'Subject Explorer', description: 'Complete exam in any category', icon: '📖', points: 20, tier: 1 },
        { id: 'view_analytics', name: 'Analyst', description: 'View analytics for first time', icon: '📊', points: 15, tier: 1 },

        // ================= TIER 2: INTERMEDIATE (Medium - 15 badges) =================
        { id: 'streak_3', name: 'Consistent Learner', description: '3-day study streak', icon: '🔥', points: 50, tier: 2 },
        { id: 'perfect_score_easy', name: 'Easy Perfect', description: 'Score 100% on Easy difficulty exam', icon: '⭐', points: 40, tier: 2 },
        { id: 'category_explorer', name: 'Category Explorer', description: 'Complete exams in 5 different categories', icon: '🗺️', points: 60, tier: 2 },
        { id: 'question_master_50', name: 'Question Master', description: 'Answer 50 questions correctly', icon: '🎯', points: 50, tier: 2 },
        { id: 'speed_demon', name: 'Speed Runner', description: 'Complete exam in half the time', icon: '⚡', points: 55, tier: 2 },
        { id: 'flag_master', name: 'Flag Master', description: 'Flag 20 questions in total', icon: '🚩', points: 40, tier: 2 },
        { id: 'no_errors', name: 'Flawless Run', description: 'Complete exam without wrong answers', icon: '💎', points: 60, tier: 2 },
        { id: 'all_categories', name: 'Category Collector', description: 'Touch questions from 10 categories', icon: '📚', points: 70, tier: 2 },
        { id: 'weekend_warrior', name: 'Weekend Warrior', description: 'Take exam on Saturday or Sunday', icon: '🎮', points: 45, tier: 2 },
        { id: 'early_bird', name: 'Early Bird', description: 'Take exam before 8 AM', icon: '🐦', points: 45, tier: 2 },
        { id: 'night_owl', name: 'Night Owl', description: 'Take exam after 10 PM', icon: '🦉', points: 45, tier: 2 },
        { id: 'essay_master', name: 'Essay Master', description: 'Score 90%+ on essay questions', icon: '📝', points: 50, tier: 2 },
        { id: 'mcq_master', name: 'MCQ Master', description: 'Score 95%+ on MCQ questions', icon: '✅', points: 55, tier: 2 },
        { id: 'time_master', name: 'Time Master', description: 'Finish with 80%+ time remaining', icon: '⌛', points: 50, tier: 2 },
        { id: 'upload_5', name: 'Upload Pro', description: 'Upload 5 different files', icon: '📁', points: 60, tier: 2 },

        // ================= TIER 3: ADVANCED (Hard - 15 badges) =================
        { id: 'streak_7', name: 'Dedicated Scholar', description: '7-day study streak', icon: '🏆', points: 150, tier: 3 },
        { id: 'perfect_score_medium', name: 'Medium Master', description: 'Score 100% on Medium difficulty exam', icon: '🌟', points: 80, tier: 3 },
        { id: 'question_creator', name: 'Question Creator', description: 'Create 10 custom questions', icon: '✏️', points: 100, tier: 3 },
        { id: 'ai_explorer', name: 'AI Explorer', description: 'Generate 5 AI question sets', icon: '🤖', points: 75, tier: 3 },
        { id: 'bank_saver', name: 'Bank Saver', description: 'Save 25 questions to question bank', icon: '🏦', points: 90, tier: 3 },
        { id: 'history_keeper', name: 'History Keeper', description: 'Save 10 exams to history', icon: '📜', points: 85, tier: 3 },
        { id: 'all_hard', name: 'Challenge Conqueror', description: 'Complete exam with all hard questions', icon: '💪', points: 200, tier: 3 },
        { id: 'midnight_study', name: 'Midnight Scholar', description: 'Take exam between 12AM-4AM', icon: '🌌', points: 100, tier: 3 },
        { id: 'no_time_waste', name: 'Time Efficient', description: 'Finish with 90%+ time remaining', icon: '⏱️', points: 120, tier: 3 },
        { id: 'perfect_category', name: 'Category Perfect', description: 'Score 100% in any category', icon: '🎯', points: 110, tier: 3 },
        { id: 'streak_perfect_3', name: 'Perfect Streak', description: '3 perfect scores in a row', icon: '✨', points: 130, tier: 3 },
        { id: 'all_difficulties', name: 'Versatile', description: 'Score 85%+ on Easy, Medium, Hard', icon: '🔄', points: 140, tier: 3 },
        { id: 'export_master', name: 'Export Master', export: 'Export 10 different reports', icon: '📤', points: 90, tier: 3 },
        { id: 'analytics_pro', name: 'Analytics Pro', description: 'View analytics 20 times', icon: '📈', points: 85, tier: 3 },

        // ================= TIER 4: EXPERT (Very Hard - 10 badges) =================
        { id: 'streak_30', name: 'Master Learner', description: '30-day study streak', icon: '👑', points: 500, tier: 4 },
        { id: 'perfect_score_hard', name: 'Hard Mode Hero', description: 'Score 100% on Hard difficulty exam', icon: '💎', points: 300, tier: 4 },
        { id: 'category_master', name: 'Category Master', description: 'Score 90%+ in 10 different categories', icon: '🎓', points: 400, tier: 4 },
        { id: 'question_master_1000', name: 'Grand Master', description: 'Answer 1000 questions correctly', icon: '🧠', points: 350, tier: 4 },
        { id: 'perfect_streak_5', name: 'Perfect Streak', description: '5 perfect scores in a row', icon: '🌈', points: 450, tier: 4 },
        { id: 'time_trial_master', name: 'Speed Demon', description: 'Score 90%+ in under 10 minutes', icon: '🚀', points: 350, tier: 4 },
        { id: 'no_skips', name: 'No Escape', description: 'Complete exam without skipping any question', icon: '🛡️', points: 300, tier: 4 },
        { id: 'long_session', name: 'Marathon Runner', description: 'Complete 100-question exam', icon: '🏃', points: 400, tier: 4 },
        { id: 'consistency_king', name: 'Consistency King', description: 'Score 85%+ on 10 consecutive exams', icon: '👑', points: 450, tier: 4 },

        // ================= TIER 5: LEGENDARY (Extreme - 5 badges) =================
        { id: 'streak_100', name: 'Legendary Streak', description: '100-day study streak', icon: '⚡', points: 1000, tier: 5 },
        { id: 'all_achievements_t4', name: 'Achievement Hunter', description: 'Unlock all Tier 4 achievements', icon: '🏆', points: 800, tier: 5 },
        { id: 'question_master_5000', name: 'Ultimate Scholar', description: 'Answer 5000 questions correctly', icon: '🎖️', points: 1200, tier: 5 },
        { id: 'year_completion', name: 'Year of Learning', description: 'Use app for 365 consecutive days', icon: '📅', points: 1500, tier: 5 },
        { id: 'ultimate_perfection', name: 'Ultimate Perfection', description: 'Score 100% on 10 different hard exams', icon: '💫', points: 1200, tier: 5 },

        // ================= SPECIAL/SEASONAL (5 badges) =================
        { id: 'birthday_badge', name: 'Birthday Badge', description: 'Use app on your birthday', icon: '🎂', points: 200, tier: 6, hidden: true },
        { id: 'holiday_special', name: 'Holiday Special', description: 'Take exam on a major holiday', icon: '🎄', points: 150, tier: 6, hidden: true },
        { id: 'new_year', name: 'New Year Resolution', description: 'Take first exam of the year', icon: '🎉', points: 100, tier: 6, hidden: true },
        { id: 'valentine', name: 'Heart of Learning', description: 'Take exam on Valentine\'s Day', icon: '❤️', points: 100, tier: 6, hidden: true },
        { id: 'halloween', name: 'Spooky Scholar', description: 'Take exam on Halloween', icon: '🎃', points: 100, tier: 6, hidden: true }
        ];
        // Total: 60 badges (15+15+15+10+5+5)
            }
            
            loadData() {
                try {
                    const stored = localStorage.getItem(this.key);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        return {
                            totalPoints: parsed.totalPoints || 0,
                            achievements: parsed.achievements || [],
                            currentStreak: parsed.currentStreak || 0,
                            longestStreak: parsed.longestStreak || 0,
                            lastActiveDate: parsed.lastActiveDate || null,
                            stats: parsed.stats || {
                                examsCompleted: 0,
                                totalQuestions: 0,
                                perfectScores: 0,
                                timeSpent: 0,
                                categoriesMastered: new Set()
                            }
                        };
                    }
                } catch (error) {
                    console.error('Failed to load gamification data:', error);
                }
                
                return {
                    totalPoints: 0,
                    achievements: [],
                    currentStreak: 0,
                    longestStreak: 0,
                    lastActiveDate: null,
                    stats: {
                        examsCompleted: 0,
                        totalQuestions: 0,
                        perfectScores: 0,
                        timeSpent: 0,
                        categoriesMastered: new Set()
                    }
                };
            }
            
            saveData() {
                try {
                    // Convert Set to Array for serialization
                    const dataToSave = {
                        ...this.data,
                        stats: {
                            ...this.data.stats,
                            categoriesMastered: Array.from(this.data.stats.categoriesMastered)
                        }
                    };
                    localStorage.setItem(this.key, JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Failed to save gamification data:', error);
                }
            }
            
            updateStreak() {
                const today = new Date().toISOString().split('T')[0];
                const lastDate = this.data.lastActiveDate;
                
                if (!lastDate) {
                    // First time activity
                    this.data.currentStreak = 1;
                } else {
                    const last = new Date(lastDate);
                    const current = new Date(today);
                    const diffDays = Math.floor((current - last) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        // Consecutive day
                        this.data.currentStreak++;
                    } else if (diffDays > 1) {
                        // Streak broken
                        this.data.currentStreak = 1;
                    }
                    // diffDays === 0 means same day, streak continues
                }
                
                this.data.lastActiveDate = today;
                
                // Update longest streak
                if (this.data.currentStreak > this.data.longestStreak) {
                    this.data.longestStreak = this.data.currentStreak;
                }
                
                // Check streak achievements
                this.checkStreakAchievements();
                this.saveData();
            }
            
            checkStreakAchievements() {
                const streak = this.data.currentStreak;
                if (streak >= 3 && !this.hasAchievement('streak_3')) {
                    this.unlockAchievement('streak_3');
                }
                if (streak >= 7 && !this.hasAchievement('streak_7')) {
                    this.unlockAchievement('streak_7');
                }
                if (streak >= 30 && !this.hasAchievement('streak_30')) {
                    this.unlockAchievement('streak_30');
                }
            }
            
            unlockAchievement(achievementId) {
                if (this.hasAchievement(achievementId)) return false;
                
                const achievement = this.achievements.find(a => a.id === achievementId);
                if (achievement) {
                    this.data.achievements.push(achievementId);
                    this.data.totalPoints += achievement.points;
                    this.saveData();
                    return achievement;
                }
                return false;
            }
            
            hasAchievement(achievementId) {
                return this.data.achievements.includes(achievementId);
            }
            
            getUnlockedAchievements() {
                return this.data.achievements.map(id => 
                    this.achievements.find(a => a.id === id)
                ).filter(a => a);
            }
            
            getLockedAchievements() {
                return this.achievements.filter(a => !this.hasAchievement(a.id));
            }
            
            recordExamCompletion(examData) {
                this.updateStreak();
                
                // Update basic stats
                this.data.stats.examsCompleted++;
                this.data.stats.totalQuestions += examData.totalQuestions || 0;
                this.data.stats.timeSpent += examData.timeSpent || 0;
                
                // Update correct/incorrect counts
                this.data.stats.totalCorrect += examData.score || 0;
                this.data.stats.totalIncorrect += ((examData.totalQuestions || 0) - (examData.score || 0));
                
                // Check for first exam (Tier 1)
                if (this.data.stats.examsCompleted === 1 && !this.hasAchievement('first_exam')) {
                    this.unlockAchievement('first_exam');
                }
                
                // Check time-based achievements (Tier 2)
                this.checkTimeBasedAchievements();
                
                // Check category achievements (Tier 2)
                this.checkCategoryAchievements(examData.categories);
                
                // Check question count achievements (Tier 1 & 2)
                this.checkQuestionCountAchievements();
                
                // ================= PERFECT SCORE ACHIEVEMENTS =================
                if (examData.accuracy === 100) {
                    // Check which difficulty levels were in the exam
                    const hasEasy = examData.difficultyBreakdown?.Easy > 0;
                    const hasMedium = examData.difficultyBreakdown?.Medium > 0;
                    const hasHard = examData.difficultyBreakdown?.Hard > 0;
                    
                    // Tier 2: Easy perfect
                    if (hasEasy && !hasMedium && !hasHard && !this.hasAchievement('perfect_score_easy')) {
                        this.unlockAchievement('perfect_score_easy');
                    }
                    
                    // Tier 3: Medium perfect
                    if (hasMedium && !this.hasAchievement('perfect_score_medium')) {
                        this.unlockAchievement('perfect_score_medium');
                    }
                    
                    // Tier 4: Hard perfect
                    if (hasHard && !this.hasAchievement('perfect_score_hard')) {
                        this.unlockAchievement('perfect_score_hard');
                    }
                    
                    // Update perfect scores counter
                    this.data.stats.perfectScores++;
                    
                    // Tier 3: Perfect streak
                    if (this.data.stats.perfectScores >= 3 && !this.hasAchievement('streak_perfect_3')) {
                        this.unlockAchievement('streak_perfect_3');
                    }
                    
                    // Tier 4: Perfect streak 5
                    if (this.data.stats.perfectScores >= 5 && !this.hasAchievement('perfect_streak_5')) {
                        this.unlockAchievement('perfect_streak_5');
                    }
                }
                
                // ================= SPEED ACHIEVEMENTS =================
                if (examData.timeSpent && examData.settings?.durationMinutes) {
                    const totalTime = examData.settings.durationMinutes * 60;
                    
                    // Tier 2: Speed demon (half time)
                    if (examData.timeSpent < totalTime / 2 && !this.hasAchievement('speed_demon')) {
                        this.unlockAchievement('speed_demon');
                    }
                    
                    // Tier 2: Time master (80%+ time remaining)
                    const timeRemainingPercent = ((totalTime - examData.timeSpent) / totalTime) * 100;
                    if (timeRemainingPercent >= 80 && !this.hasAchievement('time_master')) {
                        this.unlockAchievement('time_master');
                    }
                    
                    // Tier 3: No time waste (90%+ time remaining)
                    if (timeRemainingPercent >= 90 && !this.hasAchievement('no_time_waste')) {
                        this.unlockAchievement('no_time_waste');
                    }
                    
                    // Tier 4: Speed demon (90%+ in under 10 minutes)
                    if (examData.timeSpent < 600 && examData.accuracy >= 90 && !this.hasAchievement('time_trial_master')) {
                        this.unlockAchievement('time_trial_master');
                    }
                }
                
                // ================= CATEGORY ACHIEVEMENTS =================
                if (examData.categories) {
                    examData.categories.forEach(category => {
                        this.data.stats.categoriesAttempted.add(category);
                        if (examData.accuracy >= 90) {
                            this.data.stats.categoriesMastered.add(category);
                        }
                    });
                    
                    // Tier 3: Category perfect
                    if (examData.accuracy === 100 && !this.hasAchievement('perfect_category')) {
                        this.unlockAchievement('perfect_category');
                    }
                    
                    // Tier 4: Category master
                    if (this.data.stats.categoriesMastered.size >= 10 && !this.hasAchievement('category_master')) {
                        this.unlockAchievement('category_master');
                    }
                }
                
                // ================= DIFFICULTY ACHIEVEMENTS =================
                if (examData.difficultyBreakdown) {
                    // Tier 3: All hard questions
                    if (examData.difficultyBreakdown?.Hard === examData.totalQuestions && !this.hasAchievement('all_hard')) {
                        this.unlockAchievement('all_hard');
                    }
                    
                    // Tier 3: All difficulties (score 85%+ on mix)
                    const hasAllDifficulties = examData.difficultyBreakdown.Easy && 
                                              examData.difficultyBreakdown.Medium && 
                                              examData.difficultyBreakdown.Hard;
                    if (hasAllDifficulties && examData.accuracy >= 85 && !this.hasAchievement('all_difficulties')) {
                        this.unlockAchievement('all_difficulties');
                    }
                }
                
                // ================= QUESTION TYPE ACHIEVEMENTS =================
                if (examData.questions) {
                    const mcqCount = examData.questions.filter(q => !q.isEssay).length;
                    const essayCount = examData.questions.filter(q => q.isEssay).length;
                    
                    // Tier 2: MCQ Master
                    if (mcqCount > 0 && examData.accuracy >= 95 && !this.hasAchievement('mcq_master')) {
                        this.unlockAchievement('mcq_master');
                    }
                    
                    // Tier 2: Essay Master
                    if (essayCount > 0 && examData.accuracy >= 90 && !this.hasAchievement('essay_master')) {
                        this.unlockAchievement('essay_master');
                    }
                }
                
                // ================= STREAK ACHIEVEMENTS =================
                this.checkStreakAchievements();
                
                // ================= SPECIAL ACHIEVEMENTS =================
                this.checkSpecialAchievements();
                
                this.saveData();
            }
            
            recordQuestionCreation(count) {
                if (count >= 10 && !this.hasAchievement('question_creator')) {
                    this.unlockAchievement('question_creator');
                }
            }
            
            recordAIUsage() {
                if (!this.hasAchievement('ai_explorer')) {
                    this.unlockAchievement('ai_explorer');
                }
            }
            
            getRank() {
                const points = this.data.totalPoints;
                if (points >= 1000) return { name: 'Grand Master', icon: '👑', color: 'text-yellow-500' };
                if (points >= 500) return { name: 'Master', icon: '🎓', color: 'text-purple-500' };
                if (points >= 250) return { name: 'Expert', icon: '⭐', color: 'text-blue-500' };
                if (points >= 100) return { name: 'Intermediate', icon: '🔥', color: 'text-green-500' };
                return { name: 'Beginner', icon: '🌱', color: 'text-gray-500' };
            }
            
            getProgress() {
                const totalAchievements = this.achievements.length;
                const unlocked = this.data.achievements.length;
                const percentage = Math.round((unlocked / totalAchievements) * 100);
                
                return {
                    unlocked,
                    total: totalAchievements,
                    percentage,
                    nextAchievement: this.getLockedAchievements()[0]
                };
            }
            
            resetData() {
                this.data = {
                    totalPoints: 0,
                    achievements: [],
                    currentStreak: 0,
                    longestStreak: 0,
                    lastActiveDate: null,
                    stats: {
                        examsCompleted: 0,
                        totalQuestions: 0,
                        perfectScores: 0,
                        timeSpent: 0,
                        categoriesMastered: new Set()
                    }
                };
                this.saveData();
            }
            
            // ================ TIER PROGRESS & FILTERING ================
            getTierProgress() {
                const tiers = [
                    { id: 1, name: 'Beginner', color: 'green' },
                    { id: 2, name: 'Intermediate', color: 'yellow' },
                    { id: 3, name: 'Advanced', color: 'orange' },
                    { id: 4, name: 'Expert', color: 'red' },
                    { id: 5, name: 'Legendary', color: 'purple' },
                    { id: 6, name: 'Special', color: 'pink' }
                ];
                
                return tiers.map(tier => {
                    let tierAchievements;
                    if (tier.id === 6) {
                        tierAchievements = this.achievements.filter(a => a.hidden === true);
                    } else {
                        tierAchievements = this.achievements.filter(a => a.tier === tier.id);
                    }
                    
                    const unlocked = tierAchievements.filter(a => this.hasAchievement(a.id)).length;
                    const total = tierAchievements.length;
                    const percentage = total > 0 ? Math.round((unlocked / total) * 100) : 0;
                    
                    return {
                        ...tier,
                        total,
                        unlocked,
                        percentage,
                        remaining: total - unlocked
                    };
                });
            }
            
            getFilteredAchievements(filterTier = 0) {
                let filtered;
                
                if (filterTier === 0) {
                    filtered = this.achievements;
                } else if (filterTier === 6) {
                    filtered = this.achievements.filter(a => a.hidden === true);
                } else {
                    filtered = this.achievements.filter(a => a.tier === filterTier);
                }
                
                const unlocked = filtered.filter(a => this.hasAchievement(a.id));
                const locked = filtered.filter(a => !this.hasAchievement(a.id));
                
                return { unlocked, locked };
            }
            
            // ================ TIME-BASED ACHIEVEMENTS ================
            checkTimeBasedAchievements() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                // Early Bird (5 AM - 8 AM) - Tier 2
                if (hour >= 5 && hour < 8 && !this.hasAchievement('early_bird')) {
                    this.unlockAchievement('early_bird');
                }
                
                // Night Owl (10 PM - 12 AM) - Tier 2
                if (hour >= 22 && hour <= 23 && !this.hasAchievement('night_owl')) {
                    this.unlockAchievement('night_owl');
                }
                
                // Midnight Study (12 AM - 4 AM) - Tier 3
                if (hour >= 0 && hour < 4 && !this.hasAchievement('midnight_study')) {
                    this.unlockAchievement('midnight_study');
                }
                
                // Weekend Warrior (Saturday or Sunday) - Tier 2
                if ((day === 0 || day === 6) && !this.hasAchievement('weekend_warrior')) {
                    this.unlockAchievement('weekend_warrior');
                }
            }
            
            // ================ CATEGORY ACHIEVEMENTS ================
            checkCategoryAchievements(categories) {
                if (!categories || !Array.isArray(categories)) return;
                
                // Initialize if not exists
                if (!this.data.stats.categoriesAttempted) {
                    this.data.stats.categoriesAttempted = new Set();
                }
                
                // Add new categories
                categories.forEach(cat => {
                    if (cat && typeof cat === 'string') {
                        this.data.stats.categoriesAttempted.add(cat);
                    }
                });
                
                // Category Explorer (5 different categories) - Tier 2
                if (this.data.stats.categoriesAttempted.size >= 5 && !this.hasAchievement('category_explorer')) {
                    this.unlockAchievement('category_explorer');
                }
                
                // All Categories (10 different categories) - Tier 2
                if (this.data.stats.categoriesAttempted.size >= 10 && !this.hasAchievement('all_categories')) {
                    this.unlockAchievement('all_categories');
                }
            }
            
            // ================ QUESTION COUNT ACHIEVEMENTS ================
            checkQuestionCountAchievements() {
                // Initialize total questions if not exists
                if (!this.data.stats.totalQuestions) {
                    this.data.stats.totalQuestions = 0;
                }
                
                // Curious Learner (10 questions) - Tier 1
                if (this.data.stats.totalQuestions >= 10 && !this.hasAchievement('answer_10_questions')) {
                    this.unlockAchievement('answer_10_questions');
                }
                
                // Question Master 50 (50 questions) - Tier 2
                if (this.data.stats.totalQuestions >= 50 && !this.hasAchievement('question_master_50')) {
                    this.unlockAchievement('question_master_50');
                }
                
                // Grand Master (1000 questions) - Tier 4
                if (this.data.stats.totalQuestions >= 1000 && !this.hasAchievement('question_master_1000')) {
                    this.unlockAchievement('question_master_1000');
                }
                
                // Ultimate Scholar (5000 questions) - Tier 5
                if (this.data.stats.totalQuestions >= 5000 && !this.hasAchievement('question_master_5000')) {
                    this.unlockAchievement('question_master_5000');
                }
            }
            
            // ================ SPECIAL/HOLIDAY ACHIEVEMENTS ================
            checkSpecialAchievements() {
                const today = new Date();
                const month = today.getMonth() + 1;
                const date = today.getDate();
                
                // New Year (January 1st) - Special
                if (month === 1 && date === 1 && !this.hasAchievement('new_year')) {
                    this.unlockAchievement('new_year');
                }
                
                // Valentine's Day (February 14th) - Special
                if (month === 2 && date === 14 && !this.hasAchievement('valentine')) {
                    this.unlockAchievement('valentine');
                }
                
                // Halloween (October 31st) - Special
                if (month === 10 && date === 31 && !this.hasAchievement('halloween')) {
                    this.unlockAchievement('halloween');
                }
                
                // Holiday Special (December 25th) - Special
                if (month === 12 && date === 25 && !this.hasAchievement('holiday_special')) {
                    this.unlockAchievement('holiday_special');
                }
            }
        }

        // Initialize gamification manager
        const gamificationManager = new GamificationManager();

        // --- COMPONENTS ---

        const Button = ({ children, className, variant = 'primary', size = 'md', isLoading, onClick, ...props }) => {
            const [ripples, setRipples] = useState([]);
            const buttonRef = useRef(null);
            const addRipple = (e) => {
                if (!buttonRef.current) return;
                const rect = buttonRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const id = Date.now();
                setRipples(prev => [...prev, { x, y, id }]);
                setTimeout(() => setRipples(prev => prev.filter(r => r.id !== id)), 600);
                if (onClick) onClick(e);
            };
            const variants = {
                primary: 'bg-primary text-white hover:brightness-110 shadow-lg shadow-primary/30 border-transparent',
                secondary: 'bg-secondary text-white hover:brightness-110 shadow-lg shadow-secondary/30 border-transparent',
                danger: 'bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30 border-transparent',
                ghost: 'bg-transparent hover:bg-surface text-text border-transparent',
                outline: 'bg-transparent border-primary text-primary hover:bg-primary/10 border',
                ai: 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 shadow-lg shadow-purple-500/30 border-transparent',
                success: 'bg-green-500 text-white hover:bg-green-600 shadow-lg shadow-green-500/30 border-transparent'
            };
            const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-5 py-2.5 text-base', lg: 'px-8 py-3.5 text-lg', icon: 'p-2.5' };
            return (
                <button
                    ref={buttonRef}
                    className={cn('relative overflow-hidden rounded-xl font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:pointer-events-none hardware-accelerated', variants[variant], sizes[size], className)}
                    onClick={addRipple}
                    disabled={isLoading || props.disabled}
                    {...props}
                >
                    {ripples.map(ripple => (
                        <span key={ripple.id} className="absolute bg-white/30 rounded-full animate-ping pointer-events-none" style={{ left: ripple.x, top: ripple.y, width: '20px', height: '20px', transform: 'translate(-50%, -50%)' }} />
                    ))}
                    <div className={cn("flex items-center justify-center gap-2", isLoading && "opacity-0")}>{children}</div>
                    {isLoading && <div className="absolute inset-0 flex items-center justify-center"><div className="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin" /></div>}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, footer, size = 'md' }) => {
            const [isVisible, setIsVisible] = useState(false);
            useEffect(() => {
                if (isOpen) { setIsVisible(true); document.body.style.overflow = 'hidden'; } 
                else { 
                    const timer = setTimeout(() => setIsVisible(false), 300); 
                    document.body.style.overflow = ''; 
                    return () => clearTimeout(timer); 
                }
            }, [isOpen]);
            if (!isVisible) return null;
            const sizes = { sm: 'max-w-md', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-4xl', full: 'max-w-[90vw]' };
            return (
                <div className={cn("fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300", isOpen ? "opacity-100" : "opacity-0")}>
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                    <div className={cn("relative w-full bg-surface border border-white/10 rounded-2xl shadow-2xl flex flex-col max-h-[90vh] transition-all duration-300 transform glass", sizes[size], isOpen ? "translate-y-0 scale-100" : "translate-y-8 scale-95")}>
                        <div className="flex items-center justify-between p-6 border-b border-white/10">
                            <h2 className="text-xl font-bold text-primary">{title}</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-white/5 transition-colors text-text-muted hover:text-text"><X size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 text-text">{children}</div>
                        {footer && <div className="p-6 border-t border-white/10 bg-black/20 rounded-b-2xl">{footer}</div>}
                    </div>
                </div>
            );
        };

        // === NEW: Color Picker Component ===
        const ColorPicker = ({ color, onChange, label }) => (
          <div className="space-y-2">
            <label className="text-xs font-bold text-text-muted">{label}</label>
            <div className="flex gap-2">
              <input
                type="color"
                value={`#${color.r.toString(16).padStart(2, '0')}${color.g.toString(16).padStart(2, '0')}${color.b.toString(16).padStart(2, '0')}`}
                onChange={(e) => {
                  const hex = e.target.value.replace('#', '');
                  const r = parseInt(hex.substr(0, 2), 16);
                  const g = parseInt(hex.substr(2, 2), 16);
                  const b = parseInt(hex.substr(4, 2), 16);
                  onChange({ r, g, b });
                }}
                className="w-12 h-12 cursor-pointer rounded-lg border-2 border-white/20"
              />
              <div className="flex-1 space-y-1">
                <div className="flex gap-2">
                  <input
                    type="range"
                    min="0"
                    max="255"
                    value={color.r}
                    onChange={(e) => onChange({ ...color, r: parseInt(e.target.value) })}
                    className="flex-1"
                    style={{ accentColor: '#ff0000' }}
                  />
                  <span className="text-xs w-8 text-center text-text-muted">R: {color.r}</span>
                </div>
                <div className="flex gap-2">
                  <input
                    type="range"
                    min="0"
                    max="255"
                    value={color.g}
                    onChange={(e) => onChange({ ...color, g: parseInt(e.target.value) })}
                    className="flex-1"
                    style={{ accentColor: '#00ff00' }}
                  />
                  <span className="text-xs w-8 text-center text-text-muted">G: {color.g}</span>
                </div>
                <div className="flex gap-2">
                  <input
                    type="range"
                    min="0"
                    max="255"
                    value={color.b}
                    onChange={(e) => onChange({ ...color, b: parseInt(e.target.value) })}
                    className="flex-1"
                    style={{ accentColor: '#0000ff' }}
                  />
                  <span className="text-xs w-8 text-center text-text-muted">B: {color.b}</span>
                </div>
              </div>
            </div>
          </div>
        );

        // === Score Ring Component ===
        const ScoreRing = ({ score, total, size = 180, strokeWidth = 12, className }) => {
            const [animatedScore, setAnimatedScore] = useState(0);
            const percentage = Math.round((score / total) * 100) || 0;
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (animatedScore / 100) * circumference;
            useEffect(() => { 
                const timer = setTimeout(() => setAnimatedScore(percentage), 300); 
                return () => clearTimeout(timer); 
            }, [percentage]);
            
            let colorClass = "text-primary";
            if (percentage >= 80) colorClass = "text-emerald-500";
            else if (percentage >= 60) colorClass = "text-primary";
            else if (percentage >= 40) colorClass = "text-yellow-500";
            else colorClass = "text-red-500";
            
            return (
                <div className={cn("relative flex items-center justify-center", className)} style={{ width: size, height: size }}>
                    <svg width={size} height={size} className="transform -rotate-90">
                        <circle cx={size / 2} cy={size / 2} r={radius} fill="transparent" stroke="currentColor" strokeWidth={strokeWidth} className="text-surface opacity-50" />
                        <circle cx={size / 2} cy={size / 2} r={radius} fill="transparent" stroke="currentColor" strokeWidth={strokeWidth} strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className={cn("transition-all duration-1000 ease-out", colorClass)} />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center animate-fade-in">
                        <span className={cn("text-5xl font-black tracking-tighter", colorClass)}>{Math.round(animatedScore)}%</span>
                        <span className="text-sm text-text-muted font-medium mt-1 uppercase tracking-wide">{score} / {total}</span>
                    </div>
                </div>
            );
        };

        // === NEW: Exam History Component ===
        const ExamHistoryDashboard = ({ onClose, onRestoreExam }) => {
            const [history, setHistory] = useState([]);
            const [stats, setStats] = useState(null);
            const [categoryStats, setCategoryStats] = useState([]);
            const [filters, setFilters] = useState({
                search: '',
                startDate: '',
                endDate: '',
                minScore: 0,
                category: '',
                sortBy: 'date'
            });
            const [selectedExam, setSelectedExam] = useState(null);
            
            useEffect(() => {
                loadHistory();
            }, [filters]);
            
            const loadHistory = () => {
                const filteredHistory = examHistoryManager.getFilteredHistory(filters);
                setHistory(filteredHistory);
                setStats(examHistoryManager.getStats());
                setCategoryStats(examHistoryManager.getCategoryStats());
            };
            
            const handleDeleteExam = (id, event) => {
                event.stopPropagation();
                if (confirm('Are you sure you want to delete this exam record?')) {
                    examHistoryManager.deleteExam(id);
                    loadHistory();
                    sfx.success();
                }
            };
            
            const handleClearAll = () => {
                if (confirm('Are you sure you want to delete ALL exam history? This cannot be undone.')) {
                    examHistoryManager.clearAllHistory();
                    loadHistory();
                    sfx.success();
                }
            };
            
            const handleRestoreExam = (exam) => {
                onRestoreExam(exam);
                onClose();
            };
            
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            const getScoreColor = (score) => {
                if (score >= 90) return 'text-green-500';
                if (score >= 70) return 'text-yellow-500';
                if (score >= 50) return 'text-orange-500';
                return 'text-red-500';
            };
            
            return (
                <div className="space-y-6">
                    {/* Stats Overview */}
                    {stats && stats.totalExams > 0 && (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-primary">{stats.totalExams}</div>
                                <div className="text-xs text-text-muted">Total Exams</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-secondary">{stats.averageScore}%</div>
                                <div className="text-xs text-text-muted">Avg Score</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-purple-500">{formatTime(stats.totalTimeSpent)}</div>
                                <div className="text-xs text-text-muted">Total Time</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-green-500">{stats.bestScore}%</div>
                                <div className="text-xs text-text-muted">Best Score</div>
                            </div>
                        </div>
                    )}
                    
                    {/* Filters */}
                    <div className="glass p-4 rounded-xl">
                        <h3 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                            <FilterIcon size={16} /> Filter & Search
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Search</label>
                                <input
                                    type="text"
                                    placeholder="Search exams..."
                                    value={filters.search}
                                    onChange={(e) => setFilters(f => ({ ...f, search: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                />
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Min Score</label>
                                <input
                                    type="range"
                                    min="0"
                                    max="100"
                                    value={filters.minScore}
                                    onChange={(e) => setFilters(f => ({ ...f, minScore: parseInt(e.target.value) }))}
                                    className="w-full"
                                />
                                <div className="text-center text-sm">{filters.minScore}%</div>
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Sort By</label>
                                <select
                                    value={filters.sortBy}
                                    onChange={(e) => setFilters(f => ({ ...f, sortBy: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="date">Date (Newest)</option>
                                    <option value="score">Score (Highest)</option>
                                    <option value="time">Time (Shortest)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Category</label>
                                <select
                                    value={filters.category}
                                    onChange={(e) => setFilters(f => ({ ...f, category: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="">All Categories</option>
                                    {categoryStats.map(stat => (
                                        <option key={stat.category} value={stat.category}>
                                            {stat.category} ({stat.examCount})
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Start Date</label>
                                <input
                                    type="date"
                                    value={filters.startDate}
                                    onChange={(e) => setFilters(f => ({ ...f, startDate: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                />
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">End Date</label>
                                <input
                                    type="date"
                                    value={filters.endDate}
                                    onChange={(e) => setFilters(f => ({ ...f, endDate: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                />
                            </div>
                        </div>
                    </div>
                    
                    {/* History List */}
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h3 className="font-bold text-text-muted flex items-center gap-2">
                                <History size={16} /> Exam History ({history.length})
                            </h3>
                            <Button
                                variant="danger"
                                size="sm"
                                onClick={handleClearAll}
                                disabled={history.length === 0}
                            >
                                <Trash2 size={14} className="mr-2" />
                                Clear All
                            </Button>
                        </div>
                        
                        {history.length === 0 ? (
                            <div className="text-center py-12 glass rounded-xl">
                                <History size={48} className="mx-auto mb-4 text-text-muted opacity-50" />
                                <p className="text-text-muted">No exam history yet</p>
                                <p className="text-sm text-text-muted mt-1">Complete your first exam to see it here!</p>
                            </div>
                        ) : (
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {history.map((exam, index) => (
                                    <div 
                                        key={exam.id} 
                                        className={cn(
                                            "glass p-4 rounded-xl border transition-all cursor-pointer hover:bg-surface/80 animate-history-entry",
                                            selectedExam?.id === exam.id ? "border-primary bg-primary/10" : "border-white/10"
                                        )}
                                        style={{ animationDelay: `${index * 50}ms` }}
                                        onClick={() => setSelectedExam(selectedExam?.id === exam.id ? null : exam)}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h4 className="font-bold text-lg">{exam.title}</h4>
                                                    <span className={cn("text-sm font-bold px-2 py-0.5 rounded-full", getScoreColor(exam.accuracy))}>
                                                        {exam.accuracy}%
                                                    </span>
                                                </div>
                                                <p className="text-sm text-text-muted">
                                                    {formatDate(exam.timestamp)} • {exam.totalQuestions} questions • {formatTime(exam.timeSpent)}
                                                </p>
                                                {exam.categories && exam.categories.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                        {exam.categories.slice(0, 3).map(cat => (
                                                            <span key={cat} className="px-2 py-0.5 bg-black/20 rounded-full text-xs text-text-muted">
                                                                {cat}
                                                            </span>
                                                        ))}
                                                        {exam.categories.length > 3 && (
                                                            <span className="px-2 py-0.5 bg-black/20 rounded-full text-xs text-text-muted">
                                                                +{exam.categories.length - 3} more
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="flex gap-2 ml-4">
                                                <Button
                                                    variant="outline"
                                                    size="icon"
                                                    onClick={(e) => handleDeleteExam(exam.id, e)}
                                                    title="Delete this exam"
                                                >
                                                    <Trash2 size={14} />
                                                </Button>
                                                <Button
                                                    variant="outline"
                                                    size="icon"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleRestoreExam(exam);
                                                    }}
                                                    title="Restore this exam"
                                                >
                                                    <FolderOpen size={14} />
                                                </Button>
                                            </div>
                                        </div>
                                        
                                        {/* Detailed View */}
                                        {selectedExam?.id === exam.id && (
                                            <div className="mt-4 pt-4 border-t border-white/10 animate-fade-in">
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                                    <div className="text-center p-2 bg-primary/10 rounded-lg">
                                                        <div className="text-sm font-bold text-primary">Score</div>
                                                        <div className="text-lg font-bold">{exam.score}/{exam.totalQuestions}</div>
                                                    </div>
                                                    <div className="text-center p-2 bg-secondary/10 rounded-lg">
                                                        <div className="text-sm font-bold text-secondary">Time</div>
                                                        <div className="text-lg font-bold">{formatTime(exam.timeSpent)}</div>
                                                    </div>
                                                    <div className="text-center p-2 bg-purple-500/10 rounded-lg">
                                                        <div className="text-sm font-bold text-purple-500">Questions</div>
                                                        <div className="text-lg font-bold">{exam.totalQuestions}</div>
                                                    </div>
                                                    <div className="text-center p-2 bg-green-500/10 rounded-lg">
                                                        <div className="text-sm font-bold text-green-500">Accuracy</div>
                                                        <div className="text-lg font-bold">{exam.accuracy}%</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2">
                                                    <h5 className="font-bold text-sm text-text-muted">Difficulty Breakdown:</h5>
                                                    <div className="flex gap-2">
                                                        {Object.entries(exam.difficultyBreakdown || {}).map(([diff, count]) => (
                                                            <div key={diff} className="flex-1 text-center p-2 bg-black/20 rounded">
                                                                <div className="text-xs text-text-muted">{diff}</div>
                                                                <div className="font-bold">{count}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-4">
                                                    <Button
                                                        variant="primary"
                                                        className="w-full"
                                                        onClick={() => handleRestoreExam(exam)}
                                                    >
                                                        <FolderOpen size={16} className="mr-2" />
                                                        Restore & Review This Exam
                                                    </Button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {/* Category Performance */}
                    {categoryStats.length > 0 && (
                        <div className="glass p-4 rounded-xl">
                            <h3 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                                <BarChart2 size={16} /> Category Performance
                            </h3>
                            <div className="space-y-2">
                                {categoryStats.slice(0, 5).map(stat => (
                                    <div key={stat.category} className="flex items-center justify-between">
                                        <span className="text-sm">{stat.category}</span>
                                        <div className="flex items-center gap-2">
                                            <div className="w-32 h-2 bg-black/20 rounded-full overflow-hidden">
                                                <div 
                                                    className="h-full bg-primary rounded-full"
                                                    style={{ width: `${stat.averageScore}%` }}
                                                ></div>
                                            </div>
                                            <span className="text-sm font-bold w-10 text-right">{stat.averageScore}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Actions */}
                    <div className="flex gap-3 pt-4">
                        <Button variant="outline" className="flex-1" onClick={onClose}>
                            Close History
                        </Button>
                        {history.length > 0 && (
                            <Button
                                variant="success"
                                className="flex-1"
                                onClick={() => {
                                    const data = history.map(exam => ({
                                        title: exam.title,
                                        date: exam.timestamp,
                                        score: `${exam.score}/${exam.totalQuestions}`,
                                        accuracy: `${exam.accuracy}%`,
                                        time: formatTime(exam.timeSpent),
                                        categories: exam.categories.join(', ')
                                    }));
                                    exportToPDF('Exam_History_Report', data);
                                }}
                            >
                                <Download size={16} className="mr-2" />
                                Export Report
                            </Button>
                        )}
                    </div>
                </div>
            );
        };

        // === NEW: Question Bank Component ===
        const QuestionBankDashboard = ({ onClose, onLoadQuestions }) => {
            const [questions, setQuestions] = useState([]);
            const [stats, setStats] = useState(null);
            const [categories, setCategories] = useState([]);
            const [filters, setFilters] = useState({
                search: '',
                category: '',
                difficulty: '',
                type: '',
                sortBy: 'date'
            });
            const [selectedQuestions, setSelectedQuestions] = useState(new Set());
            const [isSelectMode, setIsSelectMode] = useState(false);
            
            useEffect(() => {
                loadQuestions();
            }, [filters]);
            
            const loadQuestions = () => {
                const filteredQuestions = questionBankManager.getQuestions(filters);
                setQuestions(filteredQuestions);
                setStats(questionBankManager.getStats());
                setCategories(questionBankManager.getCategories());
            };
            
            const handleSelectQuestion = (id) => {
                if (!isSelectMode) return;
                
                const newSelected = new Set(selectedQuestions);
                if (newSelected.has(id)) {
                    newSelected.delete(id);
                } else {
                    newSelected.add(id);
                }
                setSelectedQuestions(newSelected);
            };
            
            const handleLoadSelected = () => {
                const selected = questions.filter(q => selectedQuestions.has(q.id));
                onLoadQuestions(selected);
                onClose();
            };
            
            const handleDeleteQuestion = (id, event) => {
                event.stopPropagation();
                if (confirm('Delete this question from your bank?')) {
                    questionBankManager.deleteQuestion(id);
                    loadQuestions();
                    sfx.success();
                }
            };
            
            const handleClearBank = () => {
                if (confirm('Are you sure you want to clear your entire question bank? This cannot be undone.')) {
                    questionBankManager.clearBank();
                    loadQuestions();
                    sfx.success();
                }
            };
            
            const handleAddToBank = (questionsToAdd) => {
                const addedCount = questionBankManager.addQuestions(questionsToAdd);
                loadQuestions();
                sfx.success();
                alert(`Added ${addedCount} questions to your bank!`);
            };
            
            return (
                <div className="space-y-6">
                    {/* Stats */}
                    {stats && (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-primary">{stats.totalQuestions}</div>
                                <div className="text-xs text-text-muted">Total</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-secondary">{stats.categories}</div>
                                <div className="text-xs text-text-muted">Categories</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-purple-500">{stats.mcqCount}</div>
                                <div className="text-xs text-text-muted">MCQ</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-green-500">{stats.essayCount}</div>
                                <div className="text-xs text-text-muted">Essays</div>
                            </div>
                        </div>
                    )}
                    
                    {/* Filters */}
                    <div className="glass p-4 rounded-xl">
                        <h3 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                            <FilterIcon size={16} /> Filter Questions
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Search</label>
                                <input
                                    type="text"
                                    placeholder="Search questions..."
                                    value={filters.search}
                                    onChange={(e) => setFilters(f => ({ ...f, search: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                />
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Category</label>
                                <select
                                    value={filters.category}
                                    onChange={(e) => setFilters(f => ({ ...f, category: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="">All Categories</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Difficulty</label>
                                <select
                                    value={filters.difficulty}
                                    onChange={(e) => setFilters(f => ({ ...f, difficulty: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="">All</option>
                                    <option value="Easy">Easy</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Hard">Hard</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="text-xs text-text-muted block mb-1">Type</label>
                                <select
                                    value={filters.type}
                                    onChange={(e) => setFilters(f => ({ ...f, type: e.target.value }))}
                                    className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="">All Types</option>
                                    <option value="mcq">Multiple Choice</option>
                                    <option value="essay">Essay</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="mt-3">
                            <label className="text-xs text-text-muted block mb-1">Sort By</label>
                            <div className="flex gap-2">
                                {['date', 'category', 'difficulty'].map(sort => (
                                    <button
                                        key={sort}
                                        onClick={() => setFilters(f => ({ ...f, sortBy: sort }))}
                                        className={cn(
                                            "px-3 py-1 rounded-lg text-sm transition-all",
                                            filters.sortBy === sort
                                                ? "bg-primary text-white"
                                                : "bg-black/20 text-text-muted hover:bg-black/30"
                                        )}
                                    >
                                        {sort.charAt(0).toUpperCase() + sort.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Actions Bar */}
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Button
                                variant={isSelectMode ? "secondary" : "outline"}
                                size="sm"
                                onClick={() => {
                                    setIsSelectMode(!isSelectMode);
                                    setSelectedQuestions(new Set());
                                }}
                            >
                                {isSelectMode ? "Cancel Selection" : "Select Questions"}
                            </Button>
                            
                            {isSelectMode && selectedQuestions.size > 0 && (
                                <Button
                                    variant="primary"
                                    size="sm"
                                    onClick={handleLoadSelected}
                                >
                                    Load Selected ({selectedQuestions.size})
                                </Button>
                            )}
                        </div>
                        
                        <div className="flex gap-2">
                            <Button
                                variant="danger"
                                size="sm"
                                onClick={handleClearBank}
                                disabled={questions.length === 0}
                            >
                                <Trash2 size={14} className="mr-2" />
                                Clear Bank
                            </Button>
                            
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                    const currentQuestions = questions;
                                    onLoadQuestions(currentQuestions);
                                    onClose();
                                }}
                                disabled={questions.length === 0}
                            >
                                Load All
                            </Button>
                        </div>
                    </div>
                    
                    {/* Questions List */}
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                        {questions.length === 0 ? (
                            <div className="text-center py-12 glass rounded-xl">
                                <BookOpen size={48} className="mx-auto mb-4 text-text-muted opacity-50" />
                                <p className="text-text-muted">Your question bank is empty</p>
                                <p className="text-sm text-text-muted mt-1">Add questions from exams or create new ones!</p>
                            </div>
                        ) : (
                            questions.map((question, index) => (
                                <div 
                                    key={question.id} 
                                    className={cn(
                                        "glass p-4 rounded-xl border transition-all cursor-pointer",
                                        selectedQuestions.has(question.id) 
                                            ? "border-primary bg-primary/10" 
                                            : "border-white/10 hover:bg-surface/50",
                                        isSelectMode && "hover:border-primary/50"
                                    )}
                                    onClick={() => handleSelectQuestion(question.id)}
                                >
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-2">
                                                {isSelectMode && (
                                                    <div className={cn(
                                                        "w-5 h-5 rounded border flex items-center justify-center flex-shrink-0",
                                                        selectedQuestions.has(question.id)
                                                            ? "bg-primary border-primary text-white"
                                                            : "border-white/20"
                                                    )}>
                                                        {selectedQuestions.has(question.id) && <Check size={12} />}
                                                    </div>
                                                )}
                                                <p className="font-medium line-clamp-2">{question.text}</p>
                                            </div>
                                            
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {question.category && (
                                                    <span className="px-2 py-0.5 bg-primary/20 text-primary text-xs rounded-full">
                                                        {question.category}
                                                    </span>
                                                )}
                                                {question.difficulty && (
                                                    <span className={cn(
                                                        "px-2 py-0.5 text-xs rounded-full",
                                                        question.difficulty === 'Easy' ? 'bg-green-500/20 text-green-500' :
                                                        question.difficulty === 'Medium' ? 'bg-yellow-500/20 text-yellow-500' :
                                                        'bg-red-500/20 text-red-500'
                                                    )}>
                                                        {question.difficulty}
                                                    </span>
                                                )}
                                                {question.isEssay ? (
                                                    <span className="px-2 py-0.5 bg-purple-500/20 text-purple-500 text-xs rounded-full">
                                                        Essay
                                                    </span>
                                                ) : (
                                                    <span className="px-2 py-0.5 bg-blue-500/20 text-blue-500 text-xs rounded-full">
                                                        MCQ
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {question.addedAt && (
                                                <p className="text-xs text-text-muted mt-2">
                                                    Added {new Date(question.addedAt).toLocaleDateString()}
                                                </p>
                                            )}
                                        </div>
                                        
                                        {!isSelectMode && (
                                            <Button
                                                variant="ghost"
                                                size="icon"
                                                onClick={(e) => handleDeleteQuestion(question.id, e)}
                                                title="Delete question"
                                            >
                                                <Trash2 size={14} />
                                            </Button>
                                        )}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    
                    {/* Actions */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 pt-4">
                        <Button
                            variant="outline"
                            onClick={() => {
                                const sampleQuestions = parseCSV(SAMPLE_CSV);
                                handleAddToBank(sampleQuestions);
                            }}
                        >
                            <FileSpreadsheet size={16} className="mr-2" />
                            Add Sample Questions
                        </Button>
                        
                        <Button
                            variant="success"
                            onClick={() => {
                                alert("This would save current exam questions to bank");
                            }}
                        >
                            <SaveIcon size={16} className="mr-2" />
                            Save Current Exam
                        </Button>
                        
                        <Button variant="outline" onClick={onClose}>
                            Close Bank
                        </Button>
                    </div>
                </div>
            );
        };

        // === NEW: Enhanced Gamification Dashboard with 60+ Badges ===
        const GamificationDashboard = ({ onClose }) => {
            const [rank, setRank] = useState(null);
            const [progress, setProgress] = useState(null);
            const [unlockedAchievements, setUnlockedAchievements] = useState([]);
            const [lockedAchievements, setLockedAchievements] = useState([]);
            const [stats, setStats] = useState(null);
            const [filterTier, setFilterTier] = useState(0); // 0 = all, 1-5 = tiers, 6 = special
            const [tierProgress, setTierProgress] = useState([]);
            const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
            const [sortBy, setSortBy] = useState('tier'); // 'tier', 'date', 'points'
            
            useEffect(() => {
                loadData();
            }, [filterTier, sortBy]);
            
            const loadData = () => {
                setRank(gamificationManager.getRank());
                setProgress(gamificationManager.getProgress());
                setStats(gamificationManager.data?.stats);
                setTierProgress(gamificationManager.getTierProgress());
                
                // Get filtered achievements
                const filtered = gamificationManager.getFilteredAchievements(filterTier);
                
                // Sort achievements
                const sortedUnlocked = [...filtered.unlocked].sort((a, b) => {
                    if (sortBy === 'tier') return a.tier - b.tier;
                    if (sortBy === 'points') return b.points - a.points;
                    return 0; // tier is default
                });
                
                const sortedLocked = [...filtered.locked].sort((a, b) => {
                    if (sortBy === 'tier') return a.tier - b.tier;
                    if (sortBy === 'points') return b.points - a.points;
                    return 0;
                });
                
                setUnlockedAchievements(sortedUnlocked);
                setLockedAchievements(sortedLocked);
            };
            
            const handleReset = () => {
                if (confirm('⚠️ Are you sure you want to reset ALL your gamification progress?\n\nThis will delete ALL badges, points, and stats. This cannot be undone!')) {
                    gamificationManager.resetData();
                    loadData();
                    sfx.success();
                    alert('Progress reset successfully!');
                }
            };
            
            const getTierColor = (tier) => {
                switch(tier) {
                    case 1: return 'from-green-500 to-emerald-500';
                    case 2: return 'from-yellow-500 to-amber-500';
                    case 3: return 'from-orange-500 to-red-500';
                    case 4: return 'from-red-500 to-pink-500';
                    case 5: return 'from-purple-500 to-indigo-500';
                    case 6: return 'from-pink-500 to-rose-500';
                    default: return 'from-primary to-accent';
                }
            };
            
            const getTierName = (tier) => {
                switch(tier) {
                    case 1: return 'Beginner';
                    case 2: return 'Intermediate';
                    case 3: return 'Advanced';
                    case 4: return 'Expert';
                    case 5: return 'Legendary';
                    case 6: return 'Special';
                    default: return 'All';
                }
            };
            
            const formatPoints = (points) => {
                if (points >= 1000) return `${(points/1000).toFixed(1)}k`;
                return points;
            };
            
            return (
                <div className="space-y-6">
                    {/* Header Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="glass p-4 rounded-xl text-center col-span-2">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                <span className="text-4xl">{rank?.icon}</span>
                                <div>
                                    <div className="text-sm text-text-muted">Your Rank</div>
                                    <div className={cn("text-2xl font-bold", rank?.color)}>{rank?.name}</div>
                                </div>
                            </div>
                            <div className="text-3xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent mt-2">
                                {gamificationManager.data?.totalPoints || 0} points
                            </div>
                            <div className="text-sm text-text-muted mt-1">
                                Level {Math.floor((gamificationManager.data?.totalPoints || 0) / 100) + 1}
                            </div>
                        </div>
                        
                        <div className="glass p-4 rounded-xl">
                            <div className="text-center">
                                <div className="text-sm text-text-muted mb-1">Progress</div>
                                <div className="text-2xl font-bold text-secondary">
                                    {progress?.unlocked}/{progress?.total}
                                </div>
                                <div className="w-full h-2 bg-black/20 rounded-full mt-2 overflow-hidden">
                                    <div 
                                        className="h-full bg-gradient-to-r from-secondary to-green-500 rounded-full transition-all duration-1000"
                                        style={{ width: `${progress?.percentage || 0}%` }}
                                    ></div>
                                </div>
                                <div className="text-xs text-text-muted mt-1">{progress?.percentage}% complete</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Tier Progress */}
                    <div className="glass p-4 rounded-xl">
                        <h4 className="font-bold text-text-muted mb-3">Tier Progress</h4>
                        <div className="space-y-3">
                            {tierProgress.map(tier => (
                                <div key={tier.id} className="space-y-1">
                                    <div className="flex justify-between text-sm">
                                        <span className="font-medium flex items-center gap-2">
                                            {tier.id === 6 ? '🎭 Special' : `Tier ${tier.id}: ${tier.name}`}
                                            {tier.percentage === 100 && <span className="text-xs px-2 py-0.5 bg-green-500/20 text-green-500 rounded-full">Completed!</span>}
                                        </span>
                                        <span className={cn(
                                            "font-bold",
                                            tier.id === 1 ? 'text-green-500' :
                                            tier.id === 2 ? 'text-yellow-500' :
                                            tier.id === 3 ? 'text-orange-500' :
                                            tier.id === 4 ? 'text-red-500' :
                                            tier.id === 5 ? 'text-purple-500' :
                                            'text-pink-500'
                                        )}>
                                            {tier.unlocked}/{tier.total} ({tier.percentage}%)
                                        </span>
                                    </div>
                                    <div className="h-2 bg-surface rounded-full overflow-hidden">
                                        <div 
                                            className={cn(
                                                "h-full rounded-full transition-all duration-1000",
                                                tier.id === 1 ? 'bg-green-500' :
                                                tier.id === 2 ? 'bg-yellow-500' :
                                                tier.id === 3 ? 'bg-orange-500' :
                                                tier.id === 4 ? 'bg-red-500' :
                                                tier.id === 5 ? 'bg-purple-500' :
                                                'bg-gradient-to-r from-pink-500 to-rose-500'
                                            )}
                                            style={{ width: `${tier.percentage}%` }}
                                        />
                                    </div>
                                    {tier.remaining > 0 && tier.percentage < 100 && (
                                        <div className="text-xs text-text-muted">
                                            {tier.remaining} more to complete
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Filters & Controls */}
                    <div className="glass p-4 rounded-xl">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex-1">
                                <h4 className="font-bold text-text-muted mb-2">Filter by Tier</h4>
                                <div className="flex flex-wrap gap-2">
                                    {[0, 1, 2, 3, 4, 5, 6].map(tier => (
                                        <button
                                            key={tier}
                                            onClick={() => setFilterTier(tier)}
                                            className={cn(
                                                "px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200",
                                                filterTier === tier 
                                                    ? (tier === 0 ? "bg-primary text-white shadow-lg shadow-primary/30" :
                                                       tier === 1 ? "bg-green-500 text-white shadow-lg shadow-green-500/30" :
                                                       tier === 2 ? "bg-yellow-500 text-white shadow-lg shadow-yellow-500/30" :
                                                       tier === 3 ? "bg-orange-500 text-white shadow-lg shadow-orange-500/30" :
                                                       tier === 4 ? "bg-red-500 text-white shadow-lg shadow-red-500/30" :
                                                       tier === 5 ? "bg-purple-500 text-white shadow-lg shadow-purple-500/30" :
                                                       "bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg shadow-pink-500/30")
                                                    : "bg-surface/50 hover:bg-surface text-text-muted"
                                            )}
                                        >
                                            {tier === 0 ? '🌟 All' : 
                                             tier === 1 ? '🟢 Tier 1' : 
                                             tier === 2 ? '🟡 Tier 2' : 
                                             tier === 3 ? '🟠 Tier 3' : 
                                             tier === 4 ? '🔴 Tier 4' : 
                                             tier === 5 ? '💜 Tier 5' : 
                                             '🎭 Special'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex gap-2">
                                <select
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                    className="px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm"
                                >
                                    <option value="tier">Sort by Tier</option>
                                    <option value="points">Sort by Points</option>
                                </select>
                                
                                <button
                                    onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
                                    className="px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm hover:bg-black/30"
                                >
                                    {viewMode === 'grid' ? '📋 List' : '🔲 Grid'}
                                </button>
                            </div>
                        </div>
                        
                        {/* Current Filter Info */}
                        <div className="mt-4 p-3 bg-primary/10 rounded-lg border border-primary/20">
                            <div className="flex items-center justify-between">
                                <div>
                                    <span className="text-sm text-primary">
                                        Showing {getTierName(filterTier)} Badges ({unlockedAchievements.length + lockedAchievements.length} total)
                                    </span>
                                    <div className="text-xs text-text-muted">
                                        {unlockedAchievements.length} unlocked • {lockedAchievements.length} locked
                                    </div>
                                </div>
                                <div className="text-sm">
                                    Total Points in this tier: <span className="font-bold text-primary">
                                        {unlockedAchievements.reduce((sum, a) => sum + (a.points || 0), 0)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Stats Summary */}
                    {stats && (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-primary">{stats.examsCompleted || 0}</div>
                                <div className="text-xs text-text-muted">Exams</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-secondary">{stats.totalQuestions || 0}</div>
                                <div className="text-xs text-text-muted">Questions</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-purple-500">{gamificationManager.data?.currentStreak || 0}</div>
                                <div className="text-xs text-text-muted">Day Streak</div>
                            </div>
                            <div className="glass p-3 rounded-xl text-center">
                                <div className="text-xl font-bold text-green-500">{stats.perfectScores || 0}</div>
                                <div className="text-xs text-text-muted">Perfect Scores</div>
                            </div>
                        </div>
                    )}
                    
                    {/* Unlocked Achievements */}
                    <div className="glass p-4 rounded-xl">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-bold text-text-muted flex items-center gap-2">
                                <AwardIcon size={16} /> Unlocked Badges ({unlockedAchievements.length})
                            </h3>
                            <span className="text-sm text-green-500 font-bold">
                                {unlockedAchievements.length > 0 ? `${Math.round((unlockedAchievements.length / (unlockedAchievements.length + lockedAchievements.length)) * 100)}% complete` : 'Start earning!'}
                            </span>
                        </div>
                        
                        {unlockedAchievements.length === 0 ? (
                            <div className="text-center py-8 text-text-muted">
                                <Trophy size={48} className="mx-auto mb-4 opacity-50" />
                                <p>No badges unlocked in this tier yet!</p>
                                <p className="text-sm mt-1">Complete challenges to unlock badges.</p>
                            </div>
                        ) : viewMode === 'grid' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {unlockedAchievements.map(achievement => (
                                    <div 
                                        key={achievement.id} 
                                        className={cn(
                                            "p-3 rounded-lg border animate-fade-in",
                                            `border-${achievement.tier === 1 ? 'green' : achievement.tier === 2 ? 'yellow' : achievement.tier === 3 ? 'orange' : achievement.tier === 4 ? 'red' : achievement.tier === 5 ? 'purple' : 'pink'}-500/30`,
                                            `bg-${achievement.tier === 1 ? 'green' : achievement.tier === 2 ? 'yellow' : achievement.tier === 3 ? 'orange' : achievement.tier === 4 ? 'red' : achievement.tier === 5 ? 'purple' : 'pink'}-500/10`
                                        )}
                                    >
                                        <div className="flex items-start gap-3">
                                            <div className="text-2xl">{achievement.icon}</div>
                                            <div className="flex-1">
                                                <div className="flex items-start justify-between">
                                                    <h4 className="font-bold">{achievement.name}</h4>
                                                    <span className="text-xs px-2 py-0.5 bg-yellow-500/20 text-yellow-500 rounded-full font-bold">
                                                        +{formatPoints(achievement.points)}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-text-muted mt-1">{achievement.description}</p>
                                                <div className="flex items-center justify-between mt-2">
                                                    <span className={cn(
                                                        "text-xs px-2 py-0.5 rounded-full font-bold",
                                                        achievement.tier === 1 ? "bg-green-500/20 text-green-500" :
                                                        achievement.tier === 2 ? "bg-yellow-500/20 text-yellow-500" :
                                                        achievement.tier === 3 ? "bg-orange-500/20 text-orange-500" :
                                                        achievement.tier === 4 ? "bg-red-500/20 text-red-500" :
                                                        achievement.tier === 5 ? "bg-purple-500/20 text-purple-500" :
                                                        "bg-pink-500/20 text-pink-500"
                                                    )}>
                                                        Tier {achievement.tier || 'Special'}
                                                    </span>
                                                    <span className="text-xs text-text-muted">✓ Unlocked</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {unlockedAchievements.map(achievement => (
                                    <div 
                                        key={achievement.id} 
                                        className="p-3 bg-green-500/10 border border-green-500/20 rounded-lg animate-fade-in"
                                    >
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">{achievement.icon}</span>
                                            <div className="flex-1">
                                                <div className="flex items-center justify-between">
                                                    <h4 className="font-bold text-green-400">{achievement.name}</h4>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs px-2 py-0.5 bg-green-500/20 text-green-500 rounded-full">
                                                            Tier {achievement.tier}
                                                        </span>
                                                        <span className="text-lg font-bold text-yellow-500">+{achievement.points}</span>
                                                    </div>
                                                </div>
                                                <p className="text-sm text-green-300/80">{achievement.description}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {/* Locked Achievements */}
                    {lockedAchievements.length > 0 && (
                        <div className="glass p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-bold text-text-muted flex items-center gap-2">
                                    <Lock size={16} /> Locked Badges ({lockedAchievements.length})
                                </h3>
                                <span className="text-sm text-text-muted">
                                    {Math.round((lockedAchievements.length / (unlockedAchievements.length + lockedAchievements.length)) * 100)}% remaining
                                </span>
                            </div>
                            
                            {viewMode === 'grid' ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {lockedAchievements.slice(0, 9).map(achievement => (
                                        <div 
                                            key={achievement.id} 
                                            className="p-3 bg-surface/50 border border-white/10 rounded-lg opacity-60 hover:opacity-80 transition-opacity"
                                        >
                                            <div className="flex items-start gap-3">
                                                <div className="text-2xl opacity-50">{achievement.icon}</div>
                                                <div className="flex-1">
                                                    <div className="flex items-start justify-between">
                                                        <h4 className="font-bold text-text-muted">{achievement.name}</h4>
                                                        <span className="text-xs px-2 py-0.5 bg-surface text-text-muted rounded-full font-bold">
                                                            +{formatPoints(achievement.points)}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-text-muted mt-1">{achievement.description}</p>
                                                    <div className="flex items-center justify-between mt-2">
                                                        <span className={cn(
                                                            "text-xs px-2 py-0.5 rounded-full font-bold",
                                                            achievement.tier === 1 ? "bg-green-500/10 text-green-500/50" :
                                                            achievement.tier === 2 ? "bg-yellow-500/10 text-yellow-500/50" :
                                                            achievement.tier === 3 ? "bg-orange-500/10 text-orange-500/50" :
                                                            achievement.tier === 4 ? "bg-red-500/10 text-red-500/50" :
                                                            achievement.tier === 5 ? "bg-purple-500/10 text-purple-500/50" :
                                                            "bg-pink-500/10 text-pink-500/50"
                                                        )}>
                                                            Tier {achievement.tier || 'Special'}
                                                        </span>
                                                        <span className="text-xs text-text-muted">🔒 Locked</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {lockedAchievements.slice(0, 6).map(achievement => (
                                        <div 
                                            key={achievement.id} 
                                            className="p-3 bg-surface/50 border border-white/10 rounded-lg opacity-60"
                                        >
                                            <div className="flex items-center gap-3">
                                                <span className="text-2xl opacity-50">{achievement.icon}</span>
                                                <div className="flex-1">
                                                    <h4 className="font-bold text-text-muted">{achievement.name}</h4>
                                                    <p className="text-sm text-text-muted">{achievement.description}</p>
                                                </div>
                                                <div className="text-lg font-bold text-text-muted">+{achievement.points}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {lockedAchievements.length > 9 && viewMode === 'grid' && (
                                <div className="text-center mt-4">
                                    <span className="text-sm text-text-muted">
                                        ...and {lockedAchievements.length - 9} more locked badges
                                    </span>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Actions */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 pt-4">
                        <Button variant="outline" className="w-full" onClick={onClose}>
                            Close Dashboard
                        </Button>
                        <Button variant="danger" className="w-full" onClick={handleReset}>
                            <Trash2 size={16} className="mr-2" />
                            Reset All Progress
                        </Button>
                    </div>
                </div>
            );
        };

        // === NEW: Improved Time Input Component ===
        const TimeInput = ({ value, onChange, min = 1, max = 180, step = 1 }) => {
            const [inputValue, setInputValue] = useState(value.toString());
            const [isEditing, setIsEditing] = useState(false);
            
            useEffect(() => {
                setInputValue(value.toString());
            }, [value]);
            
            const handleInputChange = (e) => {
                const newValue = e.target.value;
                setInputValue(newValue);
                
                // Validate and update parent
                const numValue = parseInt(newValue);
                if (!isNaN(numValue) && numValue >= min && numValue <= max) {
                    onChange(numValue);
                }
            };
            
            const handleSliderChange = (e) => {
                const newValue = parseInt(e.target.value);
                onChange(newValue);
                setInputValue(newValue.toString());
            };
            
            const handleBlur = () => {
                setIsEditing(false);
                const numValue = parseInt(inputValue);
                if (isNaN(numValue) || numValue < min || numValue > max) {
                    setInputValue(value.toString());
                }
            };
            
            const increment = () => {
                if (value < max) {
                    const newValue = value + step;
                    onChange(newValue);
                    setInputValue(newValue.toString());
                }
            };
            
            const decrement = () => {
                if (value > min) {
                    const newValue = value - step;
                    onChange(newValue);
                    setInputValue(newValue.toString());
                }
            };
            
            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <label className="text-sm font-bold text-text-muted flex items-center gap-2">
                            <Clock size={16} /> Duration (minutes)
                        </label>
                        <div className="text-xl font-bold text-primary">{value} min</div>
                    </div>
                    
                    {/* Manual Input */}
                    <div className="flex items-center gap-3">
                        <button
                            onClick={decrement}
                            className="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center hover:bg-black/30 transition-colors disabled:opacity-30"
                            disabled={value <= min}
                        >
                            <ChevronDown size={20} />
                        </button>
                        
                        <div className="flex-1">
                            {isEditing ? (
                                <input
                                    type="number"
                                    value={inputValue}
                                    onChange={handleInputChange}
                                    onBlur={handleBlur}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            setIsEditing(false);
                                            handleBlur();
                                        }
                                    }}
                                    min={min}
                                    max={max}
                                    step={step}
                                    className="w-full p-3 bg-black/20 rounded-xl border border-primary text-center text-lg font-bold outline-none"
                                    autoFocus
                                />
                            ) : (
                                <button
                                    onClick={() => setIsEditing(true)}
                                    className="w-full p-3 bg-black/20 rounded-xl border border-white/10 text-center text-lg font-bold hover:border-primary/50 transition-colors"
                                >
                                    {value} minutes
                                    <div className="text-xs text-text-muted mt-1">Click to edit manually</div>
                                </button>
                            )}
                        </div>
                        
                        <button
                            onClick={increment}
                            className="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center hover:bg-black/30 transition-colors disabled:opacity-30"
                            disabled={value >= max}
                        >
                            <ChevronUp size={20} />
                        </button>
                    </div>
                    
                    {/* Quick Presets */}
                    <div className="flex gap-2">
                        {[5, 15, 30, 45, 60].map(preset => (
                            <button
                                key={preset}
                                onClick={() => {
                                    onChange(preset);
                                    setInputValue(preset.toString());
                                }}
                                className={cn(
                                    "flex-1 py-2 rounded-lg text-sm font-medium transition-all",
                                    value === preset
                                        ? "bg-primary text-white shadow-lg shadow-primary/30"
                                        : "bg-black/20 text-text-muted hover:bg-black/30"
                                )}
                            >
                                {preset} min
                            </button>
                        ))}
                    </div>
                    
                    {/* Slider */}
                    <div className="pt-2">
                        <input
                            type="range"
                            min={min}
                            max={max}
                            value={value}
                            onChange={handleSliderChange}
                            className="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary [&::-webkit-slider-thumb]:shadow-lg"
                        />
                        <div className="flex justify-between text-xs text-text-muted mt-1">
                            <span>{min} min</span>
                            <span>{max} min</span>
                        </div>
                    </div>
                </div>
            );
        };

        // === NEW: Voice-to-Text Essay Component ===
        const VoiceEssayInput = ({ value, onChange, disabled, placeholder }) => {
            const [isListening, setIsListening] = useState(false);
            const [interimTranscript, setInterimTranscript] = useState('');
            
            useEffect(() => {
                // Setup voice recognition callbacks
                voiceToTextManager.onTranscript = (transcript, interim) => {
                    if (!disabled) {
                        onChange(transcript);
                        setInterimTranscript(interim);
                    }
                };
                
                voiceToTextManager.onError = (error) => {
                    console.error('Voice recognition error:', error);
                    setIsListening(false);
                    if (error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access to use voice-to-text.');
                    }
                };
                
                voiceToTextManager.onEnd = () => {
                    setIsListening(false);
                    setInterimTranscript('');
                };
                
                return () => {
                    voiceToTextManager.onTranscript = null;
                    voiceToTextManager.onError = null;
                    voiceToTextManager.onEnd = null;
                };
            }, [disabled, onChange]);
            
            const toggleListening = () => {
                if (disabled) return;
                
                if (isListening) {
                    voiceToTextManager.stop();
                    setIsListening(false);
                } else {
                    if (voiceToTextManager.isAvailable()) {
                        const success = voiceToTextManager.start();
                        if (success) {
                            setIsListening(true);
                            sfx.click();
                        } else {
                            alert('Failed to start voice recognition. Please try again.');
                        }
                    } else {
                        alert('Voice recognition is not supported in your browser. Try Chrome or Edge.');
                    }
                }
            };
            
            const handleTextChange = (e) => {
                if (!disabled) {
                    onChange(e.target.value);
                }
            };
            
            return (
                <div className="relative">
                    <textarea
                        value={value}
                        onChange={handleTextChange}
                        disabled={disabled}
                        placeholder={placeholder}
                        className="w-full min-h-[200px] p-6 rounded-2xl bg-surface border-2 outline-none text-text transition-all resize-y glass border-white/10 focus:border-primary/50 focus:shadow-lg"
                    />
                    
                    {/* Voice Controls */}
                    <div className="absolute bottom-4 right-4 flex gap-2">
                        {voiceToTextManager.isAvailable() && (
                            <Button
                                variant={isListening ? "danger" : "outline"}
                                size="icon"
                                onClick={toggleListening}
                                disabled={disabled}
                                className={cn(
                                    "shadow-lg",
                                    isListening && "animate-pulse bg-red-500 border-red-500 text-white"
                                )}
                                title={isListening ? "Stop recording" : "Start voice typing"}
                            >
                                {isListening ? (
                                    <div className="w-4 h-4 bg-white rounded-full animate-pulse" />
                                ) : (
                                    <Mic size={18} />
                                )}
                            </Button>
                        )}
                        
                        {value && (
                            <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => onChange('')}
                                disabled={disabled}
                                title="Clear text"
                            >
                                <Trash2 size={18} />
                            </Button>
                        )}
                    </div>
                    
                    {/* Listening Indicator */}
                    {isListening && (
                        <div className="absolute top-4 right-4 flex items-center gap-2 animate-fade-in">
                            <div className="flex gap-1">
                                <div className="w-1 h-3 bg-red-500 rounded-full animate-pulse" style={{ animationDelay: '0ms' }}></div>
                                <div className="w-1 h-4 bg-red-500 rounded-full animate-pulse" style={{ animationDelay: '100ms' }}></div>
                                <div className="w-1 h-5 bg-red-500 rounded-full animate-pulse" style={{ animationDelay: '200ms' }}></div>
                            </div>
                            <span className="text-xs text-red-500 font-medium">Listening...</span>
                        </div>
                    )}
                    
                    {/* Interim Transcript */}
                    {interimTranscript && !isListening && (
                        <div className="absolute top-4 left-4 animate-fade-in">
                            <span className="text-xs text-text-muted italic">Processing...</span>
                        </div>
                    )}
                    
                    {/* Microphone Access Warning */}
                    {!voiceToTextManager.isAvailable() && (
                        <div className="absolute top-4 right-4">
                            <div className="text-xs text-text-muted bg-black/20 px-2 py-1 rounded">
                                Voice not supported
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // === NEW: Enhanced Question Card with Voice-to-Text and Fixed Essay Evaluation ===
        const EnhancedQuestionCard = ({ question, selectedAnswer, onSelectAnswer, isReviewMode, isCorrect, showFeedback, onAddToBank }) => {
            const [showExplanation, setShowExplanation] = useState(false);
            const [essayFeedback, setEssayFeedback] = useState(null);
            const isResultVisible = isReviewMode || (showFeedback && selectedAnswer);
            const isDisabled = isReviewMode || (showFeedback && !!selectedAnswer);
            
            useEffect(() => {
                if (isResultVisible && question.isEssay && selectedAnswer) {
                    const feedback = essayEvaluator.getEssayFeedback(selectedAnswer, question.correctAnswer);
                    setEssayFeedback(feedback);
                }
            }, [isResultVisible, question.isEssay, selectedAnswer, question.correctAnswer]);
            
            // Fixed: Determine if answer is correct based on question type
            const getIsCorrect = () => {
                if (!selectedAnswer) return false;
                
                if (question.isEssay) {
                    // Use essay evaluator for essays
                    return essayEvaluator.evaluateEssayAnswer(selectedAnswer, question.correctAnswer);
                } else {
                    // Use exact or prefix matching for MCQ
                    return selectedAnswer === question.correctAnswer || 
                           selectedAnswer.startsWith(question.correctAnswer) ||
                           question.correctAnswer.startsWith(selectedAnswer);
                }
            };
            
            const isAnswerCorrect = getIsCorrect();
            
            return (
                <div className="flex flex-col gap-6 animate-slide-in-right w-full max-w-3xl mx-auto">
                    <div className="glass p-6 md:p-8 rounded-2xl shadow-xl transition-all duration-300 hover:shadow-2xl hover:bg-surface/80">
                        {question.imageUrl && (
                            <div className="mb-6 rounded-xl overflow-hidden border border-white/10 bg-black/20">
                                <img src={question.imageUrl} alt="Question Reference" className="w-full h-auto max-h-[300px] object-contain mx-auto" loading="lazy" />
                            </div>
                        )}
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex gap-2">
                                {question.category && (
                                    <span className="px-2 py-1 text-xs font-bold bg-primary/20 text-primary rounded-full">
                                        {question.category}
                                    </span>
                                )}
                                {question.difficulty && (
                                    <span className={cn(
                                        "px-2 py-1 text-xs font-bold rounded-full",
                                        question.difficulty === 'Easy' ? 'bg-green-500/20 text-green-500' :
                                        question.difficulty === 'Medium' ? 'bg-yellow-500/20 text-yellow-500' :
                                        'bg-red-500/20 text-red-500'
                                    )}>
                                        {question.difficulty}
                                    </span>
                                )}
                            </div>
                            {question.isEssay && (
                                <span className="px-2 py-1 text-xs font-bold bg-purple-500/20 text-purple-500 rounded-full">
                                    Essay
                                </span>
                            )}
                        </div>
                        <h3 className="text-lg md:text-xl font-semibold leading-relaxed text-text">{question.text}</h3>
                        
                        {isReviewMode && (
                            <div className="mt-4 flex justify-end gap-2">
                                {question.explanation && (
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={() => setShowExplanation(!showExplanation)}
                                        className="flex items-center gap-2"
                                    >
                                        <HelpCircle size={16} />
                                        {showExplanation ? "Hide Explanation" : "Explain This Question"}
                                    </Button>
                                )}
                                <Button
                                    variant="success"
                                    size="sm"
                                    onClick={() => {
                                        if (onAddToBank) {
                                            onAddToBank(question);
                                        }
                                    }}
                                    className="flex items-center gap-2 hover:scale-105 transition-transform"
                                    title="Save this question to your question bank"
                                >
                                    <Save size={16} />
                                    Save to Bank
                                </Button>
                            </div>
                        )}
                    </div>
                    
                    {showExplanation && question.explanation && (
                        <div className="glass p-6 rounded-2xl border border-blue-500/30 bg-blue-500/5 animate-fade-in">
                            <div className="flex items-center gap-2 mb-3">
                                <div className="w-6 h-6 rounded-full bg-blue-500/20 flex items-center justify-center">
                                    <HelpCircle size={14} className="text-blue-400" />
                                </div>
                                <h4 className="font-bold text-blue-400">Explanation</h4>
                            </div>
                            <p className="text-text leading-relaxed">{question.explanation}</p>
                            {question.isEssay && (
                                <div className="mt-4 p-3 bg-blue-500/10 rounded-lg border border-blue-500/20">
                                    <p className="text-sm text-blue-300 font-medium mb-1">Essay Tips:</p>
                                    <p className="text-sm text-blue-200">Focus on key concepts and provide clear examples in your response.</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    <div className="flex flex-col gap-3">
                        {question.isEssay ? (
                            <div className="relative animate-fade-in-up">
                                {/* Use VoiceEssayInput for essay questions */}
                                <VoiceEssayInput
                                    value={selectedAnswer || ''}
                                    onChange={(text) => !isDisabled && onSelectAnswer(text)}
                                    disabled={isDisabled}
                                    placeholder="Type your answer here, or click the microphone to use voice-to-text..."
                                />
                                {isResultVisible && essayFeedback && (
                                    <div className="mt-4 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 animate-fade-in">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-bold text-blue-400">Essay Evaluation</h4>
                                            <div className={cn(
                                                "px-3 py-1 rounded-full text-sm font-bold",
                                                essayFeedback.score >= 90 ? "bg-green-500/20 text-green-500" :
                                                essayFeedback.score >= 75 ? "bg-yellow-500/20 text-yellow-500" :
                                                essayFeedback.score >= 60 ? "bg-orange-500/20 text-orange-500" :
                                                "bg-red-500/20 text-red-500"
                                            )}>
                                                Score: {essayFeedback.score}%
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <p className="text-sm"><span className="font-medium text-blue-300">Grade:</span> {essayFeedback.grade}</p>
                                            <p className="text-sm"><span className="font-medium text-blue-300">Feedback:</span> {essayFeedback.feedback}</p>
                                            {essayFeedback.studentKeyTerms.length > 0 && (
                                                <div className="mt-2">
                                                    <p className="text-xs text-blue-300 font-medium mb-1">Key terms you mentioned:</p>
                                                    <div className="flex flex-wrap gap-1">
                                                        {essayFeedback.studentKeyTerms.map((term, idx) => (
                                                            <span key={idx} className="px-2 py-0.5 bg-blue-500/20 text-blue-300 text-xs rounded">
                                                                {term}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            <div className="mt-3 pt-3 border-t border-blue-500/20">
                                                <p className="text-sm text-blue-300 font-medium mb-1">Expected Key Points:</p>
                                                <p className="text-sm text-text">{question.correctAnswer}</p>
                                            </div>
                                            {question.explanation && (
                                                <div className="mt-2 pt-2 border-t border-blue-500/20">
                                                    <p className="text-xs text-blue-300 font-medium">Additional Explanation:</p>
                                                    <p className="text-xs text-blue-200">{question.explanation}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            question.options.map((option, idx) => {
                                const isSelected = selectedAnswer === option;
                                const isOptionCorrect = essayEvaluator.isCorrect(option, question.correctAnswer, false);
                                
                                let variantStyles = "border-white/10 hover:border-primary/50 hover:bg-white/5";
                                let circleStyles = "border-text-muted group-hover:border-primary";
                                let icon = null;
                                let animationClass = "animate-fade-in-up";
                                
                                if (isResultVisible) {
                                    if (isOptionCorrect) {
                                        variantStyles = "border-green-500/50 bg-green-500/5"; 
                                        circleStyles = "border-green-500 bg-green-500 text-white shadow-lg shadow-green-500/30"; 
                                        icon = <Check size={16} strokeWidth={3} />; 
                                        animationClass = "animate-success-pop";
                                    } else if (isSelected) {
                                        variantStyles = "border-red-500/50 bg-red-500/5"; 
                                        circleStyles = "border-red-500 bg-red-500 text-white shadow-lg shadow-red-500/30"; 
                                        icon = <X size={16} strokeWidth={3} />; 
                                        animationClass = "animate-shake";
                                    } else {
                                        variantStyles = "border-transparent opacity-40"; 
                                        circleStyles = "border-white/20 text-transparent";
                                    }
                                } else if (isSelected) {
                                    variantStyles = "border-primary bg-primary/10 shadow-lg shadow-primary/20"; 
                                    circleStyles = "border-primary bg-primary text-white"; 
                                    icon = <div className="w-2.5 h-2.5 bg-white rounded-full animate-bounce-soft" />; 
                                    animationClass = "animate-select-pop";
                                }
                                
                                const delay = animationClass === "animate-fade-in-up" ? `${idx * 75}ms` : '0ms';
                                return (
                                    <button
                                        key={idx} 
                                        onClick={() => !isDisabled && onSelectAnswer(option)} 
                                        disabled={isDisabled} 
                                        style={{ animationDelay: delay }}
                                        className={cn("group relative flex items-center gap-4 p-4 md:p-5 rounded-xl border-2 text-left transition-all duration-300 hardware-accelerated glass opacity-0", variantStyles, animationClass)}
                                    >
                                        <div className={cn("w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all duration-300 flex-shrink-0", circleStyles)}>
                                            {icon}
                                        </div>
                                        <span className={cn("text-base md:text-lg font-medium transition-colors", isSelected || (isResultVisible && isOptionCorrect) ? "text-text" : "text-text")}>
                                            {option}
                                        </span>
                                    </button>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        // === NEW: AI Generator Component (with real API) ===
        const AIGeneratorModal = ({ onClose, onQuestionsGenerated }) => {
            const [topic, setTopic] = useState('');
            const [difficulty, setDifficulty] = useState('Medium');
            const [count, setCount] = useState(5);
            const [questionType, setQuestionType] = useState('mixed');
            const [apiKey, setApiKey] = useState(localStorage.getItem('openai_api_key') || '');
            const [saveApiKey, setSaveApiKey] = useState(!!localStorage.getItem('openai_api_key'));
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedQuestions, setGeneratedQuestions] = useState([]);
            const [error, setError] = useState('');
            
            const handleGenerate = async () => {
                if (!topic.trim()) {
                    setError('Please enter a topic');
                    return;
                }
                
                setIsGenerating(true);
                setError('');
                
                try {
                    const questions = await generateAIQuestions(topic, difficulty, count, apiKey || null);
                    setGeneratedQuestions(questions);
                    
                    // Record AI usage for gamification
                    gamificationManager.recordAIUsage();
                    
                    // Save API key if requested
                    if (saveApiKey && apiKey) {
                        localStorage.setItem('openai_api_key', apiKey);
                    } else if (!saveApiKey) {
                        localStorage.removeItem('openai_api_key');
                    }
                } catch (error) {
                    console.error('AI Generation Error:', error);
                    setError(`Failed to generate questions: ${error.message}. Using mock questions instead.`);
                    
                    // Fallback to mock questions
                    const mockQuestions = await generateAIQuestions(topic, difficulty, count, null);
                    setGeneratedQuestions(mockQuestions);
                } finally {
                    setIsGenerating(false);
                }
            };
            
            const handleUseQuestions = () => {
                const questions = generatedQuestions;
                onQuestionsGenerated(questions);
                onClose();
            };
            
            const handleSaveToBank = () => {
                const addedCount = questionBankManager.addQuestions(generatedQuestions);
                sfx.success();
                alert(`Added ${addedCount} AI-generated questions to your bank!`);
            };
            
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <label className="text-sm font-bold text-text-muted">Topic/Subject</label>
                            <input
                                type="text"
                                value={topic}
                                onChange={(e) => setTopic(e.target.value)}
                                className="w-full p-3 bg-black/20 rounded-xl border border-white/10 focus:border-primary outline-none"
                                placeholder="e.g., Machine Learning, Calculus, History"
                            />
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-sm font-bold text-text-muted">Difficulty</label>
                            <select
                                value={difficulty}
                                onChange={(e) => setDifficulty(e.target.value)}
                                className="w-full p-3 bg-black/20 rounded-xl border border-white/10 focus:border-primary outline-none"
                            >
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-sm font-bold text-text-muted">Number of Questions</label>
                            <input
                                type="range"
                                min="2"
                                max="20"
                                value={count}
                                onChange={(e) => setCount(parseInt(e.target.value))}
                                className="w-full"
                            />
                            <div className="text-center text-lg font-bold text-primary">{count}</div>
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-sm font-bold text-text-muted">Question Type</label>
                            <div className="flex gap-2">
                                {['mcq', 'essay', 'mixed'].map(type => (
                                    <button
                                        key={type}
                                        onClick={() => setQuestionType(type)}
                                        className={cn(
                                            "flex-1 p-2 rounded-lg border text-sm transition-all",
                                            questionType === type
                                                ? "border-primary bg-primary/10 text-primary"
                                                : "border-white/10 hover:border-primary/50"
                                        )}
                                    >
                                        {type === 'mcq' ? 'MCQ Only' : type === 'essay' ? 'Essay Only' : 'Mixed'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* API Key Section */}
                    <div className="glass p-4 rounded-xl">
                        <div className="flex items-center gap-2 mb-2">
                            <Key size={16} className="text-purple-500" />
                            <label className="text-sm font-bold text-text-muted">OpenAI API Key (Optional)</label>
                        </div>
                        <input
                            type="password"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                            className="w-full p-2 bg-black/20 rounded-lg border border-white/10 text-sm mb-2"
                            placeholder="sk-... (Leave empty for mock questions)"
                        />
                        <div className="flex items-center gap-2">
                            <input
                                type="checkbox"
                                id="saveApiKey"
                                checked={saveApiKey}
                                onChange={(e) => setSaveApiKey(e.target.checked)}
                                className="w-4 h-4 accent-primary"
                            />
                            <label htmlFor="saveApiKey" className="text-xs text-text-muted">
                                Save API key locally (not recommended on shared devices)
                            </label>
                        </div>
                        <p className="text-xs text-text-muted mt-2">
                            Without an API key, mock questions will be generated. Get your key from{' '}
                            <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-primary hover:underline">
                                OpenAI Platform
                            </a>
                        </p>
                    </div>
                    
                    {/* Error Display */}
                    {error && (
                        <div className="p-3 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg">
                            <p className="text-sm">{error}</p>
                        </div>
                    )}
                    
                    <Button
                        variant="ai"
                        className="w-full py-4"
                        onClick={handleGenerate}
                        isLoading={isGenerating}
                    >
                        <Brain size={20} className="mr-2" />
                        {isGenerating ? 'Generating AI Questions...' : 'Generate AI Questions'}
                    </Button>
                    
                    {generatedQuestions.length > 0 && (
                        <div className="space-y-4 animate-fade-in">
                            <h3 className="font-bold text-lg">Generated Questions ({generatedQuestions.length})</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {generatedQuestions.map((q, idx) => (
                                    <div key={q.id} className="glass p-3 rounded-lg">
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <p className="font-medium">{idx + 1}. {q.text}</p>
                                                <p className="text-xs text-text-muted mt-1">
                                                    {q.category} • {q.difficulty} • {q.isEssay ? 'Essay' : 'MCQ'}
                                                </p>
                                            </div>
                                            <Star size={16} className="text-yellow-500" />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <Button variant="outline" onClick={() => setGeneratedQuestions([])}>
                                    Clear
                                </Button>
                                <Button variant="success" onClick={handleSaveToBank}>
                                    Save to Bank
                                </Button>
                                <Button onClick={handleUseQuestions}>
                                    Use These Questions
                                </Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // === NEW: Toolbar with All Features ===
        const EnhancedToolbar = ({ 
            onExport, 
            onAnalytics, 
            onAIGenerate, 
            onStudyPlan, 
            onExamHistory,
            onQuestionBank,
            onGamification,
            isRunning 
        }) => {
            const [showTools, setShowTools] = useState(false);
            const [unlockedCount, setUnlockedCount] = useState(0);
            
            useEffect(() => {
                const unlocked = gamificationManager.getUnlockedAchievements().length;
                setUnlockedCount(unlocked);
            }, []);
            
            return (
                <div className="fixed bottom-6 right-6 z-40 flex flex-col items-end gap-2">
                    {showTools && (
                        <div className="flex flex-col gap-2 mb-2 animate-fade-in-up">
                            {/* Gamification Button with Badge */}
                            <div className="relative">
                                <Button variant="success" size="icon" onClick={onGamification} title="Gamification Dashboard">
                                    <AwardIcon size={20} />
                                </Button>
                                {unlockedCount > 0 && (
                                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center text-xs font-bold animate-bounce-soft">
                                        {unlockedCount}
                                    </div>
                                )}
                            </div>
                            
                            {!isRunning && (
                                <>
                                    <Button variant="ai" size="icon" onClick={onAIGenerate} title="Generate AI Questions">
                                        <Brain size={20} />
                                    </Button>
                                    <Button variant="secondary" size="icon" onClick={onAnalytics} title="View Analytics">
                                        <BarChart size={20} />
                                    </Button>
                                    <Button variant="outline" size="icon" onClick={onQuestionBank} title="Question Bank">
                                        <BookOpen size={20} />
                                    </Button>
                                </>
                            )}
                            <Button variant="outline" size="icon" onClick={onExamHistory} title="Exam History">
                                <History size={20} />
                            </Button>
                            <Button variant="primary" size="icon" onClick={onExport} title="Export Results">
                                <Download size={20} />
                            </Button>
                        </div>
                    )}
                    
                    <Button
                        variant="primary"
                        size="icon"
                        className="shadow-2xl"
                        onClick={() => setShowTools(!showTools)}
                    >
                        {showTools ? <ChevronDown size={24} /> : <Plus size={24} />}
                    </Button>
                </div>
            );
        };

        // === NEW: Achievement Popup Component ===
        const AchievementPopup = ({ achievement, onClose }) => {
            const [isVisible, setIsVisible] = useState(true);
            
            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsVisible(false);
                    setTimeout(onClose, 300);
                }, 5000);
                
                return () => clearTimeout(timer);
            }, [onClose]);
            
            if (!isVisible) return null;
            
            return (
                <div className="fixed top-6 right-6 z-50 animate-fade-in">
                    <div className="glass p-4 rounded-2xl border-2 border-yellow-500/50 shadow-2xl max-w-sm animate-badge-pop">
                        <div className="flex items-center gap-3">
                            <div className="text-3xl">{achievement.icon}</div>
                            <div className="flex-1">
                                <h3 className="font-bold text-yellow-500">Achievement Unlocked!</h3>
                                <h4 className="font-bold text-lg">{achievement.name}</h4>
                                <p className="text-sm text-text-muted">{achievement.description}</p>
                                <div className="flex items-center justify-between mt-2">
                                    <span className="text-xs text-text-muted">+{achievement.points} points</span>
                                    <span className="text-xs text-text-muted">Tap to close</span>
                                </div>
                            </div>
                        </div>
                        <div className="w-full h-1 bg-yellow-500/20 rounded-full mt-3 overflow-hidden">
                            <div className="h-full bg-yellow-500 rounded-full animate-progress-grow" style={{ '--target-width': '100%' }}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // === Question Map Component ===
        const QuestionMap = React.memo(({ totalQuestions, currentIndex, answers, flagged, onNavigate, className, isReviewMode, correctAnswers, showInstantFeedback }) => {
            return (
                <div className={cn("grid grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3 content-start p-1", className)}>
                    {Array.from({ length: totalQuestions }).map((_, idx) => {
                        const isAnswered = answers[idx] !== undefined;
                        const isCurrent = currentIndex === idx;
                        const isFlagged = flagged.has(idx);
                        let isCorrect = undefined;
                        if (isReviewMode) isCorrect = correctAnswers?.[idx];
                        else if (showInstantFeedback && isAnswered) isCorrect = correctAnswers?.[idx];
                        let statusColor = "bg-surface border-white/10 text-text-muted hover:border-primary/50";
                        if (isCorrect === true) statusColor = "bg-green-500 border-green-500 text-white";
                        else if (isCorrect === false) statusColor = "bg-red-500 border-red-500 text-white";
                        else {
                            if (isAnswered) statusColor = "bg-secondary border-secondary text-white shadow-lg shadow-secondary/20";
                            else if (isFlagged) statusColor = "bg-yellow-500 border-yellow-500 text-white";
                        }
                        if (isCurrent) statusColor = "bg-primary border-primary text-white ring-4 ring-primary/20 scale-110 z-10";
                        return (
                            <button key={idx} onClick={() => onNavigate(idx)} className={cn("relative aspect-square rounded-xl border flex items-center justify-center text-sm font-bold transition-all duration-200 hardware-accelerated", statusColor)}>
                                {idx + 1}
                                {isFlagged && !isReviewMode && !isCorrect && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-bg shadow-sm" />}
                            </button>
                        );
                    })}
                </div>
            );
        });
        
        // === NEW: Analytics Dashboard Component (Fixed for essays) ===
        const AnalyticsDashboard = ({ questions, answers, onClose }) => {
            const [selectedChart, setSelectedChart] = useState('overview');
            const [selectedTimeRange, setSelectedTimeRange] = useState('all');
            const [exportFormat, setExportFormat] = useState('pdf');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const pieChartRef = useRef(null);
            const pieChartInstance = useRef(null);
            
            const analytics = calculateAnalytics(questions, answers);
            
            // Initialize charts
            useEffect(() => {
                // Destroy existing charts
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                if (pieChartInstance.current) {
                    pieChartInstance.current.destroy();
                }
                
                // Main chart
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    let data, config;
                    
                    switch(selectedChart) {
                        case 'accuracy':
                            config = {
                                type: 'doughnut',
                                data: {
                                    labels: ['Correct', 'Incorrect', 'Unanswered'],
                                    datasets: [{
                                        data: [
                                            analytics.accuracy,
                                            100 - analytics.accuracy - ((analytics.unansweredQuestions / questions.length) * 100),
                                            (analytics.unansweredQuestions / questions.length) * 100
                                        ],
                                        backgroundColor: [
                                            'rgb(16, 185, 129)',
                                            'rgb(239, 68, 68)',
                                            'rgb(148, 163, 184)'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    cutout: '70%',
                                    plugins: {
                                        legend: { 
                                            position: 'bottom',
                                            labels: {
                                                color: 'rgb(var(--color-text))',
                                                font: {
                                                    size: 12
                                                },
                                                padding: 20
                                            }
                                        }
                                    }
                                }
                            };
                            break;
                            
                        case 'categories':
                            const categories = Object.keys(analytics.byCategory);
                            config = {
                                type: 'bar',
                                data: {
                                    labels: categories,
                                    datasets: [{
                                        label: 'Accuracy %',
                                        data: categories.map(cat => {
                                            const data = analytics.byCategory[cat];
                                            return Math.round((data.correct / data.total) * 100);
                                        }),
                                        backgroundColor: 'rgb(99, 102, 241)',
                                        borderRadius: 6,
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: { 
                                            beginAtZero: true, 
                                            max: 100,
                                            ticks: {
                                                color: 'rgb(var(--color-text-muted))',
                                                font: {
                                                    size: 11
                                                }
                                            },
                                            grid: {
                                                color: 'rgba(var(--color-text), 0.1)'
                                            }
                                        },
                                        x: {
                                            ticks: {
                                                color: 'rgb(var(--color-text-muted))',
                                                font: {
                                                    size: 11
                                                },
                                                maxRotation: 45,
                                                minRotation: 45
                                            },
                                            grid: {
                                                display: false
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            };
                            break;
                            
                        case 'difficulty':
                            const difficulties = Object.keys(analytics.byDifficulty);
                            config = {
                                type: 'pie',
                                data: {
                                    labels: difficulties,
                                    datasets: [{
                                        data: difficulties.map(diff => {
                                            const data = analytics.byDifficulty[diff];
                                            return Math.round((data.correct / data.total) * 100);
                                        }),
                                        backgroundColor: [
                                            'rgb(34, 197, 94)',
                                            'rgb(234, 179, 8)',
                                            'rgb(239, 68, 68)'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                color: 'rgb(var(--color-text))',
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        }
                                    }
                                }
                            };
                            break;
                            
                        default: // overview
                            config = {
                                type: 'radar',
                                data: {
                                    labels: ['Accuracy', 'Speed', 'Consistency', 'Difficulty', 'Coverage'],
                                    datasets: [{
                                        label: 'Your Performance',
                                        data: [
                                            analytics.accuracy,
                                            75, // Speed (mock)
                                            60, // Consistency (mock)
                                            Object.values(analytics.byDifficulty).reduce((acc, d, i, arr) => {
                                                const weight = d.difficulty === 'Easy' ? 1 : d.difficulty === 'Medium' ? 2 : d.difficulty === 'Hard' ? 3 : 1;
                                                return acc + (weight * (d.total / questions.length));
                                            }, 0) * 33, // Difficulty score
                                            Math.min(Object.keys(analytics.byCategory).length * 20, 100) // Coverage
                                        ],
                                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                                        borderColor: 'rgb(99, 102, 241)',
                                        borderWidth: 2,
                                        pointBackgroundColor: 'rgb(99, 102, 241)',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2,
                                        pointRadius: 4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        r: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: {
                                                display: false,
                                                stepSize: 20,
                                                backdropColor: 'transparent'
                                            },
                                            pointLabels: {
                                                color: 'rgb(var(--color-text))',
                                                font: {
                                                    size: 13,
                                                    weight: 'bold'
                                                },
                                                padding: 15
                                            },
                                            grid: {
                                                color: 'rgba(var(--color-text), 0.1)',
                                                circular: true
                                            },
                                            angleLines: {
                                                color: 'rgba(var(--color-text), 0.1)'
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            labels: {
                                                color: 'rgb(var(--color-text))',
                                                font: {
                                                    size: 14,
                                                    weight: 'bold'
                                                }
                                            }
                                        }
                                    }
                                }
                            };
                    }
                    
                    chartInstance.current = new Chart(ctx, config);
                }
                
                // Pie chart for distribution
                if (pieChartRef.current) {
                    const ctx = pieChartRef.current.getContext('2d');
                    pieChartInstance.current = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Excellent (90-100%)', 'Good (70-89%)', 'Average (50-69%)', 'Poor (0-49%)'],
                            datasets: [{
                                data: [
                                    analytics.scoreDistribution.excellent,
                                    analytics.scoreDistribution.good,
                                    analytics.scoreDistribution.average,
                                    analytics.scoreDistribution.poor
                                ],
                                backgroundColor: [
                                    'rgb(34, 197, 94)',
                                    'rgb(59, 130, 246)',
                                    'rgb(234, 179, 8)',
                                    'rgb(239, 68, 68)'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'rgb(var(--color-text))',
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    if (pieChartInstance.current) {
                        pieChartInstance.current.destroy();
                    }
                };
            }, [selectedChart, analytics]);
            
            // Export functions
            const exportData = () => {
                if (exportFormat === 'pdf') {
                    const pdfData = questions.map((q, idx) => {
                        const userAnswer = answers[idx] || 'Not answered';
                        let isCorrect = false;
                        let score = 0;
                        
                        if (userAnswer !== 'Not answered') {
                            if (q.isEssay) {
                                isCorrect = essayEvaluator.evaluateEssayAnswer(userAnswer, q.correctAnswer);
                                score = essayEvaluator.getEssayScore(userAnswer, q.correctAnswer);
                            } else {
                                isCorrect = essayEvaluator.isCorrect(userAnswer, q.correctAnswer, false);
                                score = isCorrect ? 100 : 0;
                            }
                        }
                        
                        return {
                            question: q.text,
                            yourAnswer: userAnswer,
                            correctAnswer: q.correctAnswer,
                            correct: isCorrect ? '✓ Correct' : '✗ Incorrect',
                            score: q.isEssay ? `${score}%` : (isCorrect ? '100%' : '0%'),
                            category: q.category || 'General',
                            difficulty: q.difficulty || 'Medium',
                            timeSpent: analytics.timePerQuestion[idx] || 'N/A'
                        };
                    });
                    exportToPDF('Performance_Analytics', pdfData);
                    sfx.success();
                } else if (exportFormat === 'csv') {
                    // Export as CSV
                    const csvContent = [
                        ['Question', 'Your Answer', 'Correct Answer', 'Correct', 'Score', 'Category', 'Difficulty', 'Time Spent (s)'],
                        ...questions.map((q, idx) => {
                            const userAnswer = answers[idx] || 'Not answered';
                            let isCorrect = false;
                            let score = 0;
                            
                            if (userAnswer !== 'Not answered') {
                                if (q.isEssay) {
                                    isCorrect = essayEvaluator.evaluateEssayAnswer(userAnswer, q.correctAnswer);
                                    score = essayEvaluator.getEssayScore(userAnswer, q.correctAnswer);
                                } else {
                                    isCorrect = essayEvaluator.isCorrect(userAnswer, q.correctAnswer, false);
                                    score = isCorrect ? 100 : 0;
                                }
                            }
                            
                            return [
                                q.text,
                                userAnswer,
                                q.correctAnswer,
                                isCorrect ? 'Yes' : 'No',
                                q.isEssay ? `${score}%` : (isCorrect ? '100%' : '0%'),
                                q.category || 'General',
                                q.difficulty || 'Medium',
                                analytics.timePerQuestion[idx] || 'N/A'
                            ];
                        })
                    ].map(row => row.join(',')).join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analytics_${Date.now()}.csv`;
                    a.click();
                    sfx.success();
                }
            };
            
            return (
                <div className="space-y-6">
                    {/* Chart Selection */}
                    <div className="grid grid-cols-4 gap-2">
                        {['overview', 'accuracy', 'categories', 'difficulty'].map(chart => (
                            <button
                                key={chart}
                                onClick={() => setSelectedChart(chart)}
                                className={cn(
                                    "p-3 rounded-lg text-sm font-semibold transition-all duration-200",
                                    selectedChart === chart 
                                        ? "bg-primary text-white shadow-lg shadow-primary/30"
                                        : "bg-surface hover:bg-surface/80 text-text-muted"
                                )}
                            >
                                {chart.charAt(0).toUpperCase() + chart.slice(1)}
                            </button>
                        ))}
                    </div>
                    
                    {/* Main Chart */}
                    <div className="h-64 w-full glass rounded-xl p-4">
                        <canvas ref={chartRef} className="w-full h-full" />
                    </div>
                    
                    {/* Key Metrics */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div className="glass p-4 rounded-xl text-center">
                            <div className="text-2xl font-bold text-primary">{analytics.accuracy}%</div>
                            <div className="text-sm text-text-muted">Accuracy</div>
                        </div>
                        <div className="glass p-4 rounded-xl text-center">
                            <div className="text-2xl font-bold text-secondary">{analytics.answeredQuestions}/{analytics.totalQuestions}</div>
                            <div className="text-sm text-text-muted">Answered</div>
                        </div>
                        <div className="glass p-4 rounded-xl text-center">
                            <div className="text-2xl font-bold text-accent">{analytics.averageTimePerQuestion}s</div>
                            <div className="text-sm text-text-muted">Avg Time/Q</div>
                        </div>
                        <div className="glass p-4 rounded-xl text-center">
                            <div className="text-2xl font-bold text-purple-500">
                                {Object.keys(analytics.byCategory).length}
                            </div>
                            <div className="text-sm text-text-muted">Categories</div>
                        </div>
                    </div>
                    
                    {/* Score Distribution */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="glass p-4 rounded-xl">
                            <h4 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                                <PieChart size={16} className="text-blue-500" /> Score Distribution
                            </h4>
                            <div className="h-48">
                                <canvas ref={pieChartRef} className="w-full h-full" />
                            </div>
                        </div>
                        
                        <div className="glass p-4 rounded-xl">
                            <h4 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                                <TrendingUp size={16} className="text-green-500" /> Performance Summary
                            </h4>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Total Questions:</span>
                                    <span className="font-bold">{analytics.totalQuestions}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Correct Answers:</span>
                                    <span className="font-bold text-green-500">{analytics.correctCount}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Unanswered:</span>
                                    <span className="font-bold text-yellow-500">{analytics.unansweredQuestions}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Average Time:</span>
                                    <span className="font-bold">{analytics.averageTimePerQuestion}s</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Categories Covered:</span>
                                    <span className="font-bold">{Object.keys(analytics.byCategory).length}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm">Average Score:</span>
                                    <span className="font-bold text-primary">{Math.round(analytics.totalScore / Math.max(analytics.answeredQuestions, 1))}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Strong and Weak Areas */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="glass p-4 rounded-xl">
                            <h4 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                                <CheckCircle size={16} className="text-green-500" /> Strong Areas
                            </h4>
                            <div className="space-y-2">
                                {analytics.strongAreas.length > 0 ? (
                                    analytics.strongAreas.slice(0, 3).map(area => (
                                        <div key={area.category} className="flex items-center justify-between p-3 bg-green-500/10 rounded-lg">
                                            <div>
                                                <span className="font-medium text-green-400">{area.category}</span>
                                                <div className="text-xs text-green-500/70 mt-1">
                                                    {area.correct}/{area.total} correct ({area.accuracy}%)
                                                </div>
                                            </div>
                                            <div className="text-xs px-2 py-1 bg-green-500/20 text-green-500 rounded-full font-bold">
                                                Excellent
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-6 text-text-muted">
                                        <Target size={24} className="mx-auto mb-2 opacity-50" />
                                        <p className="text-sm">Complete more exams to identify strong areas</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="glass p-4 rounded-xl">
                            <h4 className="font-bold text-text-muted mb-3 flex items-center gap-2">
                                <AlertTriangle size={16} className="text-red-500" /> Areas to Improve
                            </h4>
                            <div className="space-y-2">
                                {analytics.weakAreas.length > 0 ? (
                                    analytics.weakAreas.slice(0, 3).map(area => (
                                        <div key={area.category} className="flex items-center justify-between p-3 bg-red-500/10 rounded-lg">
                                            <div>
                                                <span className="font-medium text-red-400">{area.category}</span>
                                                <div className="text-xs text-red-500/70 mt-1">
                                                    {area.correct}/{area.total} correct ({area.accuracy}%)
                                                </div>
                                            </div>
                                            <div className="text-xs px-2 py-1 bg-red-500/20 text-red-500 rounded-full font-bold">
                                                Needs Work
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-6 text-text-muted">
                                        <CheckCircle size={24} className="mx-auto mb-2 opacity-50" />
                                        <p className="text-sm">Great job! No weak areas detected</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Category Performance Details */}
                    <div className="glass p-4 rounded-xl">
                        <h4 className="font-bold text-text-muted mb-4 flex items-center gap-2">
                            <BarChart size={16} className="text-primary" /> Detailed Performance by Category
                        </h4>
                        <div className="space-y-3">
                            {Object.entries(analytics.byCategory).map(([category, data]) => {
                                const accuracy = Math.round((data.correct / data.total) * 100);
                                const avgScore = Math.round(data.totalScore / Math.max(data.correct, 1)) || 0;
                                const progressColor = accuracy >= 70 ? 'bg-green-500' : accuracy >= 50 ? 'bg-yellow-500' : 'bg-red-500';
                                
                                return (
                                    <div key={category} className="space-y-2">
                                        <div className="flex justify-between text-sm">
                                            <span className="font-medium">{category}</span>
                                            <span className={cn(
                                                'font-bold',
                                                accuracy >= 70 ? 'text-green-500' : 
                                                accuracy >= 50 ? 'text-yellow-500' : 'text-red-500'
                                            )}>
                                                {accuracy}% ({data.correct}/{data.total})
                                            </span>
                                        </div>
                                        <div className="h-2 bg-surface rounded-full overflow-hidden">
                                            <div 
                                                className={cn('h-full rounded-full transition-all duration-500', progressColor)}
                                                style={{ width: `${accuracy}%` }}
                                            />
                                        </div>
                                        <div className="text-xs text-text-muted flex justify-between">
                                            <span>Avg Score: {avgScore}%</span>
                                            <span>{data.correct} correct / {data.incorrect} incorrect</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* Export Controls */}
                    <div className="glass p-4 rounded-xl">
                        <h4 className="font-bold text-text-muted mb-3">Export Analytics</h4>
                        <div className="flex flex-col sm:flex-row gap-4 items-center">
                            <div className="flex gap-2">
                                <label className="flex items-center gap-2">
                                    <input 
                                        type="radio" 
                                        checked={exportFormat === 'pdf'} 
                                        onChange={() => setExportFormat('pdf')}
                                        className="accent-primary"
                                    />
                                    <span className="text-sm">PDF Report</span>
                                </label>
                                <label className="flex items-center gap-2">
                                    <input 
                                        type="radio" 
                                        checked={exportFormat === 'csv'} 
                                        onChange={() => setExportFormat('csv')}
                                        className="accent-primary"
                                    />
                                    <span className="text-sm">CSV Data</span>
                                </label>
                            </div>
                            <div className="flex gap-2 ml-auto">
                                <Button variant="outline" onClick={onClose}>
                                    Close
                                </Button>
                                <Button onClick={exportData} className="gap-2">
                                    <Download size={16} />
                                    Export {exportFormat.toUpperCase()}
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        
        const App = () => {
            const [settings, setSettings] = useState({ 
                durationMinutes: 30, 
                randomizeQuestions: true, 
                randomizeOptions: true, 
                keepEssaysLast: false, 
                showTimer: true, 
                theme: 'default', 
                isDarkMode: true, 
                focusMode: false, 
                instantFeedback: false, 
                layoutMode: 'default',
                enableProctoring: false,
                voiceCommands: false
            });
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [notificationsEnabled, setNotificationsEnabled] = useState(true);
            const [state, setState] = useState({ 
                status: 'welcome', 
                questions: [], 
                currentQuestionIndex: 0, 
                userAnswers: {}, 
                flaggedQuestions: new Set(), 
                timeRemaining: 0, 
                startTime: 0, 
                questionTimes: {} 
            });
            
            // State for all modals
            const [isPasteModalOpen, setPasteModalOpen] = useState(false);
            const [isMapOpen, setIsMapOpen] = useState(false);
            const [isCreatorOpen, setCreatorOpen] = useState(false);
            const [isAIModalOpen, setAIModalOpen] = useState(false);
            const [isAnalyticsOpen, setAnalyticsOpen] = useState(false);
            const [isStudyPlanOpen, setStudyPlanOpen] = useState(false);
            const [isThemeBuilderOpen, setIsThemeBuilderOpen] = useState(false);
            const [isExamHistoryOpen, setIsExamHistoryOpen] = useState(false);
            const [isQuestionBankOpen, setIsQuestionBankOpen] = useState(false);
            const [isGamificationOpen, setIsGamificationOpen] = useState(false);
            
            const [customTheme, setCustomTheme] = useState({
                primary: { r: 99, g: 102, b: 241 },
                secondary: { r: 16, g: 185, b: 129 },
                accent: { r: 236, g: 72, b: 153 },
                name: 'My Custom Theme'
            });
            const [pasteContent, setPasteContent] = useState('');
            const [draftQuestions, setDraftQuestions] = useState([]);
            const [creatorForm, setCreatorForm] = useState({ 
                text: '', 
                type: 'mcq', 
                options: ['', '', '', ''], 
                correctAnswer: '', 
                imageUrl: '', 
                category: '', 
                difficulty: 'Medium',
                explanation: ''
            });
            const [filter, setFilter] = useState({ category: '', difficulty: '', search: '' });
            const [unlockedAchievement, setUnlockedAchievement] = useState(null);
            
            const fileInputRef = useRef(null);

            // === Load Custom Theme ===
            useEffect(() => { 
                const savedCustomTheme = localStorage.getItem('customTheme');
                if (savedCustomTheme) {
                    try {
                        const parsed = JSON.parse(savedCustomTheme);
                        setCustomTheme(parsed);
                        if (settings.theme === 'custom') {
                            document.documentElement.style.setProperty('--color-primary', `${parsed.primary.r} ${parsed.primary.g} ${parsed.primary.b}`);
                            document.documentElement.style.setProperty('--color-secondary', `${parsed.secondary.r} ${parsed.secondary.g} ${parsed.secondary.b}`);
                            document.documentElement.style.setProperty('--color-accent', `${parsed.accent.r} ${parsed.accent.g} ${parsed.accent.b}`);
                        }
                    } catch (e) {
                        console.error('Failed to load custom theme:', e);
                    }
                }
                document.body.className = cn(settings.isDarkMode ? 'dark' : 'light-mode', `theme-${settings.theme}`); 
            }, [settings.isDarkMode, settings.theme]);
            
            useEffect(() => { sfx.enabled = soundEnabled; }, [soundEnabled]);

            // === Save Exam to History (Fixed for essays) ===
            const saveExamToHistory = () => {
    if (state.questions.length === 0) {
        return null;
    }
    
    try {
        // Calculate analytics with error handling
        let analytics;
        try {
            analytics = calculateAnalytics(state.questions, state.userAnswers || {});
        } catch (analyticsError) {
            console.warn('Analytics calculation failed:', analyticsError);
            // Provide safe defaults
            analytics = {
                correctCount: 0,
                accuracy: 0,
                totalQuestions: state.questions.length,
                timeSpent: (settings.durationMinutes * 60) - state.timeRemaining
            };
        }
        
        const categories = [...new Set(state.questions.map(q => q.category || 'General').filter(Boolean))];
        const difficultyBreakdown = state.questions.reduce((acc, q) => {
            const diff = q.difficulty || 'Medium';
            acc[diff] = (acc[diff] || 0) + 1;
            return acc;
        }, {});
        
        const examData = {
            title: `Exam ${new Date().toLocaleDateString()}`,
            questions: state.questions,
            userAnswers: state.userAnswers || {},
            settings: settings,
            score: analytics.correctCount || 0,
            totalQuestions: state.questions.length,
            timeSpent: (settings.durationMinutes * 60) - state.timeRemaining,
            categories: categories,
            difficultyBreakdown: difficultyBreakdown,
            accuracy: analytics.accuracy || 0
        };
        
        const savedExam = examHistoryManager.addExam(examData);
        
        // Record for gamification
        try {
            gamificationManager.recordExamCompletion({
                ...examData,
                settings: settings
            });
            
            // Check for new achievements
            const newAchievements = gamificationManager.getUnlockedAchievements();
            const lastAchievement = newAchievements[newAchievements.length - 1];
            if (lastAchievement && (!unlockedAchievement || lastAchievement.id !== unlockedAchievement.id)) {
                setUnlockedAchievement(lastAchievement);
                setTimeout(() => setUnlockedAchievement(null), 5000);
            }
        } catch (gamificationError) {
            console.warn('Gamification recording failed:', gamificationError);
        }
        
        return savedExam;
        
    } catch (error) {
        console.error('Failed to save exam to history:', error);
        return null;
    }
};

            // === Export Results (Fixed for essays) ===
            const exportResults = () => {
                if (state.questions.length === 0) return;
                
                const results = state.questions.map((q, idx) => {
                    const userAnswer = state.userAnswers[idx] || 'Not answered';
                    let isCorrect = false;
                    let score = 0;
                    
                    if (userAnswer !== 'Not answered') {
                        if (q.isEssay) {
                            isCorrect = essayEvaluator.evaluateEssayAnswer(userAnswer, q.correctAnswer);
                            score = essayEvaluator.getEssayScore(userAnswer, q.correctAnswer);
                        } else {
                            isCorrect = essayEvaluator.isCorrect(userAnswer, q.correctAnswer, false);
                            score = isCorrect ? 100 : 0;
                        }
                    }
                    
                    return {
                        question: q.text,
                        yourAnswer: userAnswer,
                        correctAnswer: q.correctAnswer,
                        correct: isCorrect,
                        score: q.isEssay ? `${score}%` : (isCorrect ? '100%' : '0%'),
                        category: q.category || 'General',
                        difficulty: q.difficulty || 'Medium'
                    };
                });
                
                exportToPDF(`Exam_Results_${new Date().toISOString().split('T')[0]}`, results);
                sfx.success();
            };

            // === Notification System ===
            const showNotification = (title, body) => {
                if (!notificationsEnabled) return;
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body, icon: '/favicon.ico' });
                }
            };

            // === Exam Logic ===
            const loadQuestions = (questions) => {
                if (questions.length === 0) {
                    alert("No questions.");
                    return;
                }

                setState(prev => ({
                    ...prev,
                    questions,
                    status: 'setup',
                    userAnswers: {},
                    flaggedQuestions: new Set(),
                    timeRemaining: settings.durationMinutes * 60
                }));

                setPasteModalOpen(false);
                sfx.success();

                showNotification('Questions Loaded', `Successfully loaded ${questions.length} questions`);
            };

            const startExam = () => {
                let finalQuestions = [...state.questions];
                
                if (settings.keepEssaysLast) {
                    const essays = finalQuestions.filter(q => q.isEssay); 
                    const others = finalQuestions.filter(q => !q.isEssay);
                    finalQuestions = [
                        ...(settings.randomizeQuestions ? shuffleArray(others) : others), 
                        ...(settings.randomizeQuestions ? shuffleArray(essays) : essays)
                    ];
                } else if (settings.randomizeQuestions) {
                    finalQuestions = shuffleArray(finalQuestions);
                }
                
                setState(prev => ({ 
                    ...prev, 
                    status: 'running', 
                    questions: finalQuestions, 
                    timeRemaining: settings.durationMinutes * 60, 
                    startTime: Date.now(), 
                    currentQuestionIndex: 0, 
                    userAnswers: {}, 
                    flaggedQuestions: new Set() 
                }));
                sfx.start();
                showNotification('Exam Started', 'Good luck! You have ' + settings.durationMinutes + ' minutes');
            };

            const finishExam = () => {
    let correct = 0;
    let totalScore = 0;
    
    // First calculate score safely
    state.questions.forEach((q, idx) => {
        const userAns = state.userAnswers[idx];
        if (userAns) {
            if (q.isEssay) {
                const essayScore = essayEvaluator.getEssayScore(userAns, q.correctAnswer);
                totalScore += essayScore;
                if (essayEvaluator.evaluateEssayAnswer(userAns, q.correctAnswer)) {
                    correct++;
                }
            } else {
                if (essayEvaluator.isCorrect(userAns, q.correctAnswer, false)) {
                    correct++;
                    totalScore += 100;
                }
            }
        }
    });
    
    // Save to history - wrapped in try-catch
    try {
        saveExamToHistory();
    } catch (historyError) {
        console.warn('History save failed:', historyError);
    }
    
    // Update state
    setState(prev => ({ 
        ...prev, 
        status: 'finished',
        timeRemaining: 0 
    })); 
    
    // UI feedback
    fireConfetti(); 
    sfx.success();
    
    // Show notification
    const percentage = Math.round((correct / Math.max(state.questions.length, 1)) * 100);
    showNotification('Exam Completed', `You scored ${correct}/${state.questions.length} (${percentage}%)`);
    
    // Close map
    setIsMapOpen(false);
};

            const exitReview = () => {
                setState(prev => ({ ...prev, status: 'welcome', questions: [], userAnswers: {}, flaggedQuestions: new Set() }));
                sfx.click();
            };

            const restoreExamFromHistory = (exam) => {
                setState(prev => ({
                    ...prev,
                    questions: exam.questions,
                    userAnswers: exam.userAnswers,
                    status: 'review',
                    currentQuestionIndex: 0,
                    flaggedQuestions: new Set()
                }));
                
                // Update settings if available
                if (exam.settings) {
                    setSettings(prev => ({ ...prev, ...exam.settings }));
                }
                
                sfx.success();
                showNotification('Exam Restored', `Restored exam from ${new Date(exam.timestamp).toLocaleDateString()}`);
            };

            // Timer effect
            useEffect(() => {
                let interval;
                if (state.status === 'running' && state.timeRemaining > 0) {
                    interval = setInterval(() => {
                        setState(prev => {
                            if (prev.timeRemaining <= 1) { 
                                finishExam(); 
                                return { ...prev, timeRemaining: 0 }; 
                            }
                            return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [state.status, state.timeRemaining]);

            // Calculate score with fixed essay evaluation
            const scoreData = useMemo(() => {
                let correct = 0; 
                const correctMap = {};
                state.questions.forEach((q, idx) => {
                    const userAns = state.userAnswers[idx];
                    let isCorrect = false;
                    
                    if (userAns) {
                        if (q.isEssay) {
                            // Use fixed essay evaluation
                            isCorrect = essayEvaluator.evaluateEssayAnswer(userAns, q.correctAnswer);
                        } else {
                            // Use fixed MCQ evaluation
                            isCorrect = essayEvaluator.isCorrect(userAns, q.correctAnswer, false);
                        }
                    }
                    
                    if (isCorrect) correct++;
                    correctMap[idx] = isCorrect;
                });
                return { correct, total: state.questions.length, correctMap };
            }, [state.questions, state.userAnswers]);

            // Current question
            const currentQuestion = state.questions[state.currentQuestionIndex];
            const isRunning = state.status === 'running';
            const isReview = state.status === 'review';
            const isFinished = state.status === 'finished';
            const isLastQuestion = state.currentQuestionIndex === state.questions.length - 1;
            const isSidebarActive = settings.layoutMode === 'default' && !settings.focusMode && (isRunning || isReview) && window.innerWidth >= 1024;

            // Unique categories and difficulties
            const categories = useMemo(() => {
                const cats = new Set();
                state.questions.forEach(q => q.category && cats.add(q.category));
                return Array.from(cats);
            }, [state.questions]);
            
            const difficulties = ['Easy', 'Medium', 'Hard'];

            // Render function for stats card
            const StatCard = ({ label, value, icon, color }) => (
                <div className="bg-surface/60 backdrop-blur p-4 rounded-2xl border border-white/5 flex flex-col items-center justify-center gap-2 shadow-sm">
                    <div className={cn("p-2 rounded-full bg-white/5", color)}>{icon}</div>
                    <div className="text-sm font-bold text-text-muted uppercase tracking-wider">{label}</div>
                    <div className="text-xl font-black">{value}</div>
                </div>
            );

            return (
                <div className={cn("min-h-screen flex flex-col transition-colors duration-300", settings.focusMode ? "bg-black" : "bg-transparent")}>
                    {/* Achievement Popup */}
                    {unlockedAchievement && (
                        <AchievementPopup 
                            achievement={unlockedAchievement} 
                            onClose={() => setUnlockedAchievement(null)} 
                        />
                    )}
                    
                    {/* Quick Setup Buttons */}
<div className="fixed bottom-6 left-6 z-40 flex flex-col gap-2">
    <Button
        variant="primary"
        size="icon"
        onClick={() => setCreatorOpen(true)}
        title="Quick Create"
    >
        <Plus size={20} />
    </Button>
</div>
                    
                    {/* Enhanced Toolbar */}
                    <EnhancedToolbar 
                        onExport={exportResults}
                        onAnalytics={() => setAnalyticsOpen(true)}
                        onAIGenerate={() => setAIModalOpen(true)}
                        onExamHistory={() => setIsExamHistoryOpen(true)}
                        onQuestionBank={() => setIsQuestionBankOpen(true)}
                        onGamification={() => setIsGamificationOpen(true)}
                        isRunning={isRunning || isReview}
                    />
                    
                    {/* Header */}
                    {state.status !== 'welcome' && !settings.focusMode && (
                        <header className="sticky top-0 z-40 w-full glass shadow-sm">
                            <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-2 text-primary cursor-pointer hover:scale-105 transition-transform" onClick={exitReview}>
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-lg shadow-lg">E</div>
                                    <span className="font-bold text-lg hidden md:block">ArcaneEXAM</span>
                                </div>
                                
                                {/* Timer */}
                                {isRunning && (
                                    <div className={cn(
                                        "flex items-center gap-2 px-3 py-1.5 rounded-full border shadow-lg transition-colors md:absolute md:left-1/2 md:-translate-x-1/2",
                                        state.timeRemaining < 300 ? "bg-red-500/20 text-red-500 animate-pulse" : "bg-surface/90 backdrop-blur-sm",
                                        "w-auto max-w-[180px]"
                                    )}>
                                        <Clock size={14} className="flex-shrink-0" />
                                        <span className="font-mono font-bold tracking-wider text-sm truncate">{formatTime(state.timeRemaining)}</span>
                                        {state.timeRemaining < 600 && (
                                            <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse flex-shrink-0 ml-1"></div>
                                        )}
                                    </div>
                                )}
                                
                                {isReview && (
                                    <div className="flex items-center gap-2 px-3 py-1.5 bg-yellow-500/10 border border-yellow-500/20 text-yellow-500 rounded-full md:absolute md:left-1/2 md:-translate-x-1/2">
                                        <Eye size={14} /><span className="font-bold tracking-wide text-sm">REVIEW</span>
                                    </div>
                                )}
                                
                                <div className="flex items-center gap-2">
                                    {/* Search/Filter */}
                                    {(isRunning || isReview) && state.questions.length > 0 && (
                                        <div className="hidden md:flex items-center gap-2 mr-4">
                                            <input
                                                type="text"
                                                placeholder="Search questions..."
                                                value={filter.search}
                                                onChange={(e) => setFilter(f => ({ ...f, search: e.target.value }))}
                                                className="px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm w-40 focus:w-56 transition-all duration-300 outline-none focus:border-primary"
                                            />
                                            {categories.length > 0 && (
                                                <select
                                                    value={filter.category}
                                                    onChange={(e) => setFilter(f => ({ ...f, category: e.target.value }))}
                                                    className="px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm outline-none focus:border-primary"
                                                >
                                                    <option value="">All Categories</option>
                                                    {categories.map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>
                                            )}
                                        </div>
                                    )}
                                    
                                    {isRunning && <Button variant="danger" size="sm" onClick={finishExam} className="hidden md:flex mr-2"><LogOut size={16} className="mr-2"/> Finish</Button>}
                                    {(isReview || state.status === 'leaderboard') && <Button variant="outline" size="sm" onClick={exitReview} className="hidden md:flex mr-2 border-red-400 text-red-400 hover:bg-red-400/10"><XCircle size={16} className="mr-2"/> Exit</Button>}
                                    
                                    {/* Header Buttons */}
                                    <div className="flex items-center gap-1">
                                        <Button variant="ghost" size="icon" onClick={() => setSoundEnabled(!soundEnabled)} title={soundEnabled ? "Mute sounds" : "Enable sounds"} className="p-1.5">
                                            {soundEnabled ? <Volume2 size={18}/> : <VolumeX size={18}/>}
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => setNotificationsEnabled(!notificationsEnabled)} title={notificationsEnabled ? "Disable notifications" : "Enable notifications"} className="p-1.5">
                                            {notificationsEnabled ? <Bell size={18}/> : <BellOff size={18}/>}
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => setSettings(s => ({ ...s, isDarkMode: !s.isDarkMode }))} title={settings.isDarkMode ? "Switch to light mode" : "Switch to dark mode"} className="p-1.5">
                                            {settings.isDarkMode ? <Sun size={18}/> : <Moon size={18}/>}
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => setSettings(s => ({ ...s, voiceCommands: !s.voiceCommands }))} title={settings.voiceCommands ? "Disable voice commands" : "Enable voice commands"} className="p-1.5">
                                            {settings.voiceCommands ? <Mic size={18} className="text-green-500"/> : <MicOff size={18}/>}
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        </header>
                    )}

                    {/* Main Content */}
                    <main className={cn("flex-1 w-full max-w-7xl mx-auto p-4 md:p-6 relative", isSidebarActive ? "grid grid-cols-[1fr_300px] gap-6" : "flex flex-col")}>
                        
                        {/* Welcome Screen */}
                        {state.status === 'welcome' && (
                            <div className="flex-1 flex flex-col items-center justify-center text-center animate-fade-in gap-8 max-w-2xl mx-auto py-12">
                                <div className="relative group cursor-default">
                                    <div className="absolute inset-0 bg-primary/20 blur-3xl rounded-full group-hover:bg-primary/40 transition-colors duration-500" />
                                    <div className="relative w-24 h-24 bg-gradient-to-br from-primary to-accent rounded-3xl shadow-2xl flex items-center justify-center mb-6 mx-auto rotate-3 hover:rotate-6 transition-transform duration-300">
                                        <FileText size={48} className="text-white" />
                                    </div>
                                </div>
                                <h1 className="text-4xl md:text-5xl font-black tracking-tight">ARCANE<span className="text-primary">EXAMS</span> <span className="text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-transparent bg-clip-text">PRO</span></h1>
                                <p className="text-text-muted max-w-md">Designed by: Ahmed Hamed </p>
                                <div className="glass p-8 rounded-3xl space-y-6 w-full max-w-lg mt-8">
                                    <h3 className="font-bold flex items-center justify-center gap-2 text-xl"><User size={24} className="text-secondary"/> Single Player Mode</h3>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".csv,.txt,.xlsx,.xls" onChange={(e) => { 
                                        const f = e.target.files[0]; 
                                        if(f) { 
                                            if(f.name.endsWith('csv')) { 
                                                const r = new FileReader(); 
                                                r.onload = ev => {
                                                    const questions = parseCSV(ev.target.result);
                                                    loadQuestions(questions);
                                                }; 
                                                r.readAsText(f); 
                                            } else { 
                                                parseExcel(f).then(questions => {
                                                    loadQuestions(questions);
                                                }); 
                                            } 
                                        } 
                                    }} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <Button variant="outline" onClick={() => fileInputRef.current?.click()}>Upload</Button>
                                        <Button variant="outline" onClick={() => setPasteModalOpen(true)}>Paste</Button>
                                        <Button variant="outline" onClick={() => { setDraftQuestions([]); setCreatorOpen(true); }}>Create</Button>
                                        <Button variant="ai" onClick={() => setAIModalOpen(true)}><Brain size={14} className="mr-1"/> AI Generate</Button>
                                        <Button variant="secondary" onClick={() => loadQuestions(parseCSV(SAMPLE_CSV))} className="col-span-2">Sample Questions</Button>
                                    </div>
                                </div>
                                
                                {/* Feature Highlights */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-8">
                                    <div className="glass p-3 rounded-xl text-center">
                                        <Brain size={20} className="mx-auto mb-2 text-purple-500" />
                                        <p className="text-xs font-bold">AI Generation</p>
                                    </div>
                                    <div className="glass p-3 rounded-xl text-center">
                                        <BarChart size={20} className="mx-auto mb-2 text-green-500" />
                                        <p className="text-xs font-bold">Analytics</p>
                                    </div>
                                    <div className="glass p-3 rounded-xl text-center">
                                        <Mic size={20} className="mx-auto mb-2 text-orange-500" />
                                        <p className="text-xs font-bold">Voice Commands</p>
                                    </div>
                                    <div className="glass p-3 rounded-xl text-center">
                                        <Award size={20} className="mx-auto mb-2 text-yellow-500" />
                                        <p className="text-xs font-bold">Gamification</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Setup Screen with Enhanced Time Input */}
                        {state.status === 'setup' && (
                            <div className="flex-1 flex flex-col items-center justify-center animate-fade-in w-full max-w-lg mx-auto py-8">
                                <div className="w-full glass p-8 md:p-10 rounded-3xl border border-white/10 shadow-2xl space-y-8 relative overflow-hidden">
                                    <div className="text-center">
                                        <h2 className="text-3xl font-bold mb-2">Configure Exam</h2>
                                        <p className="text-text-muted">{state.questions.length} questions loaded</p>
                                    </div>
                                    
                                    {/* Enhanced Time Input */}
                                    <TimeInput 
                                        value={settings.durationMinutes}
                                        onChange={(minutes) => setSettings(s => ({ ...s, durationMinutes: minutes }))}
                                        min={1}
                                        max={180}
                                        step={1}
                                    />
                                    
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-2 gap-3">
                                            <button className={cn("p-4 rounded-xl border transition-all text-sm font-bold flex flex-col items-center gap-2", settings.randomizeQuestions ? "border-primary bg-primary/10 text-primary" : "border-white/10 bg-black/20 text-text-muted")} onClick={() => setSettings(s => ({ ...s, randomizeQuestions: !s.randomizeQuestions }))}>
                                                <Shuffle size={20}/> Shuffle
                                            </button>
                                            <button className={cn("p-4 rounded-xl border transition-all text-sm font-bold flex flex-col items-center gap-2", settings.instantFeedback ? "border-secondary bg-secondary/10 text-secondary" : "border-white/10 bg-black/20 text-text-muted")} onClick={() => setSettings(s => ({ ...s, instantFeedback: !s.instantFeedback }))}>
                                                <Zap size={20}/> Instant
                                            </button>
                                            <button className={cn("p-4 rounded-xl border transition-all text-sm font-bold flex flex-col items-center gap-2", settings.enableProctoring ? "border-red-500 bg-red-500/10 text-red-500" : "border-white/10 bg-black/20 text-text-muted")} onClick={() => setSettings(s => ({ ...s, enableProctoring: !s.enableProctoring }))}>
                                                <Camera size={20}/> Proctoring
                                            </button>
                                            <button className={cn("p-4 rounded-xl border transition-all text-sm font-bold flex flex-col items-center gap-2", settings.voiceCommands ? "border-green-500 bg-green-500/10 text-green-500" : "border-white/10 bg-black/20 text-text-muted")} onClick={() => setSettings(s => ({ ...s, voiceCommands: !s.voiceCommands }))}>
                                                <Mic size={20}/> Voice
                                            </button>
                                        </div>
                                        
                                        {/* Theme Selection */}
                                        <div className="space-y-3 pt-2">
                                            <label className="text-xs font-bold text-text-muted uppercase">Theme</label>
                                            <div className="grid grid-cols-4 gap-3">
                                                {['default', 'ocean', 'sunset', 'forest', 'midnight', 'aurora', 'cotton-candy', 'neon'].map(t => (
                                                    <button 
                                                        key={t} 
                                                        onClick={() => setSettings(s => ({ ...s, theme: t }))} 
                                                        className={cn(
                                                            "h-10 rounded-xl border-2 transition-all shadow-sm relative group",
                                                            settings.theme === t ? "border-white scale-110 shadow-lg ring-2 ring-white/30" : "border-transparent opacity-80 hover:opacity-100 hover:scale-105"
                                                        )} 
                                                        style={{ 
                                                            background: t === 'default' ? '#4f46e5' : 
                                                                       t === 'ocean' ? '#0ea5e9' : 
                                                                       t === 'sunset' ? '#f97316' : 
                                                                       t === 'forest' ? '#22c55e' :
                                                                       t === 'midnight' ? '#8b5cf6' :
                                                                       t === 'aurora' ? '#22c55e' :
                                                                       t === 'cotton-candy' ? '#ec4899' :
                                                                       '#22c55e'
                                                        }}
                                                        title={t.charAt(0).toUpperCase() + t.slice(1)}
                                                    >
                                                        {settings.theme === t && (
                                                            <div className="absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center">
                                                                <Check size={12} className="text-white" />
                                                            </div>
                                                        )}
                                                    </button>
                                                ))}
                                            </div>
                                            <Button 
                                                variant="outline" 
                                                size="sm" 
                                                className="w-full mt-2"
                                                onClick={() => setIsThemeBuilderOpen(true)}
                                            >
                                                <Palette size={16} className="mr-2" />
                                                Custom Theme Builder
                                            </Button>
                                        </div>
                                    </div>
                                    
                                    <Button size="lg" className="w-full py-4 text-lg" onClick={() => startExam()}>
                                        Start Exam
                                    </Button>
                                </div>
                            </div>
                        )}

                        {/* Exam in Progress */}
                        {(isRunning || isReview || isFinished) && (
                            <>
                                {(isRunning || isReview) && (
                                    <div className="flex flex-col gap-6 h-full pb-24 md:pb-0">
                                        {/* AI Template Button */}
                                        {isReview && (
                                            <div className="flex justify-end animate-fade-in">
                                                <Button 
                                                    variant="ai" 
                                                    size="sm"
                                                    onClick={copyAITemplate}
                                                    className="flex items-center gap-2"
                                                >
                                                    <Sparkles size={16} />
                                                    <span>Copy AI Template</span>
                                                </Button>
                                            </div>
                                        )}
                                        
                                        {/* Mobile Filter Bar */}
                                        {(isRunning || isReview) && state.questions.length > 0 && window.innerWidth < 768 && (
                                            <div className="flex gap-2 overflow-x-auto pb-2">
                                                <input
                                                    type="text"
                                                    placeholder="Search..."
                                                    value={filter.search}
                                                    onChange={(e) => setFilter(f => ({ ...f, search: e.target.value }))}
                                                    className="flex-1 px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm outline-none"
                                                />
                                                {categories.length > 0 && (
                                                    <select
                                                        value={filter.category}
                                                        onChange={(e) => setFilter(f => ({ ...f, category: e.target.value }))}
                                                        className="px-3 py-1.5 bg-black/20 rounded-lg border border-white/10 text-sm"
                                                    >
                                                        <option value="">All</option>
                                                        {categories.map(cat => (
                                                            <option key={cat} value={cat}>{cat}</option>
                                                        ))}
                                                    </select>
                                                )}
                                            </div>
                                        )}
                                        
                                        {/* Question Header */}
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-baseline gap-1">
                                                <span className="text-3xl font-black text-primary/90">{String(state.currentQuestionIndex + 1).padStart(2, '0')}</span>
                                                <span className="text-text-muted font-medium text-lg">/ {state.questions.length}</span>
                                                {currentQuestion && (
                                                    <div className="ml-4 flex gap-2">
                                                        {currentQuestion.category && (
                                                            <span className="px-2 py-1 text-xs font-bold bg-primary/20 text-primary rounded-full hidden sm:block">
                                                                {currentQuestion.category}
                                                            </span>
                                                        )}
                                                        {currentQuestion.difficulty && (
                                                            <span className={cn(
                                                                "px-2 py-1 text-xs font-bold rounded-full hidden sm:block",
                                                                currentQuestion.difficulty === 'Easy' ? 'bg-green-500/20 text-green-500' :
                                                                currentQuestion.difficulty === 'Medium' ? 'bg-yellow-500/20 text-yellow-500' :
                                                                'bg-red-500/20 text-red-500'
                                                            )}>
                                                                {currentQuestion.difficulty}
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <Button variant={state.flaggedQuestions.has(state.currentQuestionIndex) ? 'secondary' : 'ghost'} size="sm" onClick={() => { 
                                                    setState(prev => { 
                                                        const newFlags = new Set(prev.flaggedQuestions); 
                                                        if (newFlags.has(prev.currentQuestionIndex)) {
                                                            newFlags.delete(prev.currentQuestionIndex); 
                                                        } else {
                                                            newFlags.add(prev.currentQuestionIndex); 
                                                        }
                                                        return { ...prev, flaggedQuestions: newFlags }; 
                                                    }); 
                                                    sfx.click(); 
                                                }} className="gap-2" disabled={isReview}>
                                                    <Flag size={18} fill={state.flaggedQuestions.has(state.currentQuestionIndex) ? "currentColor" : "none"} />
                                                    <span className="hidden sm:inline">Flag</span>
                                                </Button>
                                                {isRunning && (
                                                    <div className="hidden md:flex items-center gap-1 px-3 py-1 bg-black/20 rounded-lg text-sm">
                                                        <Timer size={12} />
                                                        <span>Q Time: {formatTime(Math.floor((Date.now() - state.startTime) / 1000) % 60)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Question Card */}
                                        <div className="flex-1 question-card-enter" key={currentQuestion.id + state.currentQuestionIndex}>
                                            <EnhancedQuestionCard 
                                                question={currentQuestion} 
                                                selectedAnswer={state.userAnswers[state.currentQuestionIndex]} 
                                                onSelectAnswer={(a) => { 
                                                    setState(prev => ({ ...prev, userAnswers: { ...prev.userAnswers, [prev.currentQuestionIndex]: a } })); 
                                                    if(settings.instantFeedback) { 
                                                        if(currentQuestion.isEssay) {
                                                            const feedback = essayEvaluator.getEssayFeedback(a, currentQuestion.correctAnswer);
                                                            if(feedback.score >= 60) {
                                                                sfx.success(); 
                                                            } else {
                                                                sfx.error(); 
                                                            }
                                                        } else if(essayEvaluator.isCorrect(a, currentQuestion.correctAnswer, false)) {
                                                            sfx.success(); 
                                                        } else {
                                                            sfx.error(); 
                                                        }
                                                    } else {
                                                        sfx.click(); 
                                                    }
                                                }} 
                                                isReviewMode={isReview} 
                                                isCorrect={scoreData.correctMap[state.currentQuestionIndex]} 
                                                showFeedback={settings.instantFeedback}
                                                onAddToBank={(question) => {
                                                    const added = questionBankManager.addQuestion(question);
                                                    if (added) {
                                                        sfx.success();
                                                        showNotification('Question Saved', 'Question added to your question bank!');
                                                        
                                                        // Record for gamification
                                                        const bankStats = questionBankManager.getStats();
                                                        gamificationManager.recordQuestionCreation(bankStats.totalQuestions);
                                                        
                                                        // Show achievement popup if new achievement unlocked
                                                        const newAchievements = gamificationManager.getUnlockedAchievements();
                                                        const lastAchievement = newAchievements[newAchievements.length - 1];
                                                        if (lastAchievement && (!unlockedAchievement || lastAchievement.id !== unlockedAchievement.id)) {
                                                            setUnlockedAchievement(lastAchievement);
                                                            setTimeout(() => setUnlockedAchievement(null), 5000);
                                                        }
                                                    } else {
                                                        sfx.error();
                                                        showNotification('Duplicate Question', 'This question is already in your bank');
                                                    }
                                                }}
                                            />
                                        </div>
                                        
                                        {/* Mobile Controls */}
                                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm z-50 md:hidden">
                                            <div className="bg-surface/90 backdrop-blur-xl p-3 rounded-2xl border border-white/10 shadow-2xl flex items-center justify-between">
                                                <Button size="icon" variant="ghost" onClick={() => { setState(p => ({ ...p, currentQuestionIndex: p.currentQuestionIndex - 1 })); sfx.click(); }} disabled={state.currentQuestionIndex === 0}>
                                                    <ChevronLeft />
                                                </Button>
                                                
                                                {isReview && (
                                                    <Button 
                                                        variant="ai" 
                                                        size="icon"
                                                        onClick={copyAITemplate}
                                                        className="mx-2"
                                                        title="Copy AI Template"
                                                    >
                                                        <Sparkles size={18} />
                                                    </Button>
                                                )}
                                                
                                                <Button variant="secondary" onClick={() => setIsMapOpen(true)} className="flex-1 mx-3 rounded-xl shadow-lg shadow-secondary/20">
                                                    <LayoutGrid size={20} className="mr-2" /> Overview
                                                </Button>
                                                
                                                {isLastQuestion ? (
                                                    <Button size="icon" variant={isReview ? "danger" : "primary"} onClick={isReview ? exitReview : finishExam}>
                                                        {isReview ? <XCircle size={20} /> : <Check size={20} />}
                                                    </Button>
                                                ) : (
                                                    <Button size="icon" variant="ghost" onClick={() => { setState(p => ({ ...p, currentQuestionIndex: p.currentQuestionIndex + 1 })); sfx.click(); }}>
                                                        <ChevronRight />
                                                    </Button>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Desktop Controls */}
                                        <div className="hidden md:flex items-center justify-between mt-auto pt-6 border-t border-white/5">
                                            <div className="flex items-center gap-3">
                                                <Button variant="outline" onClick={() => { setState(p => ({ ...p, currentQuestionIndex: p.currentQuestionIndex - 1 })); sfx.click(); }} disabled={state.currentQuestionIndex === 0} className="w-32">
                                                    Previous
                                                </Button>
                                                
                                                {isReview && (
                                                    <Button 
                                                        variant="ai" 
                                                        onClick={copyAITemplate}
                                                        className="flex items-center gap-2"
                                                    >
                                                        <Sparkles size={16} />
                                                        <span>AI Template</span>
                                                    </Button>
                                                )}
                                                
                                                {!isSidebarActive && (
                                                    <Button variant="ghost" onClick={() => setIsMapOpen(true)}>
                                                        <LayoutGrid size={18} className="mr-2" /> Overview
                                                    </Button>
                                                )}
                                            </div>
                                            {isLastQuestion ? (
                                                <Button variant={isReview ? "danger" : "primary"} onClick={isReview ? exitReview : finishExam} size="lg" className="px-8 shadow-xl">
                                                    {isReview ? "Exit Review" : "Finish Exam"}
                                                </Button>
                                            ) : (
                                                <Button variant="primary" onClick={() => { setState(p => ({ ...p, currentQuestionIndex: p.currentQuestionIndex + 1 })); sfx.click(); }} size="lg" className="px-8 shadow-lg shadow-primary/20">
                                                    Next Question <ChevronRight className="ml-2" size={20} />
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Sidebar with Mini Map */}
                                {isSidebarActive && (isRunning || isReview) && (
                                    <div className="hidden lg:flex flex-col gap-4 h-[calc(100vh-8rem)] sticky top-24 glass rounded-2xl p-4 border border-white/10 animate-fade-in">
                                        <div className="flex items-center justify-between">
                                            <h3 className="font-bold text-lg flex items-center gap-2"><LayoutGrid size={20} /> Question Map</h3>
                                            <span className="text-xs text-text-muted bg-black/20 px-2 py-1 rounded">
                                                {Object.keys(state.userAnswers).length}/{state.questions.length}
                                            </span>
                                        </div>
                                        
                                        {/* Stats */}
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="text-center p-2 bg-primary/10 rounded-lg">
                                                <div className="text-sm font-bold text-primary">Answered</div>
                                                <div className="text-lg font-bold">{Object.keys(state.userAnswers).length}</div>
                                            </div>
                                            <div className="text-center p-2 bg-secondary/10 rounded-lg">
                                                <div className="text-sm font-bold text-secondary">Flagged</div>
                                                <div className="text-lg font-bold">{state.flaggedQuestions.size}</div>
                                            </div>
                                        </div>
                                        
                                        {/* Mini Map */}
                                        <div className="overflow-y-auto flex-1 pr-2">
                                            <QuestionMap
                                                totalQuestions={state.questions.length}
                                                currentIndex={state.currentQuestionIndex}
                                                answers={state.userAnswers}
                                                flagged={state.flaggedQuestions}
                                                onNavigate={(idx) => {
                                                    setState(p => ({ ...p, currentQuestionIndex: idx }));
                                                    sfx.click();
                                                }}
                                                isReviewMode={isReview}
                                                correctAnswers={scoreData.correctMap}
                                                showInstantFeedback={settings.instantFeedback}
                                            />
                                        </div>
                                        
                                        {/* Quick Navigation */}
                                        <div className="space-y-2">
                                            <div className="flex gap-1">
                                                <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                                <span className="text-xs">Correct</span>
                                                <div className="w-3 h-3 rounded-full bg-red-500 ml-2"></div>
                                                <span className="text-xs">Incorrect</span>
                                                <div className="w-3 h-3 rounded-full bg-yellow-500 ml-2"></div>
                                                <span className="text-xs">Flagged</span>
                                            </div>
                                            <div className="flex gap-1">
                                                <div className="w-3 h-3 rounded-full bg-primary"></div>
                                                <span className="text-xs">Current</span>
                                                <div className="w-3 h-3 rounded-full bg-secondary ml-2"></div>
                                                <span className="text-xs">Answered</span>
                                            </div>
                                        </div>
                                        
                                        <div className="pt-4 border-t border-white/10">
                                            <Button variant="danger" className="w-full" onClick={isReview ? exitReview : finishExam}>
                                                {isReview ? "Exit Review" : "Finish Exam"}
                                            </Button>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Finished Screen */}
                                {isFinished && (
                                    <div className="flex-1 flex flex-col items-center justify-center animate-fade-in w-full max-w-5xl mx-auto py-8 col-span-2">
                                        <div className="w-full glass rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-white/10 relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary via-secondary to-accent" />
                                            <div className="flex flex-col gap-12">
                                                <div className="text-center md:text-left flex flex-col md:flex-row items-center gap-8 border-b border-white/10 pb-8">
                                                    <div className="flex-shrink-0">
                                                        <div className="text-4xl font-black text-primary">{scoreData.correct}/{scoreData.total}</div>
                                                        <div className="text-lg text-text-muted">Score</div>
                                                    </div>
                                                    <div className="flex-1 space-y-4">
                                                        <h2 className="text-4xl font-black tracking-tight">Exam Completed!</h2>
                                                        <p className="text-text-muted text-lg max-w-md">You answered {scoreData.correct} questions correctly out of {scoreData.total}.</p>
                                                        <div className="flex gap-3">
                                                            <Button onClick={() => setAnalyticsOpen(true)}>
                                                                <BarChart3 size={16} className="mr-2" /> View Analytics
                                                            </Button>
                                                            <Button variant="outline" onClick={exportResults}>
                                                                <Download size={16} className="mr-2" /> Export PDF
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full">
                                                    <div className="bg-surface/60 backdrop-blur p-4 rounded-2xl border border-white/5 flex flex-col items-center justify-center gap-2 shadow-sm">
                                                        <div className="p-2 rounded-full bg-white/5 text-primary"><Clock size={24} /></div>
                                                        <div className="text-sm font-bold text-text-muted uppercase tracking-wider">Time Taken</div>
                                                        <div className="text-xl font-black">{formatTime((settings.durationMinutes * 60) - state.timeRemaining)}</div>
                                                    </div>
                                                    <div className="bg-surface/60 backdrop-blur p-4 rounded-2xl border border-white/5 flex flex-col items-center justify-center gap-2 shadow-sm">
                                                        <div className="p-2 rounded-full bg-white/5 text-secondary"><CheckCircle size={24} /></div>
                                                        <div className="text-sm font-bold text-text-muted uppercase tracking-wider">Accuracy</div>
                                                        <div className="text-xl font-black">{Math.round(scoreData.correct/scoreData.total*100)}%</div>
                                                    </div>
                                                    <div className="bg-surface/60 backdrop-blur p-4 rounded-2xl border border-white/5 flex flex-col items-center justify-center gap-2 shadow-sm">
                                                        <div className="p-2 rounded-full bg-white/5 text-accent"><Flag size={24} /></div>
                                                        <div className="text-sm font-bold text-text-muted uppercase tracking-wider">Flagged</div>
                                                        <div className="text-xl font-black">{state.flaggedQuestions.size}</div>
                                                    </div>
                                                    <div className="bg-surface/60 backdrop-blur p-4 rounded-2xl border border-white/5 flex flex-col items-center justify-center gap-2 shadow-sm">
                                                        <div className="p-2 rounded-full bg-white/5 text-purple-500"><Trophy size={24} /></div>
                                                        <div className="text-sm font-bold text-text-muted uppercase tracking-wider">Rank</div>
                                                        <div className="text-xl font-black">{scoreData.correct >= scoreData.total * 0.9 ? "Expert" : scoreData.correct >= scoreData.total * 0.7 ? "Advanced" : scoreData.correct >= scoreData.total * 0.5 ? "Intermediate" : "Beginner"}</div>
                                                    </div>
                                                </div>
                                                <div className="flex justify-center gap-4">
                                                    <Button variant="outline" onClick={exitReview} className="px-8">
                                                        Return to Home
                                                    </Button>
                                                                                                            <Button onClick={() => {
                                                            setState(prev => ({
                                                                ...prev,
                                                                status: 'review',
                                                                currentQuestionIndex: 0
                                                            }));
                                                        }} className="px-8">
                                                            Review Answers
                                                        </Button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    {/* All Modals */}
                    
                    {/* Question Map Modal */}
                    <Modal 
                        isOpen={isMapOpen} 
                        onClose={() => setIsMapOpen(false)} 
                        title="Question Map" 
                        size="xl"
                    >
                        <div className="space-y-6">
                            <div className="grid grid-cols-4 gap-2">
                                <div className="text-center p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                                    <div className="text-lg font-bold text-green-500">{scoreData.correct}</div>
                                    <div className="text-xs text-green-500">Correct</div>
                                </div>
                                <div className="text-center p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                                    <div className="text-lg font-bold text-red-500">{scoreData.total - scoreData.correct - (state.questions.length - Object.keys(state.userAnswers).length)}</div>
                                    <div className="text-xs text-red-500">Incorrect</div>
                                </div>
                                <div className="text-center p-3 bg-secondary/10 border border-secondary/20 rounded-lg">
                                    <div className="text-lg font-bold text-secondary">{Object.keys(state.userAnswers).length}</div>
                                    <div className="text-xs text-secondary">Answered</div>
                                </div>
                                <div className="text-center p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                                    <div className="text-lg font-bold text-yellow-500">{state.flaggedQuestions.size}</div>
                                    <div className="text-xs text-yellow-500">Flagged</div>
                                </div>
                            </div>
                            
                            <QuestionMap
                                totalQuestions={state.questions.length}
                                currentIndex={state.currentQuestionIndex}
                                answers={state.userAnswers}
                                flagged={state.flaggedQuestions}
                                onNavigate={(idx) => {
                                    setState(p => ({ ...p, currentQuestionIndex: idx }));
                                    setIsMapOpen(false);
                                    sfx.click();
                                }}
                                isReviewMode={isReview}
                                correctAnswers={scoreData.correctMap}
                                showInstantFeedback={settings.instantFeedback}
                            />
                            
                            <div className="flex gap-3">
                                <Button variant="outline" onClick={() => setIsMapOpen(false)} className="flex-1">
                                    Close
                                </Button>
                                {(isRunning || isReview) && (
                                    <Button 
                                        variant="primary" 
                                        onClick={() => {
                                            if (isLastQuestion) {
                                                if (isReview) exitReview();
                                                else finishExam();
                                            } else {
                                                setState(p => ({ ...p, currentQuestionIndex: p.currentQuestionIndex + 1 }));
                                            }
                                            setIsMapOpen(false);
                                        }}
                                        className="flex-1"
                                    >
                                        {isLastQuestion ? (isReview ? "Exit Review" : "Finish Exam") : "Next Question"}
                                    </Button>
                                )}
                            </div>
                        </div>
                    </Modal>

                    {/* Paste Questions Modal */}
                    <Modal 
                        isOpen={isPasteModalOpen} 
                        onClose={() => setPasteModalOpen(false)} 
                        title="Paste Questions (CSV Format)" 
                        size="lg"
                    >
                        <div className="space-y-4">
                            <div className="bg-black/20 p-4 rounded-lg border border-dashed border-primary/30">
                                <p className="text-sm text-text-muted mb-2">
                                    <strong>Format:</strong> ID;Question;Options(separated by |);Answer;Image;Explanation;Category;Difficulty
                                </p>
                                <p className="text-xs text-text-muted">
                                    <strong>Example:</strong> 1;What is 2+2?;A) 2|B) 3|C) 4|D) 5;C) 4;;The sum of 2 and 2 is 4.;Math;Easy
                                </p>
                                <p className="text-xs text-text-muted mt-2">
                                    For essay questions, write "ESSAY" in options column.
                                </p>
                            </div>
                            
                            <textarea
                                value={pasteContent}
                                onChange={(e) => setPasteContent(e.target.value)}
                                placeholder="Paste your CSV content here..."
                                className="w-full h-64 p-4 bg-black/20 rounded-xl border border-white/10 font-mono text-sm resize-none"
                                spellCheck={false}
                            />
                            
                            <div className="flex gap-3">
                                <Button 
                                    variant="outline" 
                                    onClick={() => {
                                        setPasteContent(SAMPLE_CSV);
                                        sfx.click();
                                    }}
                                    className="flex-1"
                                >
                                    Load Sample
                                </Button>
                                <Button 
                                    variant="ai"
                                    onClick={copyAITemplate}
                                    className="flex-1"
                                >
                                    <Sparkles size={16} className="mr-2" />
                                    Copy AI Template
                                </Button>
                            </div>
                            
                            <div className="flex gap-3 pt-4">
                                <Button 
                                    variant="outline" 
                                    onClick={() => setPasteModalOpen(false)} 
                                    className="flex-1"
                                >
                                    Cancel
                                </Button>
                                <Button 
                                    onClick={() => {
                                        if (pasteContent.trim()) {
                                            const questions = parseCSV(pasteContent);
                                            if (questions.length > 0) {
                                                loadQuestions(questions);
                                            } else {
                                                alert("No valid questions found in the pasted content. Please check the format.");
                                                sfx.error();
                                            }
                                        }
                                    }} 
                                    className="flex-1"
                                    disabled={!pasteContent.trim()}
                                >
                                    Load Questions ({parseCSV(pasteContent).length})
                                </Button>
                            </div>
                        </div>
                    </Modal>

                    {/* Question Creator Modal */}
                    <Modal 
                        isOpen={isCreatorOpen} 
                        onClose={() => setCreatorOpen(false)} 
                        title={draftQuestions.length > 0 ? `Create Questions (${draftQuestions.length} drafted)` : "Create Question"} 
                        size="lg"
                        footer={
                            <div className="flex gap-3">
                                <Button 
                                    variant="outline" 
                                    onClick={() => {
                                        if (creatorForm.text.trim() && creatorForm.correctAnswer.trim()) {
                                            const newQuestion = {
                                                id: `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                                text: creatorForm.text,
                                                options: creatorForm.type === 'mcq' ? creatorForm.options.filter(o => o.trim()) : [],
                                                correctAnswer: creatorForm.correctAnswer,
                                                imageUrl: creatorForm.imageUrl || undefined,
                                                explanation: creatorForm.explanation || '',
                                                isEssay: creatorForm.type === 'essay',
                                                category: creatorForm.category || 'Custom',
                                                difficulty: creatorForm.difficulty
                                            };
                                            setDraftQuestions([...draftQuestions, newQuestion]);
                                            setCreatorForm({
                                                text: '',
                                                type: 'mcq',
                                                options: ['', '', '', ''],
                                                correctAnswer: '',
                                                imageUrl: '',
                                                category: '',
                                                difficulty: 'Medium',
                                                explanation: ''
                                            });
                                            sfx.success();
                                            showNotification('Question Drafted', 'Question added to draft list');
                                        }
                                    }}
                                    disabled={!creatorForm.text.trim() || !creatorForm.correctAnswer.trim()}
                                >
                                    Add to Draft
                                </Button>
                                <Button 
                                    variant="secondary"
                                    onClick={() => {
                                        if (draftQuestions.length > 0) {
                                            loadQuestions(draftQuestions);
                                            setDraftQuestions([]);
                                            setCreatorOpen(false);
                                        }
                                    }}
                                    disabled={draftQuestions.length === 0}
                                >
                                    Use {draftQuestions.length} Drafted
                                </Button>
                                <Button 
                                    onClick={() => {
                                        const questionsToLoad = draftQuestions.length > 0 ? draftQuestions : [{
                                            id: `custom_${Date.now()}`,
                                            text: creatorForm.text,
                                            options: creatorForm.type === 'mcq' ? creatorForm.options.filter(o => o.trim()) : [],
                                            correctAnswer: creatorForm.correctAnswer,
                                            imageUrl: creatorForm.imageUrl || undefined,
                                            explanation: creatorForm.explanation || '',
                                            isEssay: creatorForm.type === 'essay',
                                            category: creatorForm.category || 'Custom',
                                            difficulty: creatorForm.difficulty
                                        }].filter(q => q.text.trim() && q.correctAnswer.trim());
                                        
                                        if (questionsToLoad.length > 0) {
                                            loadQuestions(questionsToLoad);
                                            setDraftQuestions([]);
                                            setCreatorOpen(false);
                                        }
                                    }}
                                    disabled={draftQuestions.length === 0 && (!creatorForm.text.trim() || !creatorForm.correctAnswer.trim())}
                                >
                                    {draftQuestions.length > 0 ? 'Use All & Close' : 'Create & Close'}
                                </Button>
                            </div>
                        }
                    >
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-text-muted">Question Type</label>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setCreatorForm(f => ({ ...f, type: 'mcq' }))}
                                            className={cn(
                                                "flex-1 p-3 rounded-lg border text-center",
                                                creatorForm.type === 'mcq' 
                                                    ? "border-primary bg-primary/10 text-primary" 
                                                    : "border-white/10 hover:border-primary/50"
                                            )}
                                        >
                                            Multiple Choice
                                        </button>
                                        <button
                                            onClick={() => setCreatorForm(f => ({ ...f, type: 'essay' }))}
                                            className={cn(
                                                "flex-1 p-3 rounded-lg border text-center",
                                                creatorForm.type === 'essay' 
                                                    ? "border-purple-500 bg-purple-500/10 text-purple-500" 
                                                    : "border-white/10 hover:border-purple-500/50"
                                            )}
                                        >
                                            Essay
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-text-muted">Difficulty</label>
                                    <div className="flex gap-2">
                                        {['Easy', 'Medium', 'Hard'].map(diff => (
                                            <button
                                                key={diff}
                                                onClick={() => setCreatorForm(f => ({ ...f, difficulty: diff }))}
                                                className={cn(
                                                    "flex-1 p-2 rounded-lg border text-sm",
                                                    creatorForm.difficulty === diff
                                                        ? diff === 'Easy' ? "border-green-500 bg-green-500/10 text-green-500" :
                                                          diff === 'Medium' ? "border-yellow-500 bg-yellow-500/10 text-yellow-500" :
                                                          "border-red-500 bg-red-500/10 text-red-500"
                                                        : "border-white/10 hover:border-primary/50"
                                                )}
                                            >
                                                {diff}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-text-muted">Question Text</label>
                                <textarea
                                    value={creatorForm.text}
                                    onChange={(e) => setCreatorForm(f => ({ ...f, text: e.target.value }))}
                                    placeholder="Enter your question here..."
                                    className="w-full p-3 bg-black/20 rounded-lg border border-white/10 min-h-[100px] resize-y"
                                />
                            </div>
                            
                            {creatorForm.type === 'mcq' ? (
                                <div className="space-y-3">
                                    <label className="text-sm font-bold text-text-muted">Options</label>
                                    {creatorForm.options.map((option, idx) => (
                                        <div key={idx} className="flex gap-2">
                                            <input
                                                type="text"
                                                value={option}
                                                onChange={(e) => {
                                                    const newOptions = [...creatorForm.options];
                                                    newOptions[idx] = e.target.value;
                                                    setCreatorForm(f => ({ ...f, options: newOptions }));
                                                }}
                                                placeholder={`Option ${idx + 1}`}
                                                className="flex-1 p-2 bg-black/20 rounded-lg border border-white/10"
                                            />
                                            {creatorForm.options.length > 2 && (
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    onClick={() => {
                                                        const newOptions = creatorForm.options.filter((_, i) => i !== idx);
                                                        setCreatorForm(f => ({ ...f, options: newOptions.length ? newOptions : ['', ''] }));
                                                    }}
                                                >
                                                    <Trash2 size={16} />
                                                </Button>
                                            )}
                                        </div>
                                    ))}
                                    {creatorForm.options.length < 6 && (
                                        <Button
                                            variant="outline"
                                            size="sm"
                                            onClick={() => setCreatorForm(f => ({ ...f, options: [...f.options, ''] }))}
                                        >
                                            <Plus size={16} className="mr-2" />
                                            Add Option
                                        </Button>
                                    )}
                                </div>
                            ) : (
                                <div className="p-3 bg-purple-500/10 border border-purple-500/20 rounded-lg">
                                    <p className="text-sm text-purple-500 font-medium">Essay Question Note:</p>
                                    <p className="text-xs text-purple-400">For essay questions, provide a model answer in the "Correct Answer" field below.</p>
                                </div>
                            )}
                            
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-text-muted">
                                    {creatorForm.type === 'essay' ? 'Model Answer' : 'Correct Answer'}
                                </label>
                                {creatorForm.type === 'mcq' ? (
                                    <select
                                        value={creatorForm.correctAnswer}
                                        onChange={(e) => setCreatorForm(f => ({ ...f, correctAnswer: e.target.value }))}
                                        className="w-full p-3 bg-black/20 rounded-lg border border-white/10"
                                    >
                                        <option value="">Select correct option</option>
                                        {creatorForm.options.filter(o => o.trim()).map((option, idx) => (
                                            <option key={idx} value={option}>{option}</option>
                                        ))}
                                    </select>
                                ) : (
                                    <textarea
                                        value={creatorForm.correctAnswer}
                                        onChange={(e) => setCreatorForm(f => ({ ...f, correctAnswer: e.target.value }))}
                                        placeholder="Enter the model answer for this essay question..."
                                        className="w-full p-3 bg-black/20 rounded-lg border border-white/10 min-h-[120px] resize-y"
                                    />
                                )}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-text-muted">Category</label>
                                    <input
                                        type="text"
                                        value={creatorForm.category}
                                        onChange={(e) => setCreatorForm(f => ({ ...f, category: e.target.value }))}
                                        placeholder="e.g., Math, Science, History"
                                        className="w-full p-2 bg-black/20 rounded-lg border border-white/10"
                                    />
                                </div>
                                
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-text-muted">Image URL (Optional)</label>
                                    <input
                                        type="text"
                                        value={creatorForm.imageUrl}
                                        onChange={(e) => setCreatorForm(f => ({ ...f, imageUrl: e.target.value }))}
                                        placeholder="https://example.com/image.jpg"
                                        className="w-full p-2 bg-black/20 rounded-lg border border-white/10"
                                    />
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-text-muted">Explanation (Optional)</label>
                                <textarea
                                    value={creatorForm.explanation}
                                    onChange={(e) => setCreatorForm(f => ({ ...f, explanation: e.target.value }))}
                                    placeholder="Explain why this answer is correct..."
                                    className="w-full p-3 bg-black/20 rounded-lg border border-white/10 min-h-[80px] resize-y"
                                />
                            </div>
                            
                            {draftQuestions.length > 0 && (
                                <div className="border-t border-white/10 pt-4 mt-4">
                                    <h4 className="font-bold text-text-muted mb-2">Drafted Questions ({draftQuestions.length})</h4>
                                    <div className="space-y-2 max-h-40 overflow-y-auto">
                                        {draftQuestions.map((q, idx) => (
                                            <div key={q.id} className="p-3 bg-black/20 rounded-lg border border-white/10 flex items-center justify-between">
                                                <div>
                                                    <p className="text-sm font-medium line-clamp-1">{q.text}</p>
                                                    <p className="text-xs text-text-muted">{q.category} • {q.difficulty}</p>
                                                </div>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    onClick={() => {
                                                        const newDrafts = draftQuestions.filter((_, i) => i !== idx);
                                                        setDraftQuestions(newDrafts);
                                                    }}
                                                >
                                                    <Trash2 size={14} />
                                                </Button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </Modal>

                    {/* AI Generator Modal */}
                    <Modal 
                        isOpen={isAIModalOpen} 
                        onClose={() => setAIModalOpen(false)} 
                        title="AI Question Generator" 
                        size="lg"
                    >
                        <AIGeneratorModal 
                            onClose={() => setAIModalOpen(false)} 
                            onQuestionsGenerated={loadQuestions}
                        />
                    </Modal>

                    {/* Analytics Dashboard Modal */}
                    <Modal 
                        isOpen={isAnalyticsOpen} 
                        onClose={() => setAnalyticsOpen(false)} 
                        title="Performance Analytics" 
                        size="full"
                    >
                        {state.questions.length > 0 ? (
                            <AnalyticsDashboard 
                                questions={state.questions}
                                answers={state.userAnswers}
                                onClose={() => setAnalyticsOpen(false)}
                            />
                        ) : (
                            <div className="text-center py-12">
                                <BarChart size={48} className="mx-auto mb-4 text-text-muted opacity-50" />
                                <p className="text-text-muted">No exam data available</p>
                                <p className="text-sm text-text-muted mt-1">Complete an exam to see analytics</p>
                            </div>
                        )}
                    </Modal>

                    {/* Theme Builder Modal */}
                    <Modal 
                        isOpen={isThemeBuilderOpen} 
                        onClose={() => setIsThemeBuilderOpen(false)} 
                        title="Custom Theme Builder" 
                        size="lg"
                        footer={
                            <div className="flex gap-3">
                                <Button 
                                    variant="outline" 
                                    onClick={() => {
                                        const defaultTheme = {
                                            primary: { r: 99, g: 102, b: 241 },
                                            secondary: { r: 16, g: 185, b: 129 },
                                            accent: { r: 236, g: 72, b: 153 },
                                            name: 'Default Theme'
                                        };
                                        setCustomTheme(defaultTheme);
                                        localStorage.removeItem('customTheme');
                                        sfx.success();
                                    }}
                                >
                                    Reset to Default
                                </Button>
                                <Button 
                                    onClick={() => {
                                        setSettings(s => ({ ...s, theme: 'custom' }));
                                        setIsThemeBuilderOpen(false);
                                    }}
                                    className="flex-1"
                                >
                                    Apply Theme
                                </Button>
                                <Button 
                                    variant="success"
                                    onClick={() => {
                                        localStorage.setItem('customTheme', JSON.stringify(customTheme));
                                        setSettings(s => ({ ...s, theme: 'custom' }));
                                        setIsThemeBuilderOpen(false);
                                        sfx.success();
                                        showNotification('Theme Saved', 'Custom theme saved and applied');
                                    }}
                                >
                                    Save & Apply
                                </Button>
                            </div>
                        }
                    >
                        <div className="space-y-6">
                            <div className="p-4 bg-gradient-to-br from-primary/10 via-secondary/10 to-accent/10 rounded-xl border border-white/10">
                                <h4 className="font-bold text-text-muted mb-3">Preview</h4>
                                <div className="space-y-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-6 h-6 rounded-lg" style={{ backgroundColor: `rgb(${customTheme.primary.r}, ${customTheme.primary.g}, ${customTheme.primary.b})` }} />
                                        <span className="text-sm">Primary Color</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-6 h-6 rounded-lg" style={{ backgroundColor: `rgb(${customTheme.secondary.r}, ${customTheme.secondary.g}, ${customTheme.secondary.b})` }} />
                                        <span className="text-sm">Secondary Color</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-6 h-6 rounded-lg" style={{ backgroundColor: `rgb(${customTheme.accent.r}, ${customTheme.accent.g}, ${customTheme.accent.b})` }} />
                                        <span className="text-sm">Accent Color</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-text-muted">Theme Name</label>
                                <input
                                    type="text"
                                    value={customTheme.name}
                                    onChange={(e) => setCustomTheme(t => ({ ...t, name: e.target.value }))}
                                    className="w-full p-3 bg-black/20 rounded-lg border border-white/10"
                                    placeholder="My Custom Theme"
                                />
                            </div>
                            
                            <ColorPicker 
                                color={customTheme.primary}
                                onChange={(color) => setCustomTheme(t => ({ ...t, primary: color }))}
                                label="Primary Color"
                            />
                            
                            <ColorPicker 
                                color={customTheme.secondary}
                                onChange={(color) => setCustomTheme(t => ({ ...t, secondary: color }))}
                                label="Secondary Color"
                            />
                            
                            <ColorPicker 
                                color={customTheme.accent}
                                onChange={(color) => setCustomTheme(t => ({ ...t, accent: color }))}
                                label="Accent Color"
                            />
                            
                            <div className="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                <p className="text-sm text-blue-500 font-medium">Tip:</p>
                                <p className="text-xs text-blue-400 mt-1">
                                    The theme will be applied immediately after saving. You can switch between themes in the exam setup screen.
                                </p>
                            </div>
                        </div>
                    </Modal>

                    {/* Exam History Modal */}
                    <Modal 
                        isOpen={isExamHistoryOpen} 
                        onClose={() => setIsExamHistoryOpen(false)} 
                        title="Exam History" 
                        size="full"
                    >
                        <ExamHistoryDashboard 
                            onClose={() => setIsExamHistoryOpen(false)}
                            onRestoreExam={restoreExamFromHistory}
                        />
                    </Modal>

                    {/* Question Bank Modal */}
                    <Modal 
                        isOpen={isQuestionBankOpen} 
                        onClose={() => setIsQuestionBankOpen(false)} 
                        title="Question Bank" 
                        size="full"
                    >
                        <QuestionBankDashboard 
                            onClose={() => setIsQuestionBankOpen(false)}
                            onLoadQuestions={loadQuestions}
                        />
                    </Modal>

                    {/* Gamification Dashboard Modal */}
                    <Modal 
                        isOpen={isGamificationOpen} 
                        onClose={() => setIsGamificationOpen(false)} 
                        title="Gamification Dashboard" 
                        size="full"
                    >
                        <GamificationDashboard 
                            onClose={() => setIsGamificationOpen(false)}
                        />
                    </Modal>
                </div>
            );
        };

        // === Initialize React App ===
        const rootElement = document.getElementById('root');
        if (!rootElement) {
            console.error('Root element not found');
        } else {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        }
    </script>
</body>
</html>